{% extends "crm/base.html" %}
{% load humanize %}
{% block content %}

<style>
  :root{
    --bg:#020617;
    --bg2:#030712;
    --line:#334155;
    --text:#f9fafb;
    --muted:#9ca3af;
    --good:#4ade80;
    --warn:#fbbf24;
    --bad:#fb7185;
  }

  .wrap{
    max-width:1100px;
    margin:0 auto;
    color:var(--text);
  }

  .head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:14px;
  }

  .title{
    margin:0;
    font-weight:900;
    letter-spacing:0.2px;
  }

  .sub{
    margin-top:4px;
    font-size:12px;
    font-weight:800;
    color:var(--muted);
    line-height:1.4;
  }

  .btnbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:8px 14px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid rgba(255,255,255,0.14);
    background:linear-gradient(145deg,#0f172a,var(--bg));
    color:var(--text);
    text-decoration:none;
    box-shadow:0 3px 0 #020617;
    white-space:nowrap;
  }
  .pill:hover{ filter:brightness(1.05); text-decoration:none; }

  .pill.gold{
    background:linear-gradient(145deg,#f5d580,#d4b35f);
    color:#111827;
    border-color:rgba(255,215,128,0.55);
  }

  .cardx{
    background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:0 16px 36px rgba(0,0,0,0.55);
    overflow:hidden;
  }

  .pad{ padding:14px; }

  .grid{
    display:grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap:12px;
    align-items:start;
  }

  @media (max-width: 900px){
    .grid{ grid-template-columns:1fr; }
  }

  .kv{
    display:grid;
    grid-template-columns: 160px 1fr;
    gap:10px 14px;
    font-size:13px;
  }
  @media (max-width: 600px){
    .kv{ grid-template-columns:1fr; }
  }

  .k{
    color:var(--muted);
    font-weight:900;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.4px;
  }

  .v{
    color:var(--text);
    font-weight:800;
    word-break:break-word;
  }

  .status{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.03);
  }
  .s-draft{ color:#e5e7eb; }
  .s-sent{ color:var(--warn); }
  .s-partial{ color:var(--warn); }
  .s-paid{ color:var(--good); }
  .s-cancelled{ color:var(--bad); }

  .totals{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .totals td{
    padding:8px 0;
    border-bottom:1px solid rgba(148,163,184,0.18);
    font-weight:800;
  }
  .totals td:first-child{ color:var(--muted); }
  .totals td:last-child{ text-align:right; }

  .bigTotal{
    font-size:18px;
    font-weight:900;
  }

  .note{
    margin-top:10px;
    font-size:12px;
    color:var(--muted);
    font-weight:800;
    line-height:1.45;
    white-space:pre-wrap;
  }

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }

  .printHeader{
    display:none;
    margin-bottom:12px;
  }
  .printHeader .line{
    margin-top:6px;
    font-size:12px;
    font-weight:800;
    color:#111827;
  }

  @media print{
    .btnbar, .pill, .noPrint{ display:none !important; }
    .cardx{ box-shadow:none; }
    body{ background:#fff !important; }
    .wrap{ color:#111827 !important; }
    .cardx{ border:1px solid #d1d5db !important; background:#fff !important; }
    .k{ color:#374151 !important; }
    .v{ color:#111827 !important; }
    .sub{ color:#374151 !important; }
    .status{ border-color:#d1d5db !important; background:#fff !important; }
    .printHeader{ display:block; }
  }
</style>

<div class="container-fluid">
  <div class="wrap">

    <div class="printHeader">
      <div style="font-size:18px; font-weight:900;">Invoice</div>
      <div class="line">Invoice number: <span class="mono">{{ invoice.invoice_number|default:"" }}</span></div>
      <div class="line">Issue date: {% if invoice.issue_date %}{{ invoice.issue_date|date:"Y-m-d" }}{% else %}Not set{% endif %}</div>
      {% if invoice.customer %}
        <div class="line">Customer: {{ invoice.customer }}</div>
      {% endif %}
    </div>

    <div class="head">
      <div>
        <h2 class="title">Invoice {{ invoice.invoice_number|default:"" }}</h2>
        <div class="sub">
          Created {% if invoice.issue_date %}{{ invoice.issue_date|date:"Y-m-d" }}{% else %}Not set{% endif %}
          {% if invoice.due_date %} | Due {{ invoice.due_date|date:"Y-m-d" }}{% endif %}
          {% if invoice.currency %} | Currency {{ invoice.currency }}{% endif %}
        </div>
      </div>

      <div class="btnbar noPrint">
        <a class="pill" href="{% url 'invoice_list' %}">Back to invoices</a>
        <a class="pill gold" href="{% url 'invoice_edit' invoice.pk %}">Edit</a>
        <a class="pill" href="#" onclick="window.print();return false;">Print</a>
      </div>
    </div>

    <div class="grid">

      <div class="cardx">
        <div class="pad">

          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
            <div style="font-weight:900;">Invoice details</div>

            {% with st=invoice.status|default:"draft" %}
              {% if st == "draft" %}
                <span class="status s-draft">Draft</span>
              {% elif st == "sent" %}
                <span class="status s-sent">Sent</span>
              {% elif st == "partial" %}
                <span class="status s-partial">Partly paid</span>
              {% elif st == "paid" %}
                <span class="status s-paid">Paid</span>
              {% elif st == "cancelled" %}
                <span class="status s-cancelled">Cancelled</span>
              {% else %}
                <span class="status s-draft">{{ st|capfirst }}</span>
              {% endif %}
            {% endwith %}
          </div>

          <div class="kv">
            <div class="k">Customer</div>
            <div class="v">
              {% if invoice.customer %}{{ invoice.customer }}{% else %}Not set{% endif %}
            </div>

            <div class="k">Order</div>
            <div class="v">
              {% if invoice.order %}{{ invoice.order }}{% else %}Not linked{% endif %}
            </div>

            <div class="k">Issue date</div>
            <div class="v">
              {% if invoice.issue_date %}{{ invoice.issue_date|date:"Y-m-d" }}{% else %}Not set{% endif %}
            </div>

            <div class="k">Due date</div>
            <div class="v">
              {% if invoice.due_date %}{{ invoice.due_date|date:"Y-m-d" }}{% else %}Not set{% endif %}
            </div>

            <div class="k">Paid amount</div>
            <div class="v">
              {% if invoice.currency %}{{ invoice.currency }} {% endif %}
              <span id="paidAmountText">
                {{ invoice.paid_amount|default_if_none:0|floatformat:2|intcomma }}
              </span>
            </div>

            <div class="k">Balance</div>
            <div class="v">
              {% if invoice.currency %}{{ invoice.currency }} {% endif %}
              <span id="balanceText">
                {% if invoice.balance %}
                  {{ invoice.balance|default_if_none:0|floatformat:2|intcomma }}
                {% else %}
                  0.00
                {% endif %}
              </span>
            </div>
          </div>

          {% if invoice.notes %}
            <div class="note">
              <div style="margin-bottom:6px; color:var(--text); font-weight:900;">Notes</div>
              {{ invoice.notes }}
            </div>
          {% endif %}

        </div>
      </div>

      <div class="cardx">
        <div class="pad">

          <div style="font-weight:900; margin-bottom:10px;">Totals</div>

          <table class="totals">
            <tr>
              <td>Subtotal</td>
              <td>{% if invoice.currency %}{{ invoice.currency }} {% endif %}{{ invoice.subtotal|default_if_none:0|floatformat:2|intcomma }}</td>
            </tr>
            <tr>
              <td>Shipping</td>
              <td>{% if invoice.currency %}{{ invoice.currency }} {% endif %}{{ invoice.shipping_amount|default_if_none:0|floatformat:2|intcomma }}</td>
            </tr>
            <tr>
              <td>Discount</td>
              <td>{% if invoice.currency %}{{ invoice.currency }} {% endif %}{{ invoice.discount_amount|default_if_none:0|floatformat:2|intcomma }}</td>
            </tr>
            <tr>
              <td>Tax</td>
              <td>{% if invoice.currency %}{{ invoice.currency }} {% endif %}{{ invoice.tax_amount|default_if_none:0|floatformat:2|intcomma }}</td>
            </tr>
            <tr>
              <td class="bigTotal">Total</td>
              <td class="bigTotal">
                {% if invoice.currency %}{{ invoice.currency }} {% endif %}
                <span id="totalAmountText">{{ invoice.total_amount|default_if_none:0|floatformat:2|intcomma }}</span>
              </td>
            </tr>
          </table>

          <div class="sub" style="margin-top:10px;">
            Tip: Total should equal subtotal + shipping + tax minus discount.
          </div>

        </div>
      </div>

    </div>

  </div>
</div>

<script>
  (function(){
    function n(v){
      var x = parseFloat((v || "").toString().replace(/,/g,""));
      return isNaN(x) ? 0 : x;
    }
    function fmt2(v){
      return (Math.round(v * 100) / 100).toFixed(2);
    }

    // If your model does not have invoice.balance, we calculate it safely here.
    var totalText = document.getElementById("totalAmountText");
    var paidText = document.getElementById("paidAmountText");
    var balText = document.getElementById("balanceText");

    if(!totalText || !paidText || !balText) return;

    var total = n(totalText.textContent);
    var paid = n(paidText.textContent);
    var bal = total - paid;
    if(bal < 0) bal = 0;

    // Only overwrite when balance looks like default "0.00" or missing
    var currentBal = n(balText.textContent);
    if(currentBal === 0){
      balText.textContent = fmt2(bal);
    }
  })();
</script>

{% endblock %}