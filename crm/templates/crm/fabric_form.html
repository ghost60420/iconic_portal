{% extends "crm/base.html" %}
{% load static %}
{% block content %}

<style>
  :root{
    --bg:#060606;
    --panel:#0b0d10;
    --panel2:#0f172a;
    --border:#2a2f38;
    --text:#f8f9fa;
    --muted:#a8b0bd;
    --gold1:#ffe39b;
    --gold2:#e4c067;
  }

  .fabric-page{
    max-width: 1100px;
    margin: 18px auto 34px auto;
    padding: 0 10px;
    color: var(--text);
  }

  .header-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 12px;
    flex-wrap:wrap;
    margin-bottom: 12px;
  }

  .title{
    font-size: 22px;
    font-weight: 900;
    color: var(--gold1);
    letter-spacing: 0.2px;
    line-height: 1.2;
  }

  .sub{
    margin-top: 6px;
    font-size: 12px;
    color: rgba(248,249,250,0.65);
    font-weight: 800;
    max-width: 720px;
  }

  .btn-row{
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    align-items:center;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 900;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color: #f3f4f6;
    cursor:pointer;
    user-select:none;
    line-height: 1;
    transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
    text-decoration:none;
    white-space:nowrap;
  }

  .btn:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,0.06);
    border-color: rgba(245, 213, 128, 0.32);
    color: var(--gold1);
  }

  .btn:active{ transform: translateY(0px); }

  .btn-gold{
    border-color: rgba(255, 227, 155, 0.30);
    background: rgba(245, 213, 128, 0.16);
    color: var(--gold1);
    box-shadow: 0 10px 22px rgba(255, 209, 120, 0.10);
  }

  .btn-gold:hover{
    background: rgba(245, 213, 128, 0.22);
    color: #fff;
  }

  .btn:disabled{
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
  }

  .grid-top{
    display:grid;
    grid-template-columns: 1.6fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }

  @media (max-width: 980px){
    .grid-top{ grid-template-columns: 1fr; }
  }

  .card{
    background: linear-gradient(180deg, rgba(15,23,42,0.55), rgba(2,6,23,0.70));
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.45);
  }

  .card-title{
    font-size: 14px;
    font-weight: 900;
    color: var(--gold1);
    margin-bottom: 8px;
  }

  .card-note{
    font-size: 12px;
    color: rgba(248,249,250,0.65);
    font-weight: 800;
    line-height: 1.4;
  }

  .form-card{
    margin-top: 12px;
  }

  .section-title{
    margin: 14px 0 10px 0;
    font-size: 13px;
    font-weight: 900;
    color: rgba(248,249,250,0.85);
    text-transform: uppercase;
    letter-spacing: 0.25px;
  }

  .section-line{
    height: 1px;
    background: rgba(148,163,184,0.18);
    margin: 10px 0 6px 0;
  }

  .form-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 16px;
  }

  @media (max-width: 780px){
    .form-grid{ grid-template-columns: 1fr; }
  }

  .field{
    display:flex;
    flex-direction:column;
    gap: 6px;
  }

  .label{
    font-size: 11px;
    color: rgba(248,249,250,0.60);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.2px;
  }

  .hint{
    font-size: 12px;
    color: rgba(248,249,250,0.55);
    font-weight: 800;
    line-height: 1.35;
  }

  .input,
  .select,
  textarea,
  input,
  select{
    background: rgba(255,255,255,0.04);
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.12);
    padding: 10px 12px;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 800;
    outline: none;
  }

  textarea{
    min-height: 110px;
    resize: vertical;
  }

  .input:focus,
  .select:focus,
  textarea:focus,
  input:focus,
  select:focus{
    border-color: rgba(245, 213, 128, 0.45);
    box-shadow: 0 0 0 3px rgba(245,213,128,0.14);
  }

  .mini-select{
    padding: 9px 12px;
    border-radius: 14px;
  }

  .img-preview-wrap{
    display:flex;
    gap: 12px;
    align-items:flex-start;
    flex-wrap:wrap;
  }

  .img-preview{
    width: 160px;
    height: 160px;
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(0,0,0,0.25);
    object-fit: cover;
  }

  .ai-fields{
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-top: 10px;
  }

  .ai-grid-2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  @media (max-width: 520px){
    .ai-grid-2{ grid-template-columns: 1fr; }
  }

  .ai-actions{
    margin-top: 10px;
    display:flex;
    gap: 10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .ai-status{
    font-size: 12px;
    color: rgba(248,249,250,0.70);
    font-weight: 800;
  }

  .ai-output{
    margin-top: 10px;
    background: rgba(0,0,0,0.25);
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 10px 12px;
    min-height: 78px;
    font-size: 13px;
    color: rgba(248,249,250,0.90);
    white-space: pre-wrap;
    line-height: 1.5;
  }

  .actions-bar{
    margin-top: 14px;
    display:flex;
    gap: 10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:flex-end;
  }

  .error-box{
    border: 1px solid rgba(248,113,113,0.35);
    background: rgba(248,113,113,0.08);
    border-radius: 16px;
    padding: 12px;
    margin-bottom: 12px;
    color: rgba(254,226,226,0.95);
    font-weight: 800;
  }

  .spinner{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(229,231,235,0.35);
    border-top-color: rgba(245,213,128,0.95);
    display:inline-block;
    animation: spin 700ms linear infinite;
    vertical-align: -2px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="fabric-page">

  <div class="header-row">
    <div>
      <div class="title">{{ mode|title }} fabric</div>
      <div class="sub">
        This page holds your base fabrics. Your team can reuse these for costing and development.
      </div>
    </div>

    <div class="btn-row">
      <a class="btn" href="{% url 'fabrics_list' %}">‚Üê Back to fabrics</a>
      <button class="btn btn-gold" type="submit" form="fabricForm">
        {% if mode == "edit" %}Save changes{% else %}Add fabric{% endif %}
      </button>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="error-box">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  <div class="grid-top">
    <div class="card">
      <div class="card-title">Quick guide</div>
      <div class="card-note">
        Keep names clear. Example Single jersey cotton. Use group and type so the team can filter fast.
        If you add new items in the list, they will be saved for next time.
      </div>
    </div>

    <div class="card">
      <div class="card-title">AI helper for this fabric</div>
      <div class="card-note">
        Type the name, group, and type. AI will suggest GSM, composition, feel, and best use.
      </div>

      <div class="ai-fields">
        <div class="field">
          <div class="label">Fabric name</div>
          <input id="ai-fabric-name" class="input" type="text" placeholder="Example Single jersey cotton">
        </div>

        <div class="ai-grid-2">
          <div class="field">
            <div class="label">Group</div>
            <input id="ai-fabric-group" class="input" type="text" placeholder="Knit or Woven">
          </div>
          <div class="field">
            <div class="label">Type</div>
            <input id="ai-fabric-type" class="input" type="text" placeholder="Jersey, Rib, Fleece">
          </div>
        </div>

        <div class="ai-actions">
          <button type="button" class="btn btn-gold" id="ai-fabric-btn">Ask AI</button>
          <span class="ai-status" id="ai-fabric-status"></span>
        </div>

        <div class="ai-output" id="ai-fabric-output">AI suggestion will appear here.</div>
      </div>
    </div>
  </div>

  <form id="fabricForm" method="post" enctype="multipart/form-data" class="card form-card">
    {% csrf_token %}

    <div class="section-title">Basic information</div>
    <div class="section-line"></div>

    <div class="form-grid">

      <div class="field">
        <div class="label">{{ form.name.label }}</div>
        {{ form.name }}
        <div class="hint">Example Single jersey cotton</div>
      </div>

      <div class="field">
        <div class="label">Fabric group</div>
        <select id="fg-master" class="select mini-select">
          <option value="">Select from list</option>
          {% for g in fabric_groups %}
            <option value="{{ g.name }}">{{ g.name }}</option>
          {% endfor %}
        </select>
        {{ form.fabric_group }}
        <div class="hint">Use the list or type knit, woven, or other. New items are saved.</div>
      </div>

      <div class="field">
        <div class="label">Fabric type</div>
        <select id="ft-master" class="select mini-select">
          <option value="">Select from list</option>
          {% for t in fabric_types %}
            <option value="{{ t.name }}">{{ t.name }}</option>
          {% endfor %}
        </select>
        {{ form.fabric_type }}
        <div class="hint">Example jersey, rib, fleece. New items are saved.</div>
      </div>

      <div class="field">
        <div class="label">Knit structure</div>
        <select id="ks-master" class="select mini-select">
          <option value="">Select from list</option>
          {% for ks in knit_structures %}
            <option value="{{ ks.name }}">{{ ks.name }}</option>
          {% endfor %}
        </select>
        {{ form.knit_structure }}
        <div class="hint">Only for knit bases. Example single jersey, interlock, pique.</div>
      </div>

      <div class="field">
        <div class="label">Weave</div>
        <select id="wv-master" class="select mini-select">
          <option value="">Select from list</option>
          {% for w in weaves %}
            <option value="{{ w.name }}">{{ w.name }}</option>
          {% endfor %}
        </select>
        {{ form.weave }}
        <div class="hint">Only for woven bases. Example twill, poplin, canvas.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.construction.label }}</div>
        {{ form.construction }}
        <div class="hint">Example 40/1 x 40/1, 150 GSM.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.composition.label }}</div>
        {{ form.composition }}
        <div class="hint">Example 95 percent cotton 5 percent spandex.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.gsm.label }}</div>
        {{ form.gsm }}
        <div class="hint">Fabric weight. Example 180.</div>
      </div>

    </div>

    <div class="section-title" style="margin-top:16px;">Feel and performance</div>
    <div class="section-line"></div>

    <div class="form-grid">

      <div class="field">
        <div class="label">{{ form.stretch_type.label }}</div>
        {{ form.stretch_type }}
        <div class="hint">No stretch, two way, or four way.</div>
      </div>

      <div class="field">
        <div class="label">Surface</div>
        <select id="sf-master" class="select mini-select">
          <option value="">Select from list</option>
          {% for s in surfaces %}
            <option value="{{ s.name }}">{{ s.name }}</option>
          {% endfor %}
        </select>
        {{ form.surface }}
        <div class="hint">Smooth, brushed, textured, and more. New items are saved.</div>
      </div>

      <div class="field">
        <div class="label">Handfeel</div>
        <select id="hf-master" class="select mini-select">
          <option value="">Select from list</option>
          {% for h in handfeels %}
            <option value="{{ h.name }}">{{ h.name }}</option>
          {% endfor %}
        </select>
        {{ form.handfeel }}
        <div class="hint">Soft, buttery, crisp, and more. New items are saved.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.drape.label }}</div>
        {{ form.drape }}
        <div class="hint">How the fabric hangs. Example fluid or stiff.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.weight_class.label }}</div>
        {{ form.weight_class }}
        <div class="hint">Light, medium, or heavy.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.warmth.label }}</div>
        {{ form.warmth }}
        <div class="hint">Cool, normal, or warm.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.breathability.label }}</div>
        {{ form.breathability }}
        <div class="hint">Low, medium, or high.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.sheerness.label }}</div>
        {{ form.sheerness }}
        <div class="hint">Opaque, semi sheer, or sheer.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.shrinkage.label }}</div>
        {{ form.shrinkage }}
        <div class="hint">Example three percent after wash.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.durability.label }}</div>
        {{ form.durability }}
        <div class="hint">Low, medium, or high.</div>
      </div>

    </div>

    <div class="section-title" style="margin-top:16px;">Color, price and image</div>
    <div class="section-line"></div>

    <div class="form-grid">

      <div class="field">
        <div class="label">{{ form.color_options.label }}</div>
        {{ form.color_options }}
        <div class="hint">List key colors or say lab dip only.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.price_per_kg.label }}</div>
        {{ form.price_per_kg }}
        <div class="hint">Use if your supplier quotes per kg.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.price_per_meter.label }}</div>
        {{ form.price_per_meter }}
        <div class="hint">Use if your supplier quotes per meter.</div>
      </div>

      <div class="field">
        <div class="label">{{ form.image.label }}</div>
        {{ form.image }}
        <div class="hint">Upload a clear fabric photo or scan.</div>

        <div class="img-preview-wrap" style="margin-top:10px;">
          {% if fabric and fabric.image %}
            <img src="{{ fabric.image.url }}" class="img-preview" alt="{{ fabric.name }}">
          {% else %}
            <div class="hint">No image yet.</div>
          {% endif %}
        </div>
      </div>

    </div>

    <div class="section-title" style="margin-top:16px;">Notes</div>
    <div class="section-line"></div>

    <div class="field">
      {{ form.notes }}
      <div class="hint">Save anything useful for quoting and development.</div>
    </div>

    <div class="actions-bar">
      <button type="submit" class="btn btn-gold">
        {% if mode == "edit" %}Save changes{% else %}Add fabric{% endif %}
      </button>
    </div>
  </form>

  <form id="ai-fabric-csrf-form" style="display:none;">
    {% csrf_token %}
  </form>

</div>

<script>
  (function () {
    function findFieldByName(name) {
      return document.querySelector("[name='" + name + "']");
    }

    function hookSelectToInput(selectId, inputName) {
      const sel = document.getElementById(selectId);
      const inp = findFieldByName(inputName);
      if (!sel || !inp) return;

      sel.addEventListener("change", function () {
        if (sel.value) inp.value = sel.value;
      });
    }

    hookSelectToInput("fg-master", "fabric_group");
    hookSelectToInput("ft-master", "fabric_type");
    hookSelectToInput("ks-master", "knit_structure");
    hookSelectToInput("wv-master", "weave");
    hookSelectToInput("sf-master", "surface");
    hookSelectToInput("hf-master", "handfeel");

    // AI helper
    const btn = document.getElementById("ai-fabric-btn");
    if (!btn) return;

    const nameInput = document.getElementById("ai-fabric-name");
    const groupInput = document.getElementById("ai-fabric-group");
    const typeInput = document.getElementById("ai-fabric-type");
    const outBox = document.getElementById("ai-fabric-output");
    const statusSpan = document.getElementById("ai-fabric-status");

    let busy = false;

    function getCsrf() {
      const tokenField = document.querySelector("#ai-fabric-csrf-form input[name='csrfmiddlewaretoken']");
      return tokenField ? tokenField.value : "";
    }

    function safeText(s) {
      return (s || "").toString();
    }

    function setBusy(on) {
      busy = on;
      btn.disabled = on;
      if (on) statusSpan.innerHTML = "<span class='spinner'></span> Thinking";
      else statusSpan.textContent = "";
    }

    btn.addEventListener("click", function () {
      if (busy) return;

      const name = (nameInput.value || "").trim();
      const group = (groupInput.value || "").trim();
      const ftype = (typeInput.value || "").trim();

      if (!name) {
        outBox.textContent = "Please type a fabric name first.";
        statusSpan.textContent = "";
        return;
      }

      setBusy(true);
      outBox.textContent = "";

      fetch("{% url 'fabric_ai_suggest' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrf()
        },
        body: new URLSearchParams({
          name: name,
          group: group,
          fabric_type: ftype
        }).toString()
      })
      .then(function (res) {
        const isJson = (res.headers.get("content-type") || "").includes("application/json");
        if (!isJson) throw new Error("Non JSON response");
        return res.json();
      })
      .then(function (data) {
        if (data && data.ok) {
          outBox.textContent = safeText(data.suggestion);
          statusSpan.textContent = "Ready";
        } else {
          outBox.textContent = safeText(data && data.error ? data.error : "AI could not answer.");
          statusSpan.textContent = "";
        }
      })
      .catch(function (err) {
        console.error(err);
        outBox.textContent = "Error talking to AI.";
        statusSpan.textContent = "";
      })
      .finally(function () {
        setBusy(false);
      });
    });
  })();
</script>

{% endblock %}