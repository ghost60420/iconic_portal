{% extends "crm/base.html" %}
{% load static %}
{% block content %}

<style>
  .prod-add-page {
    max-width: 880px;
    margin: 24px auto 40px auto;
  }

  .prod-add-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }

  .prod-add-title {
    font-size: 22px;
    font-weight: 700;
    color: #ffffff;
  }

  .prod-add-sub {
    font-size: 13px;
    color: #9ca3af;
  }

  .prod-add-card {
    background: #050816;
    border-radius: 14px;
    border: 1px solid #1f2937;
    padding: 16px 18px;
    box-shadow: 0 0 22px rgba(0,0,0,0.7);
    margin-bottom: 16px;
  }

  .prod-add-card-title {
    font-size: 15px;
    font-weight: 600;
    color: #f9fafb;
    margin-bottom: 10px;
    border-bottom: 1px solid #111827;
    padding-bottom: 6px;
  }

  .prod-add-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 14px 24px;
  }

  .prod-add-field {
    font-size: 13px;
  }

  .prod-add-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .prod-add-help {
    font-size: 11px;
    color: #6b7280;
    margin-top: 2px;
  }

  .prod-add-card input,
  .prod-add-card select,
  .prod-add-card textarea {
    background: #020617;
    border: 1px solid #374151;
    border-radius: 6px;
    color: #e5e7eb;
    font-size: 13px;
    padding: 6px 8px;
    width: 100%;
  }

  .prod-add-card textarea {
    min-height: 70px;
  }

  .prod-add-card input:focus,
  .prod-add-card select:focus,
  .prod-add-card textarea:focus {
    border-color: #facc15;
    outline: none;
    box-shadow: 0 0 0 1px rgba(250,204,21,0.3);
  }

  .prod-add-errors {
    color: #fca5a5;
    font-size: 11px;
    margin-top: 3px;
  }

  .prod-add-top-errors {
    color: #fecaca;
    background: #450a0a;
    border: 1px solid #7f1d1d;
    border-radius: 8px;
    padding: 8px 10px;
    font-size: 12px;
    margin-bottom: 10px;
  }

  .prod-add-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 6px;
  }

  .prod-style-layout {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.1fr);
    gap: 18px;
  }

  @media (max-width: 900px) {
    .prod-style-layout {
      grid-template-columns: minmax(0, 1fr);
    }
  }

  .prod-style-left .prod-add-field + .prod-add-field {
    margin-top: 8px;
  }

  .prod-style-right {
    border-left: 1px solid #1f2937;
    padding-left: 16px;
  }

  @media (max-width: 900px) {
    .prod-style-right {
      border-left: none;
      border-top: 1px solid #1f2937;
      padding-left: 0;
      padding-top: 12px;
      margin-top: 4px;
    }
  }

  .prod-ai-box,
  .prod-lib-box {
    background: #020617;
    border-radius: 10px;
    border: 1px solid #111827;
    padding: 10px 10px 8px 10px;
    margin-bottom: 10px;
  }

  .prod-ai-title,
  .prod-lib-title {
    font-size: 12px;
    font-weight: 600;
    color: #facc15;
    margin-bottom: 4px;
  }

  .prod-ai-text,
  .prod-lib-text {
    font-size: 11px;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .prod-lib-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 4px;
  }

  .prod-lib-tag {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 999px;
    border: 1px solid #374151;
    color: #e5e7eb;
    background: rgba(15,23,42,0.8);
    white-space: nowrap;
  }

  .prod-lib-field {
    margin-top: 8px;
  }

  .prod-lib-label {
    font-size: 11px;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .prod-lib-control {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .prod-lib-control select {
    flex: 1;
    background: #0b1222;
    border: 1px solid #374151;
    color: #e5e7eb;
    border-radius: 8px;
    padding: 6px 8px;
    font-size: 12px;
  }

  .prod-lib-control .btn {
    white-space: nowrap;
  }

  .prod-lib-selected {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }

  .prod-lib-chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid #374151;
    background: rgba(15,23,42,0.85);
    color: #e5e7eb;
  }

  .prod-lib-chip button {
    border: none;
    background: transparent;
    color: #fca5a5;
    font-weight: 800;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .prod-ai-link {
    font-size: 11px;
    margin-top: 4px;
  }

  .size-grid-block {
    margin-top: 6px;
  }

  .size-grid-wrapper {
    margin-top: 4px;
  }

  .size-grid-label-row,
  .size-grid-input-row {
    display: grid;
    grid-template-columns: repeat(9, minmax(0, 1fr));
    gap: 4px;
  }

  .size-grid-label {
    font-size: 11px;
    text-align: center;
    color: #9ca3af;
  }

  .size-grid-input {
    background: #020617;
    border: 1px solid #374151;
    border-radius: 6px;
    color: #e5e7eb;
    font-size: 12px;
    padding: 4px 6px;
    text-align: center;
    width: 100%;
  }

  .size-grid-input:focus {
    border-color: #facc15;
    outline: none;
    box-shadow: 0 0 0 1px rgba(250,204,21,0.3);
  }

  .prod-add-hidden {
    display: none;
  }

  .prod-line-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  .prod-line {
    border: 1px dashed #1f2937;
    border-radius: 12px;
    padding: 12px;
    background: rgba(2, 6, 23, 0.55);
    margin-bottom: 12px;
  }

  .prod-line.active {
    border-color: #facc15;
    box-shadow: 0 0 0 1px rgba(250,204,21,0.2);
  }

  .prod-line-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin-bottom: 8px;
  }

  .prod-line-title {
    font-size: 13px;
    font-weight: 700;
    color: #f9fafb;
  }

  .prod-line-meta {
    font-size: 11px;
    color: #9ca3af;
  }

  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.75);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 80;
  }

  .modal-backdrop.open {
    display: flex;
  }

  .modal-card {
    width: min(760px, 100%);
    background: #0b1020;
    border: 1px solid #1f2937;
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 0 30px rgba(0,0,0,0.6);
  }

  .modal-card .inputx {
    background: #020617;
    border: 1px solid #374151;
    border-radius: 6px;
    color: #e5e7eb;
    font-size: 13px;
    padding: 8px 10px;
    width: 100%;
  }

  .modal-card .inputx:focus {
    border-color: #facc15;
    outline: none;
    box-shadow: 0 0 0 1px rgba(250,204,21,0.3);
  }

  .modal-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
  }

  .modal-title {
    font-size: 16px;
    font-weight: 800;
    color: #f9fafb;
  }

  .modal-sub {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 2px;
  }

  .modal-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }

  @media (max-width: 720px) {
    .modal-grid { grid-template-columns: 1fr; }
  }
</style>

<div class="prod-add-page">

  <div class="prod-add-header">
    <div>
      <div class="prod-add-title">
        {% if is_edit %}
          Edit production order
        {% else %}
          Add production order
        {% endif %}
      </div>
      <div class="prod-add-sub">
        {% if is_edit and order %}
          Code {{ order.order_code }} created {{ order.created_at|date:"Y-m-d" }}
        {% else %}
          Link to opportunity and customer to track cost and profit
        {% endif %}
      </div>
    </div>

    <div>
      {% if is_edit and order %}
        <a href="{% url 'production_detail' order.pk %}" class="btn btn-outline-light btn-sm">
          Back to order
        </a>
      {% else %}
        <a href="{% url 'production_list' %}" class="btn btn-outline-light btn-sm">
          Back to production list
        </a>
      {% endif %}
    </div>
  </div>

  {% if form.errors %}
    <div class="prod-add-top-errors">
      Please fix the fields marked in red.
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="prod-form">
    {% csrf_token %}

    <div class="prod-add-card">
      <div class="prod-add-card-title">Order information</div>

      <div class="prod-add-row">

        <div class="prod-add-field">
          <div class="prod-add-label">Title</div>
          {{ form.title }}
          {% if form.title.errors %}
            <div class="prod-add-errors">{{ form.title.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Customer</div>
          {{ form.customer }}
          {% if form.customer.errors %}
            <div class="prod-add-errors">{{ form.customer.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Lead optional</div>
          {{ form.lead }}
          {% if form.lead.errors %}
            <div class="prod-add-errors">{{ form.lead.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Opportunity optional</div>
          {{ form.opportunity }}
          {% if form.opportunity.errors %}
            <div class="prod-add-errors">{{ form.opportunity.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Product optional</div>
          {{ form.product }}
          {% if form.product.errors %}
            <div class="prod-add-errors">{{ form.product.errors|striptags }}</div>
          {% endif %}
          <div class="prod-add-help">
            Leave empty if this order is mixed
          </div>
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Factory</div>
          {{ form.factory_location }}
          {% if form.factory_location.errors %}
            <div class="prod-add-errors">{{ form.factory_location.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Order type</div>
          {{ form.order_type }}
          {% if form.order_type.errors %}
            <div class="prod-add-errors">{{ form.order_type.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Total pieces</div>
          {{ form.qty_total }}
          {% if form.qty_total.errors %}
            <div class="prod-add-errors">{{ form.qty_total.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Reject pieces</div>
          {{ form.qty_reject }}
          {% if form.qty_reject.errors %}
            <div class="prod-add-errors">{{ form.qty_reject.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Sample date</div>
          {{ form.sample_deadline }}
          {% if form.sample_deadline.errors %}
            <div class="prod-add-errors">{{ form.sample_deadline.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Bulk date</div>
          {{ form.bulk_deadline }}
          {% if form.bulk_deadline.errors %}
            <div class="prod-add-errors">{{ form.bulk_deadline.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Style image</div>
          {{ form.style_image }}
          {% if form.style_image.errors %}
            <div class="prod-add-errors">{{ form.style_image.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Status</div>
          {{ form.status }}
          {% if form.status.errors %}
            <div class="prod-add-errors">{{ form.status.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field" style="grid-column:1 / -1;">
          <div class="prod-add-label">Notes</div>
          {{ form.notes }}
          {% if form.notes.errors %}
            <div class="prod-add-errors">{{ form.notes.errors|striptags }}</div>
          {% endif %}
        </div>

      </div>
    </div>

    <div class="prod-add-card">
      <div class="prod-add-card-title">Style and work order details</div>

      <div class="prod-style-layout">

        <div class="prod-style-left">

          <div class="prod-line-actions">
            <div>
              <div class="prod-add-label">Product lines</div>
              <div class="prod-add-help">
                Keep multiple items in one work order. Add a new line to duplicate sizes and water details.
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-light" id="prod-line-add">Add Line</button>
          </div>

          <input type="hidden" name="line_payload" id="line-payload">

          <div id="prod-line-list">
            {% for line in order_lines %}
              <div class="prod-line" data-line-index="{{ forloop.counter }}">
                <div class="prod-line-head">
                  <div>
                    <div class="prod-line-title">Product line {{ forloop.counter }}</div>
                    <div class="prod-line-meta">Style, color, sizes, and water details</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-danger prod-line-remove">Remove</button>
                </div>

                <div class="prod-add-field">
                  <div class="prod-add-label">Style name</div>
                  <input type="text" data-field="style_name" value="{{ line.style_name|default_if_none:'' }}">
                  <div class="prod-add-help">
                    Main style name or code. You can list more than one if needed.
                  </div>
                </div>

                <div class="prod-add-field">
                  <div class="prod-add-label">Color info</div>
                  <input type="text" data-field="color_info" value="{{ line.color_info|default_if_none:'' }}">
                  <div class="prod-add-help">
                    Example black, cocoa, sand. You can write one line for every color.
                  </div>
                </div>

                <div class="prod-add-field size-grid-block" style="grid-column:1 / -1;">
                  <div class="prod-add-label">Sizes and ratio up to 5XL</div>

                  <div class="size-grid-wrapper">
                    <div class="size-grid-label-row">
                      <div class="size-grid-label">XS</div>
                      <div class="size-grid-label">S</div>
                      <div class="size-grid-label">M</div>
                      <div class="size-grid-label">L</div>
                      <div class="size-grid-label">XL</div>
                      <div class="size-grid-label">2XL</div>
                      <div class="size-grid-label">3XL</div>
                      <div class="size-grid-label">4XL</div>
                      <div class="size-grid-label">5XL</div>
                    </div>
                    <div class="size-grid-input-row">
                      <input type="number" min="0" class="size-grid-input" data-size-field="XS" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="S" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="M" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="L" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="XL" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="2XL" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="3XL" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="4XL" placeholder="0">
                      <input type="number" min="0" class="size-grid-input" data-size-field="5XL" placeholder="0">
                    </div>
                  </div>

                  <div class="prod-add-help">
                    Fill how many pieces for every size. System will store this inside the size ratio note field.
                  </div>

                  <div class="prod-add-hidden">
                    <textarea data-field="size_ratio_note">{{ line.size_ratio_note|default_if_none:'' }}</textarea>
                  </div>
                </div>

                <div class="prod-add-field">
                  <div class="prod-add-label">Accessories and trims</div>
                  <textarea data-field="accessories_note">{{ line.accessories_note|default_if_none:'' }}</textarea>
                  <div class="prod-add-help">
                    List drawcord, zipper type, buttons, labels, patches, tags and other trims.
                  </div>
                </div>

                <div class="prod-add-field">
                  <div class="prod-add-label">Packaging details</div>
                  <textarea data-field="packaging_note">{{ line.packaging_note|default_if_none:'' }}</textarea>
                  <div class="prod-add-help">
                    Polybag, bundle, carton mark, size sticker and any special pack.
                  </div>
                </div>

                <div class="prod-add-field">
                  <div class="prod-add-label">Extra order notes</div>
                  <textarea data-field="extra_order_note">{{ line.extra_order_note|default_if_none:'' }}</textarea>
                  <div class="prod-add-help">
                    Use this for print position, measurement file name, shipping note and anything special.
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

        </div>

        <div class="prod-style-right">

          <div class="prod-ai-box">
            <div class="prod-ai-title">AI helper</div>
            <div class="prod-ai-text">
              AI will read this order and give a short plan for fabric, trims and timeline.
            </div>
            <div class="prod-ai-text">
              First save the order. Then open the detail page to use full AI brain.
            </div>
            {% if is_edit and order %}
              <div class="prod-ai-link">
                <a href="{% url 'production_detail' order.pk %}" class="btn btn-sm btn-warning">
                  Open AI on detail page
                </a>
              </div>
            {% else %}
              <div class="prod-ai-link">
                After you create this order you will see the AI button on the detail page.
              </div>
            {% endif %}
          </div>

          <div class="prod-lib-box">
            <div class="prod-lib-title">Library pickers</div>
            <div class="prod-lib-text">
              Pick items from the library and add them to the active line in the order sheet fields.
            </div>

            <div class="prod-lib-field">
              <div class="prod-lib-label">Product defaults</div>
              <div class="prod-lib-control">
                <select id="lib-product-picker">
                  <option value="">Select product</option>
                  {% for p in library_products %}
                    <option value="{{ p.pk }}"
                            data-name="{{ p.name }}"
                            data-code="{{ p.product_code }}"
                            data-fabric="{{ p.default_fabric }}"
                            data-gsm="{{ p.default_gsm }}"
                            data-moq="{{ p.default_moq }}">
                      {{ p.product_code }} - {{ p.name }}
                    </option>
                  {% endfor %}
                </select>
                <button type="button" class="btn btn-sm btn-outline-light" id="lib-product-apply">Apply</button>
              </div>
            </div>

            <div class="prod-lib-field">
              <div class="prod-lib-label">Fabric</div>
              <div class="prod-lib-control">
                <select id="lib-fabric-picker">
                  <option value="">Select fabric</option>
                  {% for f in library_fabrics %}
                    <option value="{{ f.pk }}"
                            data-name="{{ f.name }}"
                            data-code="{{ f.fabric_code }}"
                            data-gsm="{{ f.gsm }}">
                      {{ f.fabric_code }} - {{ f.name }}{% if f.gsm %} ({{ f.gsm }}){% endif %}
                    </option>
                  {% endfor %}
                </select>
                <button type="button"
                        class="btn btn-sm btn-outline-light lib-add-btn"
                        data-select="lib-fabric-picker"
                        data-target-field="extra_order_note"
                        data-store="fabric"
                        data-template="Fabric: {code} {name} {gsm}">
                  Add
                </button>
              </div>
              <input type="hidden" name="fabric_ids" id="fabric-ids" value="{{ selected_fabric_ids|join:',' }}">
              <div class="prod-lib-selected" id="fabric-selected">
                {% for f in selected_fabrics %}
                  <span class="prod-lib-chip" data-id="{{ f.pk }}" data-store="fabric">
                    {{ f.fabric_code }} - {{ f.name }}
                    <button type="button" class="chip-remove" aria-label="Remove">×</button>
                  </span>
                {% endfor %}
              </div>
            </div>

            <div class="prod-lib-field">
              <div class="prod-lib-label">Accessory</div>
              <div class="prod-lib-control">
                <select id="lib-accessory-picker">
                  <option value="">Select accessory</option>
                  {% for a in library_accessories %}
                    <option value="{{ a.pk }}"
                            data-name="{{ a.name }}"
                            data-code="{{ a.accessory_code }}">
                      {{ a.accessory_code }} - {{ a.name }}
                    </option>
                  {% endfor %}
                </select>
                <button type="button"
                        class="btn btn-sm btn-outline-light lib-add-btn"
                        data-select="lib-accessory-picker"
                        data-target-field="accessories_note"
                        data-store="accessory"
                        data-template="Accessory: {code} {name}">
                  Add
                </button>
              </div>
              <input type="hidden" name="accessory_ids" id="accessory-ids" value="{{ selected_accessory_ids|join:',' }}">
              <div class="prod-lib-selected" id="accessory-selected">
                {% for a in selected_accessories %}
                  <span class="prod-lib-chip" data-id="{{ a.pk }}" data-store="accessory">
                    {{ a.accessory_code }} - {{ a.name }}
                    <button type="button" class="chip-remove" aria-label="Remove">×</button>
                  </span>
                {% endfor %}
              </div>
            </div>

            <div class="prod-lib-field">
              <div class="prod-lib-label">Trim</div>
              <div class="prod-lib-control">
                <select id="lib-trim-picker">
                  <option value="">Select trim</option>
                  {% for t in library_trims %}
                    <option value="{{ t.pk }}"
                            data-name="{{ t.name }}"
                            data-code="{{ t.trim_code }}">
                      {{ t.trim_code }} - {{ t.name }}
                    </option>
                  {% endfor %}
                </select>
                <button type="button"
                        class="btn btn-sm btn-outline-light lib-add-btn"
                        data-select="lib-trim-picker"
                        data-target-field="accessories_note"
                        data-store="trim"
                        data-template="Trim: {code} {name}">
                  Add
                </button>
              </div>
              <input type="hidden" name="trim_ids" id="trim-ids" value="{{ selected_trim_ids|join:',' }}">
              <div class="prod-lib-selected" id="trim-selected">
                {% for t in selected_trims %}
                  <span class="prod-lib-chip" data-id="{{ t.pk }}" data-store="trim">
                    {{ t.trim_code }} - {{ t.name }}
                    <button type="button" class="chip-remove" aria-label="Remove">×</button>
                  </span>
                {% endfor %}
              </div>
            </div>

            <div class="prod-lib-field">
              <div class="prod-lib-label">Thread</div>
              <div class="prod-lib-control">
                <select id="lib-thread-picker">
                  <option value="">Select thread</option>
                  {% for t in library_threads %}
                    <option value="{{ t.pk }}"
                            data-name="{{ t.name }}"
                            data-code="{{ t.thread_code }}">
                      {{ t.thread_code }} - {{ t.name }}
                    </option>
                  {% endfor %}
                </select>
                <button type="button"
                        class="btn btn-sm btn-outline-light lib-add-btn"
                        data-select="lib-thread-picker"
                        data-target-field="accessories_note"
                        data-store="thread"
                        data-template="Thread: {code} {name}">
                  Add
                </button>
              </div>
              <input type="hidden" name="thread_ids" id="thread-ids" value="{{ selected_thread_ids|join:',' }}">
              <div class="prod-lib-selected" id="thread-selected">
                {% for t in selected_threads %}
                  <span class="prod-lib-chip" data-id="{{ t.pk }}" data-store="thread">
                    {{ t.thread_code }} - {{ t.name }}
                    <button type="button" class="chip-remove" aria-label="Remove">×</button>
                  </span>
                {% endfor %}
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>

    <div class="prod-add-card">
      <div class="prod-add-card-title">Fabric and cost in taka</div>

      <div class="prod-add-row">

        <div class="prod-add-field">
          <div class="prod-add-label">Fabric required kg</div>
          {{ form.fabric_required_kg }}
          <div class="prod-add-help">Total fabric needed for this order</div>
          {% if form.fabric_required_kg.errors %}
            <div class="prod-add-errors">{{ form.fabric_required_kg.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Fabric received kg</div>
          {{ form.fabric_received_kg }}
          <div class="prod-add-help">Fabric that came to the factory</div>
          {% if form.fabric_received_kg.errors %}
            <div class="prod-add-errors">{{ form.fabric_received_kg.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Fabric used kg</div>
          {{ form.fabric_used_kg }}
          <div class="prod-add-help">Fabric actually used in production</div>
          {% if form.fabric_used_kg.errors %}
            <div class="prod-add-errors">{{ form.fabric_used_kg.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Fabric cost per kg taka</div>
          {{ form.fabric_cost_per_kg_bdt }}
          <div class="prod-add-help">Rate per kg system will calculate total</div>
          {% if form.fabric_cost_per_kg_bdt.errors %}
            <div class="prod-add-errors">{{ form.fabric_cost_per_kg_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Thread cost taka</div>
          {{ form.material_thread_cost_bdt }}
          <div class="prod-add-help">Total thread cost for full order not per piece</div>
          {% if form.material_thread_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.material_thread_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Zipper cost taka</div>
          {{ form.material_zipper_cost_bdt }}
          <div class="prod-add-help">Total zipper cost for full order</div>
          {% if form.material_zipper_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.material_zipper_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Accessories cost taka</div>
          {{ form.material_accessories_cost_bdt }}
          <div class="prod-add-help">Total cost of all extra items for this order</div>
          {% if form.material_accessories_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.material_accessories_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Label cost taka</div>
          {{ form.material_label_cost_bdt }}
          <div class="prod-add-help">Total woven label or print label cost</div>
          {% if form.material_label_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.material_label_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Other material cost taka</div>
          {{ form.material_other_cost_bdt }}
          <div class="prod-add-help">Any other material cost for full order</div>
          {% if form.material_other_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.material_other_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Cutting cost taka</div>
          {{ form.production_cutting_cost_bdt }}
          <div class="prod-add-help">Total cutting labour cost for this order</div>
          {% if form.production_cutting_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.production_cutting_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Sewing cost taka</div>
          {{ form.production_sewing_cost_bdt }}
          <div class="prod-add-help">Total sewing labour cost for this order</div>
          {% if form.production_sewing_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.production_sewing_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Finishing cost taka</div>
          {{ form.production_finishing_cost_bdt }}
          <div class="prod-add-help">Total finishing cost for this order</div>
          {% if form.production_finishing_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.production_finishing_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Packing cost taka</div>
          {{ form.production_packing_cost_bdt }}
          <div class="prod-add-help">Total packing cost for this order</div>
          {% if form.production_packing_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.production_packing_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Overhead cost taka</div>
          {{ form.production_overhead_cost_bdt }}
          <div class="prod-add-help">Factory overhead share for this order total only</div>
          {% if form.production_overhead_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.production_overhead_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Other work cost taka</div>
          {{ form.production_other_cost_bdt }}
          <div class="prod-add-help">Any extra work cost for full order</div>
          {% if form.production_other_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.production_other_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Remake needed</div>
          {{ form.remake_required }}
          <div class="prod-add-help">Tick only if factory will remake pieces</div>
          {% if form.remake_required.errors %}
            <div class="prod-add-errors">{{ form.remake_required.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Remake quantity</div>
          {{ form.remake_qty }}
          <div class="prod-add-help">How many pieces will be remade</div>
          {% if form.remake_qty.errors %}
            <div class="prod-add-errors">{{ form.remake_qty.errors|striptags }}</div>
          {% endif %}
        </div>

        <div class="prod-add-field">
          <div class="prod-add-label">Remake cost taka</div>
          {{ form.remake_cost_bdt }}
          <div class="prod-add-help">Total extra cost for remake pieces</div>
          {% if form.remake_cost_bdt.errors %}
            <div class="prod-add-errors">{{ form.remake_cost_bdt.errors|striptags }}</div>
          {% endif %}
        </div>

      </div>
    </div>

    <div class="prod-add-actions">
      {% if is_edit and order %}
        <a href="{% url 'production_detail' order.pk %}" class="btn btn-outline-secondary btn-sm">
          Cancel
        </a>
      {% else %}
        <a href="{% url 'production_list' %}" class="btn btn-outline-secondary btn-sm">
          Cancel
        </a>
      {% endif %}
      <button type="submit" class="btn btn-warning btn-sm">
        {% if is_edit %}
          Save changes
        {% else %}
          Create order
        {% endif %}
      </button>
    </div>

  </form>

  <div id="line-modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div class="modal-title">Add product line</div>
          <div class="modal-sub">
            {% if order and order.customer %}
              Client: {{ order.customer.account_brand|default:order.customer.contact_name|default:order.customer }}
            {% endif %}
          </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-light" id="line-modal-close">Close</button>
      </div>
      <div id="line-modal-note" class="modal-sub" style="color:#fca5a5; display:none;">
        Please add at least one detail before saving.
      </div>

      <div class="modal-grid">
        <div>
          <div class="prod-add-label">Style name</div>
          <input type="text" id="line-modal-style" class="inputx" placeholder="Style name">
        </div>
        <div>
          <div class="prod-add-label">Color info</div>
          <input type="text" id="line-modal-color" class="inputx" placeholder="Colorways">
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="prod-add-label">Size ratio note</div>
        <textarea id="line-modal-size" rows="4" class="inputx" placeholder="Example: XS 20, S 40, M 60, L 40"></textarea>
      </div>

      <div style="margin-top:12px;">
        <div class="prod-add-label">Accessories and trims</div>
        <textarea id="line-modal-accessories" rows="3" class="inputx" placeholder="Trims, labels, zips, etc."></textarea>
      </div>

      <div style="margin-top:12px;">
        <div class="prod-add-label">Packaging details</div>
        <textarea id="line-modal-packaging" rows="3" class="inputx" placeholder="Packaging notes"></textarea>
      </div>

      <div style="margin-top:12px;">
        <div class="prod-add-label">Extra order notes</div>
        <textarea id="line-modal-extra" rows="3" class="inputx" placeholder="Any additional notes"></textarea>
      </div>

      <div style="text-align:right; margin-top:12px;">
        <button type="button" class="btn btn-warning btn-sm" id="line-modal-save">Add Line</button>
      </div>
    </div>
  </div>

</div>

<script>
  (function () {
    function normKey(k) {
      return (k || "").toString().trim().toUpperCase();
    }

    function parseSizeRatio(text) {
      // supports: "XS 10, S 20" or "XS:10, S:20" or "XS=10"
      var out = {};
      if (!text) return out;

      text.split(",").forEach(function (chunk) {
        var c = chunk.trim();
        if (!c) return;

        var m = c.match(/^([A-Za-z0-9]+)\s*[:= ]\s*([0-9]+)$/);
        if (m) {
          out[normKey(m[1])] = m[2];
          return;
        }

        var parts = c.split(/\s+/);
        if (parts.length >= 2) {
          out[normKey(parts[0])] = parts[1];
        }
      });

      return out;
    }

    function buildSizeRatio(sizeKeys, inputs) {
      var out = [];
      sizeKeys.forEach(function (key) {
        var el = inputs[key];
        if (!el) return;
        var v = (el.value || "").trim();
        if (v !== "" && v !== "0") {
          out.push(key + " " + v);
        }
      });
      return out.join(", ");
    }

    document.addEventListener("DOMContentLoaded", function () {
      var form = document.getElementById("prod-form");
      var lineList = document.getElementById("prod-line-list");
      var linePayload = document.getElementById("line-payload");
      var addBtn = document.getElementById("prod-line-add");
      var lineModal = document.getElementById("line-modal");
      var lineModalClose = document.getElementById("line-modal-close");
      var lineModalSave = document.getElementById("line-modal-save");
      var lineModalStyle = document.getElementById("line-modal-style");
      var lineModalColor = document.getElementById("line-modal-color");
      var lineModalSize = document.getElementById("line-modal-size");
      var lineModalAccessories = document.getElementById("line-modal-accessories");
      var lineModalPackaging = document.getElementById("line-modal-packaging");
      var lineModalExtra = document.getElementById("line-modal-extra");
      var lineModalNote = document.getElementById("line-modal-note");
      if (!form || !lineList || !linePayload) return;

      var sizeKeys = ["XS", "S", "M", "L", "XL", "2XL", "3XL", "4XL", "5XL"];

      function getLineField(line, name) {
        if (!line) return null;
        return line.querySelector('[data-field="' + name + '"]');
      }

      function getActiveLine() {
        return lineList.querySelector(".prod-line.active") || lineList.querySelector(".prod-line");
      }

      function setActiveLine(line) {
        if (!line) return;
        lineList.querySelectorAll(".prod-line").forEach(function (item) {
          item.classList.remove("active");
        });
        line.classList.add("active");
      }

      function openLineModal() {
        if (!lineModal) return;
        lineModal.classList.add("open");
      }

      function closeLineModal() {
        if (!lineModal) return;
        lineModal.classList.remove("open");
      }

      function resetLineModal() {
        if (lineModalStyle) lineModalStyle.value = "";
        if (lineModalColor) lineModalColor.value = "";
        if (lineModalSize) lineModalSize.value = "";
        if (lineModalAccessories) lineModalAccessories.value = "";
        if (lineModalPackaging) lineModalPackaging.value = "";
        if (lineModalExtra) lineModalExtra.value = "";
        if (lineModalNote) lineModalNote.style.display = "none";
      }

      function readLineModalValues() {
        return {
          style_name: lineModalStyle ? lineModalStyle.value.trim() : "",
          color_info: lineModalColor ? lineModalColor.value.trim() : "",
          size_ratio_note: lineModalSize ? lineModalSize.value.trim() : "",
          accessories_note: lineModalAccessories ? lineModalAccessories.value.trim() : "",
          packaging_note: lineModalPackaging ? lineModalPackaging.value.trim() : "",
          extra_order_note: lineModalExtra ? lineModalExtra.value.trim() : ""
        };
      }

      function setLineField(line, name, value) {
        var el = getLineField(line, name);
        if (el) el.value = value || "";
      }

      function clearLineFields(line) {
        line.querySelectorAll("[data-size-field]").forEach(function (el) {
          el.value = "";
        });
        line.querySelectorAll("[data-field]").forEach(function (el) {
          el.value = "";
        });
      }

      function addLineFromModal(values) {
        var lines = lineList.querySelectorAll(".prod-line");
        var base = lines[lines.length - 1];
        if (!base) return;
        syncLineSize(base);
        var clone = base.cloneNode(true);
        clearLineFields(clone);
        setLineField(clone, "style_name", values.style_name);
        setLineField(clone, "color_info", values.color_info);
        setLineField(clone, "size_ratio_note", values.size_ratio_note);
        setLineField(clone, "accessories_note", values.accessories_note);
        setLineField(clone, "packaging_note", values.packaging_note);
        setLineField(clone, "extra_order_note", values.extra_order_note);
        lineList.appendChild(clone);
        initLine(clone);
        refreshLineIndexes();
        setActiveLine(clone);
      }

      function syncLineSize(line) {
        var sizeField = getLineField(line, "size_ratio_note");
        if (!sizeField) return;
        var inputs = {};
        sizeKeys.forEach(function (key) {
          inputs[key] = line.querySelector('[data-size-field="' + key + '"]');
        });
        sizeField.value = buildSizeRatio(sizeKeys, inputs);
      }

      function initLine(line) {
        var sizeField = getLineField(line, "size_ratio_note");
        if (!sizeField) return;
        var inputs = {};
        sizeKeys.forEach(function (key) {
          inputs[key] = line.querySelector('[data-size-field="' + key + '"]');
        });
        var parsed = parseSizeRatio(sizeField.value);
        sizeKeys.forEach(function (key) {
          if (inputs[key] && parsed[key]) {
            inputs[key].value = parsed[key];
          }
        });
        sizeKeys.forEach(function (key) {
          var el = inputs[key];
          if (!el) return;
          el.addEventListener("input", function () {
            sizeField.value = buildSizeRatio(sizeKeys, inputs);
          });
        });
      }

      function refreshLineIndexes() {
        var lines = lineList.querySelectorAll(".prod-line");
        lines.forEach(function (line, idx) {
          line.setAttribute("data-line-index", idx + 1);
          var title = line.querySelector(".prod-line-title");
          if (title) {
            title.textContent = "Product line " + (idx + 1);
          }
          var removeBtn = line.querySelector(".prod-line-remove");
          if (removeBtn) {
            removeBtn.disabled = lines.length === 1;
          }
        });
      }

      lineList.querySelectorAll(".prod-line").forEach(function (line) {
        initLine(line);
      });
      refreshLineIndexes();
      setActiveLine(getActiveLine());

      lineList.addEventListener("focusin", function (ev) {
        var line = ev.target.closest(".prod-line");
        if (line) setActiveLine(line);
      });

      lineList.addEventListener("click", function (ev) {
        if (!ev.target.classList.contains("prod-line-remove")) return;
        var line = ev.target.closest(".prod-line");
        if (!line) return;
        var lines = lineList.querySelectorAll(".prod-line");
        if (lines.length === 1) {
          line.querySelectorAll("input, textarea").forEach(function (el) {
            if (el.hasAttribute("data-size-field")) {
              el.value = "";
            } else if (el.hasAttribute("data-field")) {
              el.value = "";
            }
          });
          return;
        }
        line.remove();
        refreshLineIndexes();
        setActiveLine(getActiveLine());
      });

      if (addBtn) {
        addBtn.addEventListener("click", function () {
          if (lineModal) {
            resetLineModal();
            openLineModal();
            return;
          }
          var lines = lineList.querySelectorAll(".prod-line");
          var last = lines[lines.length - 1];
          if (!last) return;
          syncLineSize(last);
          var clone = last.cloneNode(true);
          lineList.appendChild(clone);
          initLine(clone);
          refreshLineIndexes();
          setActiveLine(clone);
        });
      }

      if (lineModalSave) {
        lineModalSave.addEventListener("click", function () {
          var values = readLineModalValues();
          if (!values.style_name && !values.color_info && !values.size_ratio_note && !values.accessories_note && !values.packaging_note && !values.extra_order_note) {
            if (lineModalNote) lineModalNote.style.display = "block";
            return;
          }
          if (lineModalNote) lineModalNote.style.display = "none";
          addLineFromModal(values);
          closeLineModal();
          resetLineModal();
        });
      }

      if (lineModalClose) {
        lineModalClose.addEventListener("click", closeLineModal);
      }

      if (lineModal) {
        lineModal.addEventListener("click", function (event) {
          if (event.target === lineModal) {
            closeLineModal();
          }
        });
      }

      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeLineModal();
        }
      });

      form.addEventListener("submit", function () {
        var payload = [];
        lineList.querySelectorAll(".prod-line").forEach(function (line, idx) {
          syncLineSize(line);
          payload.push({
            line_no: idx + 1,
            style_name: (getLineField(line, "style_name") || {}).value || "",
            color_info: (getLineField(line, "color_info") || {}).value || "",
            size_ratio_note: (getLineField(line, "size_ratio_note") || {}).value || "",
            accessories_note: (getLineField(line, "accessories_note") || {}).value || "",
            packaging_note: (getLineField(line, "packaging_note") || {}).value || "",
            extra_order_note: (getLineField(line, "extra_order_note") || {}).value || ""
          });
        });
        linePayload.value = JSON.stringify(payload);
      });

      window.prodLineHelpers = {
        getActiveLine: getActiveLine,
        getActiveLineField: function (name) {
          var line = getActiveLine();
          return getLineField(line, name);
        }
      };
    });
  })();
</script>

<script>
  (function () {
    function appendLine(target, text) {
      var field = target;
      if (typeof target === "string") {
        field = document.getElementById(target);
      }
      if (!field || !text) return;
      var current = (field.value || "").trim();
      if (!current) {
        field.value = text;
        return;
      }
      if (current.indexOf(text) !== -1) return;
      field.value = current + "\n" + text;
    }

    function fillTemplate(template, data) {
      return template.replace(/\{(\w+)\}/g, function (_, key) {
        return (data[key] || "").toString().trim();
      }).replace(/\s+/g, " ").trim();
    }

    document.addEventListener("DOMContentLoaded", function () {
      var storeMap = {
        fabric: { input: "fabric-ids", list: "fabric-selected" },
        accessory: { input: "accessory-ids", list: "accessory-selected" },
        trim: { input: "trim-ids", list: "trim-selected" },
        thread: { input: "thread-ids", list: "thread-selected" }
      };

      function getIds(storeKey) {
        var cfg = storeMap[storeKey];
        if (!cfg) return [];
        var input = document.getElementById(cfg.input);
        if (!input || !input.value) return [];
        return input.value.split(",").map(function (v) { return v.trim(); }).filter(Boolean);
      }

      function setIds(storeKey, ids) {
        var cfg = storeMap[storeKey];
        if (!cfg) return;
        var input = document.getElementById(cfg.input);
        if (input) {
          input.value = ids.join(",");
        }
      }

      function addChip(storeKey, id, label) {
        var cfg = storeMap[storeKey];
        if (!cfg) return;
        var list = document.getElementById(cfg.list);
        if (!list) return;
        var chip = document.createElement("span");
        chip.className = "prod-lib-chip";
        chip.setAttribute("data-id", id);
        chip.setAttribute("data-store", storeKey);
        chip.innerHTML = label + ' <button type="button" class="chip-remove" aria-label="Remove">×</button>';
        list.appendChild(chip);
      }

      function addSelection(storeKey, id, label) {
        var ids = getIds(storeKey);
        if (ids.indexOf(String(id)) !== -1) return;
        ids.push(String(id));
        setIds(storeKey, ids);
        addChip(storeKey, id, label);
      }

      function getActiveLineField(name) {
        if (window.prodLineHelpers && window.prodLineHelpers.getActiveLineField) {
          return window.prodLineHelpers.getActiveLineField(name);
        }
        return document.querySelector('[data-field="' + name + '"]');
      }

      var applyBtn = document.getElementById("lib-product-apply");
      var productPicker = document.getElementById("lib-product-picker");
      var productField = document.getElementById("id_product");
      var qtyField = document.getElementById("id_qty_total");

      if (applyBtn && productPicker) {
        applyBtn.addEventListener("click", function () {
          var opt = productPicker.options[productPicker.selectedIndex];
          if (!opt || !opt.value) return;

          if (productField) {
            productField.value = opt.value;
          }

          var styleField = getActiveLineField("style_name");
          if (styleField && !(styleField.value || "").trim()) {
            styleField.value = opt.dataset.name || "";
          }

          if (qtyField && !(qtyField.value || "").trim() && opt.dataset.moq) {
            qtyField.value = opt.dataset.moq;
          }

          var fabricLine = "";
          if (opt.dataset.fabric) {
            fabricLine = "Fabric: " + opt.dataset.fabric;
            if (opt.dataset.gsm) {
              fabricLine += " " + opt.dataset.gsm;
            }
          }
          var extraField = getActiveLineField("extra_order_note");
          if (fabricLine && extraField) {
            appendLine(extraField, fabricLine);
          }
        });
      }

      document.querySelectorAll(".lib-add-btn").forEach(function (btn) {
        btn.addEventListener("click", function () {
          var selectId = btn.getAttribute("data-select");
          var targetField = btn.getAttribute("data-target-field");
          var template = btn.getAttribute("data-template") || "{name}";
          var storeKey = btn.getAttribute("data-store");

          var selectEl = document.getElementById(selectId);
          if (!selectEl) return;
          var opt = selectEl.options[selectEl.selectedIndex];
          if (!opt || !opt.value) return;

          var data = {
            name: opt.dataset.name || opt.textContent || "",
            code: opt.dataset.code || "",
            gsm: opt.dataset.gsm || "",
          };

          var text = fillTemplate(template, data);
          var fieldEl = getActiveLineField(targetField);
          appendLine(fieldEl, text);

          if (storeKey) {
            var label = (opt.textContent || "").trim();
            addSelection(storeKey, opt.value, label);
          }
        });
      });

      document.addEventListener("click", function (ev) {
        var btn = ev.target;
        if (!btn.classList.contains("chip-remove")) return;
        var chip = btn.closest(".prod-lib-chip");
        if (!chip) return;
        var storeKey = chip.getAttribute("data-store");
        var id = chip.getAttribute("data-id");
        if (!storeKey || !id) return;
        var ids = getIds(storeKey).filter(function (x) { return x !== String(id); });
        setIds(storeKey, ids);
        chip.remove();
      });
    });
  })();
</script>

{% endblock %}
