{% extends "crm/base.html" %}
{% load static %}

{% block content %}
<style>
  .chatter-page {
    max-width: 1100px;
    margin: 22px auto 50px auto;
    padding: 0 12px;
    color: #f9fafb;
  }

  .chatter-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .chatter-title {
    font-size: 20px;
    font-weight: 800;
    color: #fefce8;
  }

  .chatter-sub {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 4px;
  }

  .chatter-card {
    background: radial-gradient(circle at top left, #0f172a, #020617);
    border: 1px solid #1f2937;
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 0 18px rgba(0,0,0,0.6);
    margin-bottom: 12px;
  }

  .chatter-grid {
    display: grid;
    grid-template-columns: minmax(0, 2.3fr) minmax(0, 1fr);
    gap: 14px;
  }

  .filter-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .filter-btn {
    padding: 5px 12px;
    border-radius: 999px;
    border: 1px solid #374151;
    background: #020617;
    color: #e5e7eb;
    font-size: 12px;
    text-decoration: none;
  }

  .filter-btn.active {
    border-color: #facc15;
    color: #fef9c3;
    box-shadow: 0 0 0 1px rgba(250,204,21,0.35);
  }

  .note-form textarea,
  .note-form select,
  .note-form input {
    width: 100%;
    background: #020617;
    color: #e5e7eb;
    border: 1px solid #374151;
    border-radius: 8px;
    padding: 7px 9px;
    font-size: 12px;
  }

  .note-form label {
    font-size: 11px;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    display: block;
    margin-bottom: 4px;
  }

  .note-form .row {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
    gap: 10px;
  }

  .note-list .note-item {
    padding: 10px;
    border-radius: 12px;
    border: 1px solid #1f2937;
    background: rgba(2,6,23,0.65);
    margin-bottom: 10px;
  }

  .note-meta {
    font-size: 11px;
    color: #9ca3af;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 6px;
  }

  .note-author {
    font-weight: 700;
    color: #f9fafb;
  }

  .note-tag {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid #374151;
    background: rgba(15,23,42,0.8);
    color: #e5e7eb;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .note-content {
    font-size: 12px;
    color: #e5e7eb;
    white-space: pre-wrap;
  }

  .team-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 12px;
  }

  .team-item {
    padding: 8px;
    border-radius: 10px;
    border: 1px solid #1f2937;
    background: rgba(2,6,23,0.7);
  }

  .muted {
    color: #9ca3af;
    font-size: 11px;
  }

  @media (max-width: 900px) {
    .chatter-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="chatter-page">
  <div class="chatter-header">
    <div>
      <div class="chatter-title">Chatter feed</div>
      <div class="chatter-sub">All notes from leads, opportunities, and production in one place.</div>
      <div class="filter-row">
        <a href="?source=all" class="filter-btn {% if source == 'all' %}active{% endif %}">All</a>
        <a href="?source=lead" class="filter-btn {% if source == 'lead' %}active{% endif %}">Leads</a>
        <a href="?source=opportunity" class="filter-btn {% if source == 'opportunity' %}active{% endif %}">Opportunities</a>
        <a href="?source=production" class="filter-btn {% if source == 'production' %}active{% endif %}">Production</a>
      </div>
    </div>
  </div>

  <div class="chatter-grid">
    <div>
      <div class="chatter-card">
        <div style="font-size:13px; font-weight:700; color:#fef9c3; margin-bottom:8px;">Post a note</div>
        <form method="post" class="note-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_chatter">
          <label>Note</label>
          <textarea name="comment_text" rows="3" placeholder="Write a note and mention @username"></textarea>

          <div class="row" style="margin-top:10px;">
            <div>
              <label>Attach to</label>
              <select name="link_type">
                <option value="">General</option>
                <option value="lead">Lead</option>
                <option value="opportunity">Opportunity</option>
                <option value="production">Production</option>
              </select>
            </div>
            <div>
              <label>Record ID</label>
              <input type="text" name="link_id" placeholder="e.g. 58">
            </div>
          </div>

          <div style="text-align:right; margin-top:10px;">
            <button type="submit" class="btn btn-warning btn-sm">Save note</button>
          </div>
          <div class="muted" style="margin-top:6px;">
            Mentions like @hussein will email that team member automatically.
          </div>
        </form>
      </div>

      <div class="chatter-card">
        <div style="font-size:13px; font-weight:700; color:#fef9c3; margin-bottom:8px;">Latest notes</div>

        <div class="note-list">
          {% if comments %}
            {% for c in comments %}
              <div class="note-item">
                <div class="note-meta">
                  <span class="note-author">{{ c.author|default:"User" }}</span>
                  <span>{{ c.created_at }}</span>
                  {% if c.production %}<span class="note-tag">Production</span>{% endif %}
                  {% if c.opportunity %}<span class="note-tag">Opportunity</span>{% endif %}
                  {% if c.lead and not c.opportunity and not c.production %}<span class="note-tag">Lead</span>{% endif %}
                  {% if c.pinned %}<span class="note-tag">Pinned</span>{% endif %}
                  {% if c.is_ai %}<span class="note-tag">AI</span>{% endif %}
                </div>
                <div class="note-content">{{ c.content }}</div>
                <div class="muted" style="margin-top:6px;">
                  {% if c.production %}
                    <a href="{% url 'production_detail' c.production.pk %}">Open production</a>
                  {% elif c.opportunity %}
                    <a href="{% url 'opportunity_detail' c.opportunity.pk %}">Open opportunity</a>
                  {% elif c.lead %}
                    <a href="{% url 'lead_detail' c.lead.pk %}">Open lead</a>
                  {% else %}
                    General note
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="muted">No chatter notes found.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div>
      <div class="chatter-card">
        <div style="font-size:13px; font-weight:700; color:#fef9c3; margin-bottom:8px;">Team emails</div>
        <div class="team-list">
          {% for member in team_members %}
            <div class="team-item">
              <div><strong>{{ member.username }}</strong></div>
              <div class="muted">{{ member.email|default:"(no email)" }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
