<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Event detail - Iconic CRM</title>
  <style>
    :root {
      --bg: #020617;
      --panel: #0b1220;
      --line: #22304a;
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #f5d580;
      --accent-2: #60a5fa;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    .top-nav {
      background: #000812;
      padding: 10px 0 6px 0;
      border-bottom: 1px solid var(--line);
    }

    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .nav-item {
      display: inline-block;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 900;
      border-radius: 999px;
      border: 1px solid rgba(245, 213, 128, 0.5);
      background: rgba(245, 213, 128, 0.12);
      color: #fef9c3;
      white-space: nowrap;
    }

    .nav-item-active {
      background: linear-gradient(145deg, #f5d580, #d4b35f);
      color: #111827;
    }

    .wrapper {
      max-width: 1100px;
      margin: 20px auto 50px auto;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--line);
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.35);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .event-title {
      font-size: 24px;
      margin: 0 0 6px 0;
      color: #fef9c3;
      font-weight: 900;
    }

    .badge {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 900;
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-right: 6px;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.6);
    }

    .tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(2, 6, 23, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      margin-right: 6px;
      font-size: 11px;
      color: #e5e7eb;
    }

    .section {
      margin-top: 18px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(2, 6, 23, 0.7);
    }

    .section-title {
      margin: 0 0 10px 0;
      font-size: 15px;
      font-weight: 900;
      color: #fefce8;
    }

    .two-col {
      display: flex;
      gap: 18px;
      flex-wrap: wrap;
    }

    .col-half {
      width: 100%;
    }

    @media (min-width: 900px) {
      .col-half {
        width: 50%;
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    th {
      text-align: left;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .row-label {
      width: 160px;
      font-weight: 900;
      color: #e5e7eb;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 11px;
      font-weight: 900;
      text-decoration: none;
      color: #e5e7eb;
      background: rgba(255, 255, 255, 0.04);
    }

    .btn.primary {
      background: linear-gradient(145deg, #f5d580, #d4b35f);
      color: #111827;
      border-color: rgba(245, 213, 128, 0.5);
    }

    .pill-btn {
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid rgba(245, 213, 128, 0.4);
      background: rgba(245, 213, 128, 0.12);
      color: #fef9c3;
      cursor: pointer;
    }

    .ai-output-box {
      margin-top: 6px;
      background: rgba(2, 6, 23, 0.85);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 10px;
      font-size: 12px;
      white-space: pre-wrap;
      min-height: 70px;
      color: #e5e7eb;
    }

    .small-muted {
      font-size: 11px;
      color: var(--muted);
    }

    input[type="text"] {
      width: 100%;
      background: rgba(2, 6, 23, 0.85);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 10px;
      padding: 7px 9px;
      font-size: 12px;
      font-weight: 800;
    }
  </style>
</head>
<body>

<div class="top-nav">
  <div class="nav-inner">
    <a href="{% url 'leads_list' %}" class="nav-item">Leads</a>
    <a href="{% url 'opportunities_list' %}" class="nav-item">Opportunities</a>
    <a href="{% url 'products_list' %}" class="nav-item">Products</a>
    <a href="{% url 'customers_list' %}" class="nav-item">Customers</a>
    <a href="#" class="nav-item">Dashboard</a>
    <a href="{% url 'calendar_list' %}" class="nav-item nav-item-active">Calendar</a>
    <a href="#" class="nav-item">Marketing</a>
    <a href="#" class="nav-item">Production</a>
    <a href="#" class="nav-item">Accounting</a>
    <a href="#" class="nav-item">Shipping</a>
    <a href="#" class="nav-item">Factory</a>
    <a href="#" class="nav-item">Inventory</a>
  </div>
</div>

<div class="wrapper">
  <div class="top-bar">
    <div>
      <h1 class="event-title">{{ event.title }}</h1>
      <div>
        <span class="badge">{{ event.get_event_type_display }}</span>
        <span class="badge">Priority: {{ event.get_priority_display }}</span>
        <span class="badge">Status: {{ event.get_status_display }}</span>
      </div>
      <div style="margin-top:6px;">
        {% if event.lead %}
          <span class="tag">Lead: {{ event.lead.account_brand }} ({{ event.lead.lead_id }})</span>
        {% endif %}
        {% if event.customer %}
          <span class="tag">Customer: {{ event.customer.account_brand }}</span>
        {% endif %}
        {% if event.opportunity %}
          <span class="tag">Opportunity linked</span>
        {% endif %}
      </div>
    </div>

    <div style="text-align:right; display:flex; gap:8px; flex-wrap:wrap;">
      <a href="{% url 'calendar_list' %}" class="btn">Back to calendar</a>
      <a href="{% url 'calendar_edit' event.pk %}" class="btn primary">Edit event</a>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">Event details</h2>
    <div class="two-col">
      <div class="col-half">
        <table>
          <tr>
            <td class="row-label">Start</td>
            <td>{{ event.start_datetime }}</td>
          </tr>
          <tr>
            <td class="row-label">End</td>
            <td>
              {% if event.end_datetime %}
                {{ event.end_datetime }}
              {% else %}
                Not set
              {% endif %}
            </td>
          </tr>
          <tr>
            <td class="row-label">Production stage</td>
            <td>
              {% if event.production_stage %}
                {{ event.get_production_stage_display }}
              {% else %}
                None
              {% endif %}
            </td>
          </tr>
        </table>
      </div>
      <div class="col-half">
        <table>
          <tr>
            <td class="row-label">Assigned to</td>
            <td>{% if event.assigned_to_name %}{{ event.assigned_to_name }}{% else %}Not set{% endif %}</td>
          </tr>
          <tr>
            <td class="row-label">Reminder</td>
            <td>{% if event.reminder_minutes_before %}{{ event.reminder_minutes_before }} minutes before{% else %}None{% endif %}</td>
          </tr>
          <tr>
            <td class="row-label">Note</td>
            <td>{{ event.note|default:"-" }}</td>
          </tr>
        </table>
      </div>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">AI helper for this event</h2>
    <div class="small-muted">
      AI reads this event and gives summary, follow up and next step ideas.
    </div>

    <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;">
      <button type="button" class="pill-btn" data-mode="summary">Summary</button>
      <button type="button" class="pill-btn" data-mode="follow_up">Follow up text</button>
      <button type="button" class="pill-btn" data-mode="next_steps">Next steps</button>
      <button type="button" class="pill-btn" data-mode="reminder">Reminder note</button>
    </div>

    <div style="margin-top:8px;">
      <input id="event-ai-question" type="text" placeholder="Ask AI something about this event">
      <button type="button" id="event-ai-chat-btn" class="btn" style="margin-top:6px;">Ask AI</button>
      <span id="event-ai-status" class="small-muted" style="margin-left:6px;"></span>
    </div>

    <div id="event-ai-output" class="ai-output-box">AI answer will appear here.</div>

    <form id="event-ai-csrf" style="display:none;">
      {% csrf_token %}
    </form>
  </div>

  <div class="section">
    <h2 class="section-title">Upcoming events for same lead</h2>
    {% if upcoming_for_lead %}
      <table>
        <thead>
          <tr>
            <th style="width:40%;">Title</th>
            <th style="width:30%;">Time</th>
            <th style="width:30%;">Type</th>
          </tr>
        </thead>
        <tbody>
          {% for e in upcoming_for_lead %}
            <tr>
              <td><a href="{% url 'calendar_event_detail' e.pk %}">{{ e.title }}</a></td>
              <td>{{ e.start_datetime }}</td>
              <td>{{ e.get_event_type_display }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="small-muted">No other upcoming events for this lead.</p>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    const outBox = document.getElementById("event-ai-output");
    const statusBox = document.getElementById("event-ai-status");
    const qInput = document.getElementById("event-ai-question");
    const chatBtn = document.getElementById("event-ai-chat-btn");
    const buttons = document.querySelectorAll("button[data-mode]");

    function getCsrf() {
      const t = document.querySelector("#event-ai-csrf input[name='csrfmiddlewaretoken']");
      return t ? t.value : "";
    }

    function callEventAI(mode, userText) {
      statusBox.textContent = "AI is thinking";
      outBox.textContent = "";

      const body = new URLSearchParams();
      body.append("mode", mode);
      if (userText) {
        body.append("user_text", userText);
      }

      fetch("{% url 'calendar_event_ai' event.pk %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrf()
        },
        body: body.toString()
      })
      .then(function (r) { return r.json(); })
      .then(function (data) {
        if (data.ok) {
          outBox.textContent = data.text || "No answer from AI.";
          statusBox.textContent = "Ready";
        } else {
          outBox.textContent = data.error || "AI could not answer.";
          statusBox.textContent = "";
        }
      })
      .catch(function () {
        outBox.textContent = "Error talking to AI.";
        statusBox.textContent = "";
      });
    }

    buttons.forEach(function (btn) {
      btn.addEventListener("click", function () {
        const mode = btn.getAttribute("data-mode");
        callEventAI(mode, "");
      });
    });

    if (chatBtn && qInput) {
      chatBtn.addEventListener("click", function () {
        const q = qInput.value.trim();
        if (!q) return;
        callEventAI("chat", q);
        qInput.value = "";
      });
    }
  })();
</script>

</body>
</html>
