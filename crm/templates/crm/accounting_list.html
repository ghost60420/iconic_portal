{% extends "crm/base.html" %}
{% load crm_groups %}
{% load humanize %}
{% block content %}

<style>
  :root{
    --bg:#020617;
    --bg2:#030712;
    --line:#374151;
    --line2:#111827;
    --text:#f9fafb;
    --muted:#cbd5e1;
    --good:#86efac;
    --bad:#ffb4b4;
    --gold1:#f5d580;
    --gold2:#d4b35f;
  }

  .acct-wrap{ max-width:1400px; margin:0 auto; color:var(--text); }

  .acct-card{
    background:var(--bg);
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:0 14px 34px rgba(0,0,0,0.38);
    overflow:hidden;
  }

  .acct-head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:14px;
    flex-wrap:wrap;
    margin-bottom:14px;
  }

  .acct-title{ margin:0; font-weight:900; letter-spacing:0.2px; }
  .acct-subtitle{ font-size:12px; color:var(--muted); font-weight:700; margin-top:4px; }

  .pillbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  .pill{
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 14px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid var(--line);
    background:linear-gradient(145deg,#0f172a,var(--bg));
    color:var(--text);
    box-shadow:0 3px 0 #020617;
    white-space:nowrap;
    cursor:pointer;
  }
  .pill:hover{ opacity:0.95; text-decoration:none; }
  .pill-gold{
    background:linear-gradient(145deg,var(--gold1),var(--gold2));
    color:#050505;
    border:1px solid #e5c670;
    box-shadow:0 3px 0 #8a6b24;
  }
  .pill-green{
    background:linear-gradient(145deg,#22c55e,#16a34a);
    color:#052e16;
    border:1px solid #22c55e;
    box-shadow:0 3px 0 #166534;
  }

  .acct-label{
    font-size:11px;
    text-transform:uppercase;
    color:#e5e7eb;
    letter-spacing:0.45px;
    font-weight:900;
  }
  .acct-value{
    font-size:22px;
    font-weight:900;
    color:var(--text);
    line-height:1.15;
    word-break:break-word;
  }
  .acct-small{
    font-size:12px;
    color:var(--muted);
    font-weight:700;
    line-height:1.35;
    margin-top:6px;
  }

  .acct-input{
    background:var(--bg2) !important;
    border-color:#4b5563 !important;
    color:var(--text) !important;
    font-weight:800;
  }
  .acct-input::placeholder{ color:#94a3b8; font-weight:800; }

  .acct-table{ color:var(--text) !important; }
  .acct-table th{
    color:var(--text) !important;
    font-weight:900 !important;
    white-space:nowrap;
    border-color:var(--line2) !important;
  }
  .acct-table td{
    color:var(--text) !important;
    vertical-align:middle;
    border-color:var(--line2) !important;
    font-weight:750;
  }

  .nowrap{ white-space:nowrap; }
  .descWrap{
    max-width:460px;
    white-space:normal;
    word-break:break-word;
    line-height:1.25;
    color:var(--text);
  }

  .badge{ font-weight:900 !important; letter-spacing:0.2px; }

  .filePill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #475569;
    background:#0b1220;
    color:var(--text);
    font-weight:900;
    font-size:12px;
    text-decoration:none;
    cursor:pointer;
  }

  .fileListBox{
    margin-top:8px;
    padding:10px 12px;
    border:1px solid #334155;
    border-radius:12px;
    background:var(--bg2);
  }
  .fileRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:6px 0;
    border-bottom:1px solid var(--line2);
  }
  .fileRow:last-child{ border-bottom:none; }
  .fileName{
    color:#e5e7eb;
    font-weight:800;
    font-size:12px;
    word-break:break-word;
  }
  .linkGold{
    color:#ffe39b;
    text-decoration:none;
    font-weight:900;
  }
  .linkGold:hover{ text-decoration:underline; }

  .section-title{ font-size:14px; font-weight:900; color:var(--text); margin:0; }
  .section-note{ font-size:11px; color:var(--muted); font-weight:700; margin:0; }

  .warnBox{
    border:1px solid #7f1d1d;
    background:#0b1220;
    border-radius:14px;
    padding:12px 14px;
    margin-bottom:14px;
  }
  .warnTitle{ font-weight:900; font-size:12px; color:var(--bad); margin:0 0 6px 0; }
  .warnList{ margin:0; padding-left:16px; font-size:12px; font-weight:800; color:#e5e7eb; }
</style>

<div class="container-fluid">
  <div class="acct-wrap">

    <div class="acct-head">
      <div>
        <h2 class="acct-title">Accounting dashboard</h2>
        <div class="acct-subtitle">Track every entry for Canada and Bangladesh.</div>
      </div>

      <div class="pillbar">
        {% if request.user.is_superuser %}
          <a href="{% url 'accounting_entry_add_ca' %}" class="pill pill-gold">Add Canada entry</a>
        {% else %}
          {% if request.user|in_group:"CA" or request.user|in_group:"Canada" %}
            <a href="{% url 'accounting_entry_add_ca' %}" class="pill pill-gold">Add entry</a>
          {% endif %}
        {% endif %}

        <a href="{% url 'production_profit_report' %}" class="pill">Production profit</a>
        <a href="{% url 'accounting_ai_audit' %}" class="pill">AI Audit</a>
        {% with qs=request.GET.urlencode %}
          <a href="{% url 'accounting_audit_trail' %}{% if qs %}?{{ qs }}{% endif %}" class="pill">Audit trail</a>
        {% endwith %}
      </div>
    </div>

    <div class="acct-card mb-3">
      <div class="card-body p-3">
        <div class="pillbar">
          <a href="{% url 'accounting_entry_list' %}" class="pill pill-gold">All entries</a>
          <a href="{% url 'accounting_ca_master' %}" class="pill">ðŸ’° Money transfer</a>
          <a href="{% url 'accounting_bd_dashboard' %}" class="pill">Bangladesh dashboard</a>
          <a href="{% url 'accounting_bd_grid' %}" class="pill">Bangladesh grid</a>
          <a href="{% url 'accounting_bd_daily' %}" class="pill">Bangladesh daily</a>
          <a href="{% url 'bd_staff_list' %}" class="pill">Bangladesh staff</a>
          <a href="{% url 'bd_staff_month_list' %}" class="pill">Payroll months</a>
          {% if request.user.is_superuser %}
            <a href="{% url 'bd_staff_add' %}" class="pill pill-green">Add BD staff</a>
          {% endif %}
        </div>
        <div class="acct-subtitle" style="margin-top:8px;">Use these buttons to switch pages fast.</div>
      </div>
    </div>

    {% if warnings %}
      <div class="warnBox">
        <p class="warnTitle">Warnings</p>
        <ul class="warnList">
          {% for w in warnings %}
            <li>{{ w }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="acct-card">
          <div class="card-body p-3">
            <div class="acct-label">Canada net CAD</div>
            <div class="acct-value" style="{% if total_ca_net_cad and total_ca_net_cad < 0 %}color:var(--bad);{% else %}color:var(--good);{% endif %}">
              {{ total_ca_net_cad|default_if_none:0|floatformat:2|intcomma }}
            </div>
            <div class="acct-small">Canada money in minus money out.</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="acct-card">
          <div class="card-body p-3">
            <div class="acct-label">Bangladesh net BDT</div>
            <div class="acct-value" style="{% if total_bd_net_bdt and total_bd_net_bdt < 0 %}color:var(--bad);{% else %}color:var(--good);{% endif %}">
              {{ total_bd_net_bdt|default_if_none:0|floatformat:2|intcomma }}
            </div>
            <div class="acct-small">Bangladesh money in minus money out.</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="acct-card">
          <div class="card-body p-3">
            <div class="acct-label">Total income CAD</div>
            <div class="acct-value">
              {{ total_income_cad|default_if_none:0|floatformat:2|intcomma }}
            </div>
            <div class="acct-small">Income and transfers coming in.</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="acct-card">
          <div class="card-body p-3">
            <div class="acct-label">Total expense and COGS CAD</div>
            <div class="acct-value" style="color:var(--bad);">
              {{ total_expense_cad|default_if_none:0|floatformat:2|intcomma }}
            </div>
            <div class="acct-small">All expenses and cost of goods.</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="acct-card">
          <div class="card-body p-3">
            <div class="acct-label">Production gross margin</div>
            <div class="acct-value" style="color:var(--good);">
              {{ gross_margin_pct|default_if_none:0|floatformat:1 }} %
            </div>
            <div class="acct-small">
              Profit: {{ gross_profit_cad|default_if_none:0|floatformat:2|intcomma }} CAD<br>
              Revenue: {{ revenue_cad|default_if_none:0|floatformat:2|intcomma }} CAD<br>
              COGS: {{ cogs_cad|default_if_none:0|floatformat:2|intcomma }} CAD
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="acct-card mb-3">
      <div class="card-body p-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2" style="margin-bottom:10px;">
          {% with qs=request.GET.urlencode %}
            <div class="pillbar">
              <a class="pill pill-gold" href="{% url 'accounting_list_export_csv' %}{% if qs %}?{{ qs }}{% endif %}">Export CSV</a>
              <a class="pill pill-gold" href="{% url 'accounting_list_export_xlsx' %}{% if qs %}?{{ qs }}{% endif %}">Export Excel</a>
              <button type="button" class="pill" id="toggleFilesBtn">Files</button>
              <a class="pill" href="{% url 'accounting_entry_list' %}">Reset</a>
            </div>
          {% endwith %}
        </div>

        <form method="get" class="row g-2 align-items-end" style="font-size:13px; font-weight:800;">
          <div class="col-sm-2">
            <label class="form-label mb-1" style="color:#ffffff; font-weight:900;">Year</label>
            <input type="text" name="year" value="{{ filter_year }}" class="form-control form-control-sm acct-input" placeholder="2025">
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1" style="color:#ffffff; font-weight:900;">Month</label>
            <select name="month" class="form-select form-select-sm acct-input">
              <option value="" {% if not filter_month %}selected{% endif %}>All</option>
              <option value="1" {% if filter_month|stringformat:"s" == "1" %}selected{% endif %}>Jan</option>
              <option value="2" {% if filter_month|stringformat:"s" == "2" %}selected{% endif %}>Feb</option>
              <option value="3" {% if filter_month|stringformat:"s" == "3" %}selected{% endif %}>Mar</option>
              <option value="4" {% if filter_month|stringformat:"s" == "4" %}selected{% endif %}>Apr</option>
              <option value="5" {% if filter_month|stringformat:"s" == "5" %}selected{% endif %}>May</option>
              <option value="6" {% if filter_month|stringformat:"s" == "6" %}selected{% endif %}>Jun</option>
              <option value="7" {% if filter_month|stringformat:"s" == "7" %}selected{% endif %}>Jul</option>
              <option value="8" {% if filter_month|stringformat:"s" == "8" %}selected{% endif %}>Aug</option>
              <option value="9" {% if filter_month|stringformat:"s" == "9" %}selected{% endif %}>Sep</option>
              <option value="10" {% if filter_month|stringformat:"s" == "10" %}selected{% endif %}>Oct</option>
              <option value="11" {% if filter_month|stringformat:"s" == "11" %}selected{% endif %}>Nov</option>
              <option value="12" {% if filter_month|stringformat:"s" == "12" %}selected{% endif %}>Dec</option>
            </select>
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1" style="color:#ffffff; font-weight:900;">Side</label>
            <select name="side" class="form-select form-select-sm acct-input">
              <option value="ALL" {% if filter_side == "ALL" or not filter_side %}selected{% endif %}>All</option>
              <option value="CA" {% if filter_side == "CA" %}selected{% endif %}>Canada</option>
              <option value="BD" {% if filter_side == "BD" %}selected{% endif %}>Bangladesh</option>
            </select>
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1" style="color:#ffffff; font-weight:900;">Main type</label>
            <select name="main_type" class="form-select form-select-sm acct-input">
              <option value="ALL" {% if filter_main_type == "ALL" or not filter_main_type %}selected{% endif %}>All</option>
              <option value="INCOME" {% if filter_main_type == "INCOME" %}selected{% endif %}>Income</option>
              <option value="COGS" {% if filter_main_type == "COGS" %}selected{% endif %}>COGS</option>
              <option value="EXPENSE" {% if filter_main_type == "EXPENSE" %}selected{% endif %}>Expense</option>
              <option value="TRANSFER" {% if filter_main_type == "TRANSFER" %}selected{% endif %}>Transfer</option>
              <option value="TAX" {% if filter_main_type == "TAX" %}selected{% endif %}>Tax</option>
              <option value="OTHER" {% if filter_main_type == "OTHER" %}selected{% endif %}>Other</option>
            </select>
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1" style="color:#ffffff; font-weight:900;">Search</label>
            <input type="text" name="q" value="{{ filter_q }}" class="form-control form-control-sm acct-input" placeholder="order, note, desc">
          </div>

          <div class="col-sm-2 d-flex gap-2">
            <button type="submit" class="btn btn-warning btn-sm w-100 mt-3 rounded-pill" style="font-weight:900;">
              Apply
            </button>
          </div>
        </form>

        <div class="acct-subtitle" style="margin-top:8px;">Filters change the list and totals.</div>
      </div>
    </div>

    <div class="acct-card" id="entriesTableBox">
      <div class="card-header py-2" style="border-bottom:1px solid #1f2937;">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span class="section-title">Accounting entries</span>
          <span class="section-note">Showing {{ entries|length }} records</span>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-sm mb-0 acct-table" style="font-size:12px;">
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th class="nowrap">Side</th>
              <th class="nowrap">Flow</th>
              <th class="nowrap">Main type</th>
              <th class="nowrap">Sub type</th>
              <th>Description</th>
              <th class="nowrap">Curr</th>
              <th class="text-end nowrap">Original</th>
              <th class="text-end nowrap">CAD</th>
              <th class="text-end nowrap">BDT</th>
              <th class="nowrap">Order</th>
              <th class="nowrap">Files</th>
              {% if request.user|in_group:"CA" or request.user|in_group:"Canada" or request.user.is_superuser %}
                <th class="nowrap">Edit</th>
              {% endif %}
              {% if request.user.is_superuser %}
                <th class="nowrap">Delete</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
          {% if entries %}
            {% for e in entries %}
              {% with file_count=e.attachments.count %}
              <tr>
                <td class="nowrap">{{ e.date|date:"Y-m-d" }}</td>

                <td class="nowrap">
                  {% if e.side == "CA" %}
                    <span class="badge rounded-pill text-bg-primary">CA</span>
                  {% elif e.side == "BD" %}
                    <span class="badge rounded-pill text-bg-info">BD</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-secondary">{{ e.side }}</span>
                  {% endif %}
                </td>

                <td class="nowrap">
                  {% if e.direction == "IN" %}
                    <span class="badge rounded-pill text-bg-success">In</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-danger">Out</span>
                  {% endif %}
                </td>

                <td class="nowrap">
                  {% if e.main_type == "INCOME" %}
                    <span class="badge rounded-pill text-bg-success">Income</span>
                  {% elif e.main_type == "COGS" %}
                    <span class="badge rounded-pill text-bg-warning text-dark">COGS</span>
                  {% elif e.main_type == "EXPENSE" %}
                    <span class="badge rounded-pill text-bg-danger">Expense</span>
                  {% elif e.main_type == "TRANSFER" %}
                    <span class="badge rounded-pill text-bg-secondary">Transfer</span>
                  {% elif e.main_type == "TAX" %}
                    <span class="badge rounded-pill text-bg-secondary">Tax</span>
                  {% else %}
                    <span class="badge rounded-pill text-bg-dark">{{ e.main_type }}</span>
                  {% endif %}
                </td>

                <td class="nowrap">{{ e.sub_type|default:"" }}</td>
                <td class="descWrap">{{ e.description|default:"" }}</td>

                <td class="nowrap">{{ e.currency|default:"" }}</td>

                <td class="text-end nowrap">{{ e.amount_original|default_if_none:0|floatformat:2|intcomma }}</td>
                <td class="text-end nowrap">{{ e.amount_cad|default_if_none:0|floatformat:2|intcomma }}</td>
                <td class="text-end nowrap">{{ e.amount_bdt|default_if_none:0|floatformat:2|intcomma }}</td>

                <td class="nowrap">
                  {% if e.production_order %}
                    {{ e.production_order.order_code }}
                  {% else %}
                    <span style="color:var(--muted);">-</span>
                  {% endif %}
                </td>

                <td class="nowrap">
                  {% if file_count > 0 %}
                    <button
                      type="button"
                      class="filePill js-file-toggle"
                      data-target="files_{{ e.id }}"
                      aria-controls="files_{{ e.id }}"
                      aria-expanded="false"
                    >
                      View {{ file_count }}
                    </button>

                    <div class="collapse js-file-box" id="files_{{ e.id }}">
                      <div class="fileListBox">
                        {% for a in e.attachments.all %}
                          <div class="fileRow">
                            <div class="fileName">{{ a.original_name|default:"File" }}</div>
                            <div class="nowrap">
                              <a class="linkGold" href="{{ a.file.url }}" target="_blank" rel="noopener">Open</a>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% else %}
                    <span style="color:var(--muted);">-</span>
                  {% endif %}
                </td>

                {% if request.user|in_group:"CA" or request.user|in_group:"Canada" or request.user.is_superuser %}
                  <td class="nowrap">
                    <a href="{% url 'accounting_entry_edit' e.pk %}" class="btn btn-outline-light btn-sm rounded-pill" style="font-weight:900;">
                      Edit
                    </a>
                  </td>
                {% endif %}

                {% if request.user.is_superuser %}
                  <td class="nowrap">
                    <form method="post" action="{% url 'accounting_entry_delete' e.pk %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill" style="font-weight:900;"
                              onclick="return confirm('Delete this entry? This cannot be undone.')">
                        Delete
                      </button>
                    </form>
                  </td>
                {% endif %}
              </tr>
              {% endwith %}
            {% endfor %}
          {% else %}
            <tr>
              <td
                colspan="{% if request.user.is_superuser %}14{% elif request.user|in_group:'CA' or request.user|in_group:'Canada' %}13{% else %}12{% endif %}"
                class="text-center py-3"
                style="color:var(--muted); font-weight:800;"
              >
                No accounting entries yet.
              </td>
            </tr>
          {% endif %}
          </tbody>

          <tfoot>
            <tr style="background:var(--bg2); font-weight:900;">
              <td colspan="8" class="text-end" style="color:var(--text);">Net totals for this view</td>
              <td class="text-end nowrap" style="color:var(--text);">{{ net_cad|default_if_none:0|floatformat:2|intcomma }}</td>
              <td class="text-end nowrap" style="color:var(--text);">{{ net_bdt|default_if_none:0|floatformat:2|intcomma }}</td>
              <td
                colspan="{% if request.user.is_superuser %}4{% elif request.user|in_group:'CA' or request.user|in_group:'Canada' %}3{% else %}2{% endif %}"
                style="color:var(--muted); font-weight:800;"
              >
                Money in minus money out.
              </td>
            </tr>
          </tfoot>

        </table>
      </div>
    </div>

    <div class="acct-subtitle" style="margin-top:10px;">
      For year end, pick a year and side at the top. Export the list to review.
    </div>

  </div>
</div>

<script>
  (function(){
    function toggleOne(id){
      var el = document.getElementById(id);
      if(!el) return false;

      var isOpen = el.classList.contains("show");
      if(isOpen) el.classList.remove("show");
      else el.classList.add("show");

      return !isOpen;
    }

    document.addEventListener("click", function(e){
      var btn = e.target.closest(".js-file-toggle");
      if(!btn) return;

      var id = btn.getAttribute("data-target");
      if(!id) return;

      var opened = toggleOne(id);
      btn.setAttribute("aria-expanded", opened ? "true" : "false");
    });

    var expanded = false;
    var btnAll = document.getElementById("toggleFilesBtn");
    if(!btnAll) return;

    btnAll.addEventListener("click", function(){
      expanded = !expanded;

      var nodes = document.querySelectorAll(".js-file-box");
      for(var i=0;i<nodes.length;i++){
        if(expanded) nodes[i].classList.add("show");
        else nodes[i].classList.remove("show");
      }

      var toggles = document.querySelectorAll(".js-file-toggle");
      for(var j=0;j<toggles.length;j++){
        toggles[j].setAttribute("aria-expanded", expanded ? "true" : "false");
      }

      var box = document.getElementById("entriesTableBox");
      if(box) box.scrollIntoView({behavior:"smooth", block:"start"});
    });
  })();
</script>

{% endblock %}