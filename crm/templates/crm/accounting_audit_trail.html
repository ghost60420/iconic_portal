{% extends "crm/base.html" %}
{% load humanize %}
{% block content %}

<style>
  :root{
    --bg:#020617;
    --bg2:#030712;
    --line:#374151;
    --line2:#111827;
    --text:#f9fafb;
    --muted:#cbd5e1;
    --gold1:#f5d580;
    --gold2:#d4b35f;
  }

  .wrap{ max-width:1400px; margin:0 auto; color:var(--text); }
  .cardx{
    background:var(--bg);
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
  }

  .pill{
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    padding:8px 14px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid var(--line);
    background:linear-gradient(145deg,#0f172a,var(--bg));
    color:var(--text);
    box-shadow:0 3px 0 #020617;
    white-space:nowrap;
  }
  .pill-gold{
    background:linear-gradient(145deg,var(--gold1),var(--gold2));
    color:#050505;
    border:1px solid #e5c670;
    box-shadow:0 3px 0 #8a6b24;
  }

  .inputx{
    background:var(--bg2) !important;
    border-color:#4b5563 !important;
    color:var(--text) !important;
    font-weight:800;
  }
  .inputx::placeholder{ color:#94a3b8; font-weight:800; }

  .muted{ color:var(--muted); font-weight:700; }
  .nowrap{ white-space:nowrap; }

  .acct-table{ color:var(--text) !important; }
  .acct-table th{
    color:var(--text) !important;
    font-weight:900 !important;
    white-space:nowrap;
    border-color:var(--line2) !important;
  }
  .acct-table td{
    color:var(--text) !important;
    vertical-align:middle;
    border-color:var(--line2) !important;
    font-weight:750;
  }

  .descWrap{
    white-space:normal;
    word-break:break-word;
    line-height:1.25;
    max-width:520px;
  }
  .noteWrap{
    white-space:normal;
    word-break:break-word;
    line-height:1.25;
    max-width:420px;
    color:#e5e7eb;
  }
  .badge{ font-weight:900 !important; }

  .actionBadge{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid var(--line);
    background:#0b1220;
    color:var(--text);
  }
</style>

<div class="container-fluid">
  <div class="wrap">

    <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap gap-2">
      <div>
        <h2 style="font-weight:900; margin:0;">Audit trail</h2>
        <div class="muted" style="font-size:12px; margin-top:6px;">
          Create, update, delete, and files history.
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap">
        <a href="{% url 'accounting_entry_list' %}" class="pill">All entries</a>
        <a href="{% url 'accounting_ai_audit' %}" class="pill">AI audit</a>
      </div>
    </div>

    <div class="cardx mb-3">
      <div class="card-body p-3">
        <form method="get" class="row g-2 align-items-end" style="font-size:13px; font-weight:800;">

          <div class="col-sm-5">
            <label class="form-label mb-1" style="color:#fff; font-weight:900;">Search</label>
            <input
              name="q"
              value="{{ filter_q }}"
              class="form-control form-control-sm inputx"
              placeholder="entry, note, user, description"
            >
          </div>

          <div class="col-sm-3">
            <label class="form-label mb-1" style="color:#fff; font-weight:900;">Action</label>
            <select name="action" class="form-select form-select-sm inputx">
              <option value="ALL" {% if filter_action == "ALL" or not filter_action %}selected{% endif %}>All</option>
              <option value="CREATE" {% if filter_action == "CREATE" %}selected{% endif %}>Create</option>
              <option value="UPDATE" {% if filter_action == "UPDATE" %}selected{% endif %}>Update</option>
              <option value="DELETE" {% if filter_action == "DELETE" %}selected{% endif %}>Delete</option>
              <option value="FILES" {% if filter_action == "FILES" %}selected{% endif %}>Files</option>
            </select>
          </div>

          <div class="col-sm-2">
            <button class="pill pill-gold w-100" type="submit" style="justify-content:center; margin-top:22px;">
              Apply
            </button>
          </div>

          <div class="col-sm-2">
            <a href="{% url 'accounting_audit_trail' %}" class="pill w-100" style="justify-content:center; margin-top:22px;">
              Reset
            </a>
          </div>

        </form>
      </div>
    </div>

    <div class="cardx">
      <div class="card-header py-2" style="border-bottom:1px solid var(--line2);">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div style="font-weight:900;">Logs</div>
          <div class="muted" style="font-size:12px;">
            Showing
            {% with data=rows|default:audits %}
              {% if data %}{{ data|length }}{% else %}0{% endif %}
            {% endwith %}
            records
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-sm mb-0 acct-table" style="font-size:12px;">
          <thead>
            <tr>
              <th class="nowrap">Time</th>
              <th class="nowrap">Action</th>
              <th class="nowrap">User</th>
              <th>Entry</th>
              <th>Note</th>
              <th class="nowrap">Edit</th>
            </tr>
          </thead>

          <tbody>
            {% with data=rows|default:audits %}
              {% if data %}
                {% for r in data %}
                  <tr>
                    <td class="nowrap">{{ r.changed_at|date:"Y-m-d H:i" }}</td>

                    <td class="nowrap">
                      {% if r.action == "CREATE" %}
                        <span class="badge rounded-pill text-bg-success">Create</span>
                      {% elif r.action == "UPDATE" %}
                        <span class="badge rounded-pill text-bg-warning text-dark">Update</span>
                      {% elif r.action == "DELETE" %}
                        <span class="badge rounded-pill text-bg-danger">Delete</span>
                      {% elif r.action == "FILES" %}
                        <span class="badge rounded-pill text-bg-info text-dark">Files</span>
                      {% else %}
                        <span class="actionBadge">{{ r.action }}</span>
                      {% endif %}
                    </td>

                    <td class="nowrap">
                      {% if r.changed_by %}{{ r.changed_by.username }}{% else %}-{% endif %}
                    </td>

                    <td class="descWrap">
                      {% if r.entry %}
                        {{ r.entry.description|default:"" }}
                      {% else %}
                        <span class="muted">-</span>
                      {% endif %}
                    </td>

                    <td class="noteWrap">{{ r.note|default:"" }}</td>

                    <td class="nowrap">
                      {% if r.entry %}
                        <a href="{% url 'accounting_entry_edit' r.entry.pk %}" class="btn btn-outline-light btn-sm rounded-pill" style="font-weight:900;">
                          Edit
                        </a>
                      {% else %}
                        <span class="muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="text-center py-3" style="color:var(--muted); font-weight:800;">
                    No logs yet.
                  </td>
                </tr>
              {% endif %}
            {% endwith %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

{% endblock %}