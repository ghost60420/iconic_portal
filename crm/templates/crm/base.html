{% load static %}
{% load crm_groups %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Iconic CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#060606;
      --panel:#0b0d10;
      --panel2:#0f172a;
      --border:#2a2f38;
      --text:#f8f9fa;
      --muted:#a8b0bd;

      --brand-1:#ffe39b;
      --brand-2:#f59e0b;
      --brand-3:#60a5fa;
    }

    body{
      background:var(--bg);
      color:var(--text);
      font-family: Arial, sans-serif;
    }

    a{ color:#f5d580; text-decoration:none; }
    a:hover{ color:#ffe9a8; }

    .crm-topbar{
      background: linear-gradient(180deg, rgba(12,17,26,0.98), rgba(5,8,14,0.92));
      border-bottom: 1px solid var(--border);
      padding: 10px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-size:14px;
      position: sticky;
      top: 0;
      z-index: 2000;
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.55);
      overflow: visible;
    }

    .crm-nav-group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .crm-nav-item{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 14px;
      border-radius:12px;
      font-size:13px;
      font-weight:800;
      border: 1px solid rgba(148,163,184,0.20);
      background: rgba(15,23,42,0.65);
      color: #f3f4f6;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease, color 0.12s ease;
      white-space: nowrap;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }

    .crm-nav-item span{ font-size:15px; }

    .crm-nav-item:hover{
      transform: translateY(-1px);
      background: rgba(30,41,59,0.7);
      border-color: rgba(96,165,250,0.35);
      color:#e0f2fe;
      text-decoration:none;
    }

    .crm-nav-item:active{ transform: translateY(0px); }

    .crm-nav-item.hot{
      border-color: rgba(96,165,250,0.35);
      background: rgba(59,130,246,0.12);
      color:#dbeafe;
    }

    .crm-nav-item.primary{
      border-color: rgba(245, 213, 128, 0.55);
      background: linear-gradient(140deg, var(--brand-1), var(--brand-2));
      color:#111827;
      box-shadow: 0 10px 24px rgba(245, 213, 128, 0.25);
    }

    .crm-nav-item.primary:hover{
      background: linear-gradient(140deg, #ffe8a8, #f59e0b);
      color:#111827;
      border-color: rgba(245, 213, 128, 0.75);
    }

    .crm-nav-item:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(96,165,250,0.22), 0 10px 20px rgba(0,0,0,0.35);
    }

    .crm-nav-item:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(96,165,250,0.25), 0 10px 20px rgba(0,0,0,0.35);
    }

    .crm-nav-item.is-disabled{
      opacity: 0.55;
      cursor: default;
      pointer-events: none;
    }

    @media (prefers-reduced-motion: reduce){
      .crm-nav-item{
        transition: none;
      }
      .crm-nav-item:hover{
        transform: none;
      }
    }

    .crm-spacer{ flex: 1 1 auto; }
    .crm-wrapper{ padding:16px 20px 40px 20px; }

    .crm-dropdown{
      position:relative;
      display:inline-flex;
      align-items:center;
    }

    .crm-dropdown-menu{
      position:absolute;
      top: calc(100% + 10px);
      left:0;
      min-width:270px;
      padding:10px;
      border-radius:14px;
      background: linear-gradient(145deg, #0f172a, #020617);
      border: 1px solid #334155;
      box-shadow: 0 16px 30px rgba(0,0,0,0.65);

      display:block;
      opacity:0;
      visibility:hidden;
      pointer-events:none;
      transform: translateY(6px);
      transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s ease;

      z-index:30000;
    }

    .crm-dropdown:hover .crm-dropdown-menu,
    .crm-dropdown.is-open .crm-dropdown-menu{
      opacity:1;
      visibility:visible;
      pointer-events:auto;
      transform: translateY(0);
    }

    .crm-dropdown-menu::before{
      content:"";
      position:absolute;
      left:0;
      top:-14px;
      height:14px;
      width:100%;
    }

    .crm-dd-title{
      font-size:11px;
      color:#cbd5e1;
      font-weight:900;
      margin:0 0 8px 2px;
    }

    .crm-dd-item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      color:#ffffff;
      border:1px solid transparent;
      background: rgba(255,255,255,0.04);
      transition: all 0.15s ease;
      margin-bottom:8px;
      font-weight:900;
      font-size:13px;
    }

    .crm-dd-item:hover{
      background: rgba(245, 213, 128, 0.12);
      border-color: rgba(245, 213, 128, 0.28);
      color:#ffe9a8;
      transform: translateY(-1px);
    }

    .crm-dd-item:last-child{ margin-bottom:0; }

    .crm-dd-hint{
      font-size:11px;
      color:#e5e7eb;
      margin-top:6px;
      line-height:1.3;
      font-weight:800;
    }

    .crm-userbox{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .crm-username{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,0.22);
      background: rgba(255,255,255,0.03);
      color:#e5e7eb;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }

    .crm-logout-form{ margin:0; }

    @media (max-width: 768px){
      .crm-dropdown-menu{
        left:auto;
        right:0;
        min-width:240px;
      }
      .crm-topbar{
        padding: 10px 10px;
      }
      .crm-wrapper{
        padding:14px 12px 34px 12px;
      }
      .crm-nav-item{
        padding:8px 12px;
        border-radius:12px;
      }
    }
  </style>
</head>

<body>

  {% if request.user.is_authenticated %}

    {% url 'leads_list' as leads_url %}
    {% url 'opportunities_list' as opp_url %}
    {% url 'cost_sheet_list' as cost_url %}
    {% url 'customers_list' as cust_url %}
    {% url 'calendar_list' as cal_url %}
    {% url 'production_list' as prod_url %}
    {% url 'shipment_list' as ship_url %}
    {% url 'main_dashboard' as main_dash_url %}
    {% url 'ai_hub' as ai_hub_url %}
    {% url 'inventory_list' as inv_url %}
    {% url 'marketing_dashboard' as marketing_url %}
    {% url 'world_tools' as world_tools_url %}
    {% url 'world_dashboard' as world_dash_url %}
    {% url 'world_ai_fashion_news' as world_ai_url %}
    {% url 'email_sync_dashboard' as email_sync_url %}
    {% url 'accounting_home' as acc_home_url %}
    {% url 'invoice_list' as invoice_list_url %}
    {% url 'logout' as logout_url %}
    {% url 'access_list' as access_url %}
    {% url 'admin:index' as admin_url %}

    {% if WHATSAPP_ENABLED %}
      {% if request.user.is_superuser or request.user.access.can_whatsapp %}
        {% url 'wa_inbox' as wa_url %}
      {% endif %}
    {% endif %}

    {% url 'library_home' as library_home_url %}
    {% url 'products_list' as products_url %}
    {% url 'fabrics_list' as fabrics_url %}
    {% url 'accessories_list' as accessories_url %}
    {% url 'trims_list' as trims_url %}
    {% url 'threads_list' as threads_url %}

    <div class="crm-topbar">

      <div class="crm-nav-group">

        {% if main_dash_url %}
          <a href="{{ main_dash_url }}" class="crm-nav-item primary"><span>ğŸ </span><strong>CRM</strong></a>
        {% elif leads_url %}
          <a href="{{ leads_url }}" class="crm-nav-item primary"><span>ğŸ </span><strong>CRM</strong></a>
        {% endif %}

        {% if leads_url %}
          <a href="{{ leads_url }}" class="crm-nav-item hot"><span>ğŸ§²</span><strong>Leads</strong></a>
        {% endif %}

        {% if opp_url %}
          <a href="{{ opp_url }}" class="crm-nav-item hot"><span>ğŸ“ˆ</span><strong>Opportunities</strong></a>
        {% endif %}

        {% if cost_url %}
          <a href="{{ cost_url }}" class="crm-nav-item"><span>ğŸ§®</span><strong>Costing</strong></a>
        {% endif %}

        {% if cust_url %}
          <a href="{{ cust_url }}" class="crm-nav-item hot"><span>ğŸ‘¥</span><strong>Customers</strong></a>
        {% endif %}

        {% if cal_url %}
          <a href="{{ cal_url }}" class="crm-nav-item"><span>ğŸ“…</span><strong>Calendar</strong></a>
        {% endif %}

        {% if prod_url %}
          <a href="{{ prod_url }}" class="crm-nav-item"><span>ğŸ­</span><strong>Production</strong></a>
        {% endif %}

        {% if ship_url %}
          <a href="{{ ship_url }}" class="crm-nav-item"><span>ğŸ“¦</span><strong>Shipping</strong></a>
        {% endif %}

        {% if MARKETING_ENABLED and marketing_url %}
          {% if request.user.is_authenticated %}
            {% if request.user.is_superuser or request.user.access.can_marketing %}
              <a href="{{ marketing_url }}" class="crm-nav-item"><span>ğŸ“£</span><strong>Marketing</strong></a>
            {% endif %}
          {% endif %}
        {% endif %}

        {% if wa_url %}
          <a href="{{ wa_url }}" class="crm-nav-item"><span>ğŸ’¬</span><strong>WhatsApp</strong></a>
        {% endif %}

        {% if ai_hub_url and request.user.is_authenticated %}
          {% if request.user.is_superuser or request.user.access.can_ai %}
            <a href="{{ ai_hub_url }}" class="crm-nav-item"><span>ğŸ¤–</span><strong>AI</strong></a>
          {% endif %}
        {% endif %}

      </div>

      <div class="crm-nav-group">

        {# FIX: Always show Library menu, do not depend on request.user.access #}
        <div class="crm-dropdown" id="libraryDropdown">
          <a
            href="{% if library_home_url %}{{ library_home_url }}{% else %}#{% endif %}"
            class="crm-nav-item {% if not library_home_url %}is-disabled{% endif %}"
            id="libraryBtn"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <span>ğŸ“š</span><strong>Library</strong>
          </a>

          <div class="crm-dropdown-menu" id="libraryMenu" role="menu">
            <div class="crm-dd-title">Library</div>

            {% if products_url %}<a class="crm-dd-item" href="{{ products_url }}">ğŸ‘• Products</a>{% endif %}
            {% if fabrics_url %}<a class="crm-dd-item" href="{{ fabrics_url }}">ğŸ§µ Fabrics</a>{% endif %}
            {% if accessories_url %}<a class="crm-dd-item" href="{{ accessories_url }}">ğŸ§· Accessories</a>{% endif %}
            {% if trims_url %}<a class="crm-dd-item" href="{{ trims_url }}">ğŸ€ Trims</a>{% endif %}
            {% if threads_url %}<a class="crm-dd-item" href="{{ threads_url }}">ğŸª¡ Threads</a>{% endif %}

            <div class="crm-dd-hint">
              All product and material lists in one place.
            </div>
          </div>
        </div>

        {% if inv_url %}
          <a href="{{ inv_url }}" class="crm-nav-item"><span>ğŸ“¦</span><strong>Inventory</strong></a>
        {% endif %}

        {% if access_url %}
          <a href="{{ access_url }}" class="crm-nav-item"><span>ğŸ”</span><strong>Access</strong></a>
        {% endif %}

        {% if request.user.is_superuser and admin_url %}
          <a href="{{ admin_url }}" class="crm-nav-item"><span>ğŸ› ï¸</span><strong>Admin</strong></a>
        {% endif %}

        <div class="crm-dropdown" id="worldDropdown">
          <a
            href="{% if world_tools_url %}{{ world_tools_url }}{% else %}#{% endif %}"
            class="crm-nav-item {% if not world_tools_url %}is-disabled{% endif %}"
            id="worldBtn"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <span>ğŸŒ</span><strong>World</strong>
          </a>

          <div class="crm-dropdown-menu" id="worldMenu" role="menu">
            <div class="crm-dd-title">World shortcuts</div>

            {% if world_tools_url %}<a class="crm-dd-item" href="{{ world_tools_url }}">ğŸ§° World tools</a>{% endif %}
            {% if world_dash_url %}<a class="crm-dd-item" href="{{ world_dash_url }}">ğŸ“Š World dashboard</a>{% endif %}
            {% if world_ai_url %}<a class="crm-dd-item" href="{{ world_ai_url }}">ğŸ§  AI fashion notes</a>{% endif %}

            <div class="crm-dd-hint">
              Quick access to world pages.
            </div>
          </div>
        </div>

        {% if email_sync_url %}
          <a href="{{ email_sync_url }}" class="crm-nav-item"><span>ğŸ“¨</span><strong>Email Sync</strong></a>
        {% endif %}

        <div class="crm-dropdown" id="accountingDropdown">
          <a
            href="{% if acc_home_url %}{{ acc_home_url }}{% else %}#{% endif %}"
            class="crm-nav-item hot {% if not acc_home_url %}is-disabled{% endif %}"
            id="accountingBtn"
            aria-haspopup="true"
            aria-expanded="false"
          >
            <span>ğŸ’°</span><strong>Accounting</strong>
          </a>

          <div class="crm-dropdown-menu" id="accountingMenu" role="menu">
            <div class="crm-dd-title">Accounting shortcuts</div>

            {% if invoice_list_url %}<a class="crm-dd-item" href="{{ invoice_list_url }}">ğŸ§¾ Invoices</a>{% endif %}

            {% if user|is_ca %}
              {% url 'accounting_entry_list' as acc_all_entries_url %}
              {% url 'accounting_ca_master' as acc_ca_master_url %}
              {% url 'accounting_ca_grid' as acc_ca_grid_url %}
              {% if acc_all_entries_url %}<a class="crm-dd-item" href="{{ acc_all_entries_url }}">ğŸŒ All entries</a>{% endif %}
              {% if acc_ca_master_url %}<a class="crm-dd-item" href="{{ acc_ca_master_url }}">ğŸ’¸ Money transfer</a>{% endif %}
              {% if acc_ca_grid_url %}<a class="crm-dd-item" href="{{ acc_ca_grid_url }}">ğŸ§¾ Canada grid</a>{% endif %}
            {% endif %}

            {% url 'accounting_bd_dashboard' as acc_bd_dash_url %}
            {% url 'accounting_bd_grid' as acc_bd_grid_url %}
            {% url 'accounting_bd_daily' as acc_bd_daily_url %}
            {% url 'accounting_entry_add_bd' as acc_add_bd_url %}
            {% url 'accounting_entry_add_ca' as acc_add_ca_url %}
            {% url 'bd_staff_list' as bd_staff_list_url %}
            {% url 'bd_staff_month_list' as bd_payroll_months_url %}
            {% url 'bd_staff_add' as bd_staff_add_url %}

            {% if acc_bd_dash_url %}<a class="crm-dd-item" href="{{ acc_bd_dash_url }}">ğŸ‡§ğŸ‡© Bangladesh dashboard</a>{% endif %}
            {% if acc_bd_grid_url %}<a class="crm-dd-item" href="{{ acc_bd_grid_url }}">ğŸ§¾ Bangladesh grid</a>{% endif %}
            {% if acc_bd_daily_url %}<a class="crm-dd-item" href="{{ acc_bd_daily_url }}">ğŸ“… Bangladesh daily sheet</a>{% endif %}

            {% if acc_add_bd_url %}<a class="crm-dd-item" href="{{ acc_add_bd_url }}">â• Add Bangladesh entry</a>{% endif %}
            {% if acc_add_ca_url %}<a class="crm-dd-item" href="{{ acc_add_ca_url }}">â• Add Canada entry</a>{% endif %}

            {% if bd_staff_list_url %}<a class="crm-dd-item" href="{{ bd_staff_list_url }}">ğŸ‘¥ Bangladesh staff</a>{% endif %}
            {% if bd_payroll_months_url %}<a class="crm-dd-item" href="{{ bd_payroll_months_url }}">ğŸ§¾ BD payroll months</a>{% endif %}
            {% if bd_staff_add_url %}<a class="crm-dd-item" href="{{ bd_staff_add_url }}">â• Add BD staff</a>{% endif %}

            <div class="crm-dd-hint">
              BD users see BD pages. CA users see master pages too.
            </div>
          </div>
        </div>

      </div>

      <div class="crm-spacer"></div>

      <div class="crm-userbox">
        <div class="crm-username">
          <span>ğŸ‘¤</span> {{ request.user.get_username }}
        </div>

        {% if logout_url %}
          <form method="post" action="{{ logout_url }}" class="crm-logout-form">
            {% csrf_token %}
            <button type="submit" class="crm-nav-item">
              <span>ğŸšª</span><strong>Logout</strong>
            </button>
          </form>

          <noscript>
            <a href="{{ logout_url }}" class="crm-nav-item"><span>ğŸšª</span><strong>Logout</strong></a>
          </noscript>
        {% endif %}
      </div>

    </div>
  {% endif %}

  <div class="crm-wrapper">
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function () {
      function setupDropdown(dropdownId, btnId) {
        const dd = document.getElementById(dropdownId);
        const btn = document.getElementById(btnId);
        if (!dd || !btn) return;

        let closeTimer = null;

        function openMenu() {
          if (closeTimer) clearTimeout(closeTimer);
          dd.classList.add("is-open");
          btn.setAttribute("aria-expanded", "true");
        }

        function closeMenuDelayed() {
          if (closeTimer) clearTimeout(closeTimer);
          closeTimer = setTimeout(() => {
            dd.classList.remove("is-open");
            btn.setAttribute("aria-expanded", "false");
          }, 250);
        }

        function closeMenuNow() {
          if (closeTimer) clearTimeout(closeTimer);
          dd.classList.remove("is-open");
          btn.setAttribute("aria-expanded", "false");
        }

        dd.addEventListener("mouseenter", openMenu);
        dd.addEventListener("mouseleave", closeMenuDelayed);

        btn.addEventListener("click", function (e) {
          if (dd.classList.contains("is-disabled")) return;
          if (!dd.classList.contains("is-open")) {
            e.preventDefault();
            openMenu();
          }
        });

        document.addEventListener("click", function (e) {
          if (dd && !dd.contains(e.target)) closeMenuNow();
        });

        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") closeMenuNow();
        });
      }

      setupDropdown("accountingDropdown", "accountingBtn");
      setupDropdown("libraryDropdown", "libraryBtn");
      setupDropdown("worldDropdown", "worldBtn");
    })();
  </script>

</body>
</html>
