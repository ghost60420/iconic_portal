{% extends "crm/base.html" %}
{% load crm_groups %}
{% load humanize %}
{% block content %}

<div class="container-fluid" style="color:#f9fafb;">

  <style>
    :root{
      --bg:#020617;
      --bg2:#030712;
      --line:#374151;
      --line2:#111827;
      --text:#f9fafb;
      --muted:#cbd5e1;
      --good:#86efac;
      --bad:#ffb4b4;
      --gold1:#ffe39b;
      --gold2:#e4c067;
    }

    .wrap{ max-width:1400px; margin:0 auto; }

    .cardx{
      background:var(--bg);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 14px 34px rgba(0,0,0,0.38);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title{ margin:0; font-weight:900; letter-spacing:0.2px; }
    .subtitle{ font-size:12px; color:var(--muted); font-weight:700; margin-top:4px; }

    .pillbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,0.14);
      text-decoration:none;
      white-space:nowrap;
      background:linear-gradient(145deg,#111827,var(--bg));
      color:var(--text);
      box-shadow:0 3px 0 #020617;
      cursor:pointer;
    }
    .pill:hover{ filter:brightness(1.05); text-decoration:none; }
    .pill:focus{ outline:2px solid rgba(255,227,155,0.35); outline-offset:2px; }

    .pill-gold{
      background:linear-gradient(145deg,var(--gold1),var(--gold2));
      color:#121212;
      border-color:#f6d488;
      box-shadow:0 3px 0 #8a6b24;
    }

    .inp{
      background:var(--bg2) !important;
      border-color:#4b5563 !important;
      color:var(--text) !important;
      font-weight:800;
    }
    .inp::placeholder{ color:#94a3b8; font-weight:800; }

    .label{
      color:var(--text);
      font-weight:900;
      font-size:12px;
    }

    .kpi-label{
      font-size:11px;
      text-transform:uppercase;
      color:#e5e7eb;
      letter-spacing:0.45px;
      font-weight:900;
    }
    .kpi-val{
      font-size:22px;
      font-weight:900;
      line-height:1.15;
      word-break:break-word;
    }
    .kpi-sub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-top:6px;
      line-height:1.35;
    }

    .nowrap{ white-space:nowrap; }
    .wrapText{
      white-space:normal;
      word-break:break-word;
      line-height:1.25;
      color:var(--text);
      max-width:520px;
    }

    .tbl th{
      color:var(--text) !important;
      font-weight:900 !important;
      white-space:nowrap;
      border-color:var(--line2) !important;
    }
    .tbl td{
      color:var(--text) !important;
      font-weight:750;
      vertical-align:middle;
      border-color:var(--line2) !important;
    }

    .pos{ color:var(--good); font-weight:900; }
    .neg{ color:var(--bad); font-weight:900; }

    .linkGold{
      color:#ffe39b;
      font-weight:900;
      text-decoration:none;
    }
    .linkGold:hover{ text-decoration:underline; }

    .filePill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #475569;
      background:#0b1220;
      color:var(--text);
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      cursor:pointer;
    }
    .fileListBox{
      margin-top:8px;
      padding:10px 12px;
      border:1px solid #334155;
      border-radius:12px;
      background:var(--bg2);
    }
    .fileRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:6px 0;
      border-bottom:1px solid var(--line2);
    }
    .fileRow:last-child{ border-bottom:none; }
    .fileName{
      color:#e5e7eb;
      font-weight:800;
      font-size:12px;
      word-break:break-word;
    }

    .ai-title{ font-size:14px; font-weight:900; color:var(--text); }
    .ai-sub{ font-size:11px; font-weight:700; color:var(--muted); }
    .ai-section-title{ font-size:12px; font-weight:900; color:var(--text); margin-bottom:6px; }
    .ai-list{ margin:0; padding-left:16px; font-size:12px; font-weight:800; color:#e5e7eb; }
    .ai-muted{ font-size:12px; font-weight:800; color:var(--muted); }
    .ai-good{ color:var(--good); font-weight:900; }
    .ai-bad{ color:var(--bad); font-weight:900; }

    .warnBox{
      border:1px solid #7f1d1d;
      background:#0b1220;
      border-radius:14px;
      padding:12px 14px;
    }
    .warnTitle{
      font-weight:900;
      font-size:12px;
      color:#ffb4b4;
      margin:0 0 6px 0;
    }
    .warnList{
      margin:0;
      padding-left:16px;
      font-size:12px;
      font-weight:800;
      color:#e5e7eb;
    }
  </style>

  <div class="wrap">

    <div class="topbar">
      <div>
        <h2 class="mb-1">Bangladesh Accounting Grids</h2>
        <div class="subtitle">Bangladesh money in and money out in BDT.</div>
      </div>

      <div class="pillbar">
        <a href="{% url 'accounting_bd_dashboard' %}" class="pill">Bangladesh dashboard</a>
        <a href="{% url 'accounting_bd_daily' %}" class="pill">Bangladesh daily</a>
        <a href="{% url 'bd_staff_list' %}" class="pill">Staff</a>
        <a href="{% url 'bd_staff_month_list' %}" class="pill">Payroll</a>

        <a href="{% url 'accounting_ai_audit' %}" class="pill pill-gold">AI audit</a>

        {% if request.user|in_group:"CA" or request.user.is_superuser %}
          <a href="{% url 'accounting_entry_add_bd' %}" class="pill pill-gold">Add entry</a>

        {% endif %}

        {% with qs=request.GET.urlencode %}
          <a href="{% url 'accounting_audit_trail' %}{% if qs %}?{{ qs }}{% endif %}" class="pill">Audit trail</a>
        {% endwith %}
      </div>
    </div>

    {% if warnings %}
      <div class="warnBox mb-3">
        <p class="warnTitle">Warnings</p>
        <ul class="warnList">
          {% for w in warnings %}
            <li>{{ w }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if ai_insights %}
      <div class="cardx mb-3">
        <div class="card-header py-2" style="border-bottom:1px solid #1f2937;">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span class="ai-title">AI insights</span>
            <span class="ai-sub">{{ ai_insights.month_label }}</span>
          </div>
        </div>

        <div class="card-body p-3">
          <div class="mb-3">
            <div class="ai-section-title">Biggest cost categories</div>
            {% if ai_insights.cost_top %}
              <ul class="ai-list">
                {% for c in ai_insights.cost_top %}
                  <li>
                    {{ c.main_type }}{% if c.sub_type %} / {{ c.sub_type }}{% endif %}
                    —
                    {% if c.total_bdt %}
                      {{ c.total_bdt|default_if_none:0|floatformat:2|intcomma }} BDT
                    {% else %}
                      {{ c.total|default_if_none:0|floatformat:2|intcomma }} BDT
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="ai-muted">No cost data for this period.</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <div class="ai-section-title">Unusual cost spikes vs last month</div>
            {% if ai_insights.spikes %}
              <ul class="ai-list">
                {% for s in ai_insights.spikes %}
                  <li>
                    {{ s.main_type }}{% if s.sub_type %} / {{ s.sub_type }}{% endif %}
                    <span class="ai-bad">
                      ↑
                      {% if s.increase_bdt %}
                        {{ s.increase_bdt|default_if_none:0|floatformat:2|intcomma }} BDT
                      {% else %}
                        {{ s.increase|default_if_none:0|floatformat:2|intcomma }} BDT
                      {% endif %}
                    </span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="ai-muted">No unusual spikes detected.</div>
            {% endif %}
          </div>

          <div>
            <div class="ai-section-title">Top 5 orders with negative profit</div>
            {% if ai_insights.neg_orders %}
              <ul class="ai-list">
                {% for r in ai_insights.neg_orders %}
                  <li class="ai-bad">
                    Order {{ r.order_code|default:r.order_id }} —
                    {{ r.profit_cad|default_if_none:0|floatformat:2|intcomma }} CAD
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="ai-good">No negative profit orders found.</div>
            {% endif %}
          </div>

        </div>
      </div>
    {% endif %}

    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="cardx">
          <div class="card-body p-3">
            <div class="kpi-label">Total money in</div>
            <div class="kpi-val pos">{{ total_in_bdt|default_if_none:0|floatformat:2|intcomma }} BDT</div>
            <div class="kpi-sub">All money coming in for this view.</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="cardx">
          <div class="card-body p-3">
            <div class="kpi-label">Total money out</div>
            <div class="kpi-val neg">{{ total_out_bdt|default_if_none:0|floatformat:2|intcomma }} BDT</div>
            <div class="kpi-sub">Total cost for this view.</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="cardx">
          <div class="card-body p-3">
            <div class="kpi-label">Net result</div>
            <div class="kpi-val {% if net_bdt and net_bdt < 0 %}neg{% else %}pos{% endif %}">
              {{ net_bdt|default_if_none:0|floatformat:2|intcomma }} BDT
            </div>
            <div class="kpi-sub">Money in minus money out.</div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="cardx">
          <div class="card-body p-3">
            <div class="kpi-label">Monthly target</div>

            <div class="kpi-val neg">
              {{ bd_monthly_target_bdt|default_if_none:0|floatformat:0|intcomma }} BDT
            </div>

            {% if filter_month %}
              {% if bd_over_target_bdt and bd_over_target_bdt > 0 %}
                <div class="kpi-sub" style="color:var(--good); font-weight:900;">
                  Extra achieved: {{ bd_over_target_bdt|default_if_none:0|floatformat:0|intcomma }} BDT
                </div>
              {% else %}
                <div class="kpi-sub">
                  Remaining: {{ bd_target_remaining_bdt|default_if_none:0|floatformat:0|intcomma }} BDT
                </div>
              {% endif %}

              {% if bd_target_percent != None %}
                <div class="kpi-sub">
                  Progress: {{ bd_target_percent|floatformat:0 }}%
                </div>
              {% endif %}

              {% if request.user|in_group:"CA,Canada" or request.user.is_superuser %}
                <form method="post" class="mt-2" style="display:flex; gap:10px; align-items:center;">
                  {% csrf_token %}
                  <input type="hidden" name="target_action" value="save_target">
                  <input
                    type="text"
                    name="target_bdt"
                    class="form-control form-control-sm inp"
                    style="max-width:180px;"
                    placeholder="Set target BDT"
                    value="{{ bd_monthly_target_bdt|default_if_none:0|floatformat:0 }}"
                  >
                  <button type="submit" class="pill pill-gold">Save</button>
                </form>
                <div class="kpi-sub">Saves target for this year and month.</div>
              {% else %}
                <div class="kpi-sub">Ask CA team to update the target.</div>
              {% endif %}
            {% else %}
              <div class="kpi-sub">Pick a month to set and track the target.</div>
            {% endif %}

            <div class="kpi-sub">Factory monthly target.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="cardx mb-3">
      <div class="card-body p-3">

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2" style="margin-bottom:10px;">
          {% with qs=request.GET.urlencode %}
            <div class="pillbar">
              <a class="pill pill-gold" href="{% url 'accounting_bd_grid_export_csv' %}{% if qs %}?{{ qs }}{% endif %}">Export CSV</a>
              <a class="pill pill-gold" href="{% url 'accounting_bd_grid_export_xlsx' %}{% if qs %}?{{ qs }}{% endif %}">Export Excel</a>
              <button type="button" class="pill" id="toggleFilesBtn">Files</button>
            </div>

            {% if request.user.is_superuser %}
              <div class="pillbar">
                <form method="post" style="margin:0;">
                  {% csrf_token %}
                  <input type="hidden" name="month_action" value="close">
                  <input type="hidden" name="year" value="{{ filter_year }}">
                  <input type="hidden" name="month" value="{{ filter_month }}">
                  <button type="submit" class="pill pill-gold" {% if not filter_month %}disabled{% endif %}>
                    Close month
                  </button>
                </form>

                <form method="post" style="margin:0;">
                  {% csrf_token %}
                  <input type="hidden" name="month_action" value="open">
                  <input type="hidden" name="year" value="{{ filter_year }}">
                  <input type="hidden" name="month" value="{{ filter_month }}">
                  <button type="submit" class="pill" {% if not filter_month %}disabled{% endif %}>
                    Open month
                  </button>
                </form>
              </div>
            {% endif %}
          {% endwith %}
        </div>

        <form method="get" class="row g-2 align-items-end" style="font-size:13px; font-weight:800;">

          <div class="col-sm-2">
            <label class="form-label mb-1 label">Year</label>
            <input type="text" name="year" value="{{ filter_year }}" class="form-control form-control-sm inp" placeholder="2025">
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1 label">Month</label>
            <select name="month" class="form-select form-select-sm inp">
              <option value="" {% if not filter_month %}selected{% endif %}>All</option>
              <option value="1" {% if filter_month|stringformat:"s" == "1" %}selected{% endif %}>January</option>
              <option value="2" {% if filter_month|stringformat:"s" == "2" %}selected{% endif %}>February</option>
              <option value="3" {% if filter_month|stringformat:"s" == "3" %}selected{% endif %}>March</option>
              <option value="4" {% if filter_month|stringformat:"s" == "4" %}selected{% endif %}>April</option>
              <option value="5" {% if filter_month|stringformat:"s" == "5" %}selected{% endif %}>May</option>
              <option value="6" {% if filter_month|stringformat:"s" == "6" %}selected{% endif %}>June</option>
              <option value="7" {% if filter_month|stringformat:"s" == "7" %}selected{% endif %}>July</option>
              <option value="8" {% if filter_month|stringformat:"s" == "8" %}selected{% endif %}>August</option>
              <option value="9" {% if filter_month|stringformat:"s" == "9" %}selected{% endif %}>September</option>
              <option value="10" {% if filter_month|stringformat:"s" == "10" %}selected{% endif %}>October</option>
              <option value="11" {% if filter_month|stringformat:"s" == "11" %}selected{% endif %}>November</option>
              <option value="12" {% if filter_month|stringformat:"s" == "12" %}selected{% endif %}>December</option>
            </select>
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1 label">Flow</label>
            <select name="direction" class="form-select form-select-sm inp">
              <option value="ALL" {% if filter_direction == "ALL" or not filter_direction %}selected{% endif %}>All</option>
              <option value="IN" {% if filter_direction == "IN" %}selected{% endif %}>In</option>
              <option value="OUT" {% if filter_direction == "OUT" %}selected{% endif %}>Out</option>
            </select>
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1 label">Main type</label>
            <select name="main_type" class="form-select form-select-sm inp">
              <option value="ALL" {% if filter_main_type == "ALL" or not filter_main_type %}selected{% endif %}>All</option>
              <option value="INCOME" {% if filter_main_type == "INCOME" %}selected{% endif %}>Income</option>
              <option value="COGS" {% if filter_main_type == "COGS" %}selected{% endif %}>COGS</option>
              <option value="EXPENSE" {% if filter_main_type == "EXPENSE" %}selected{% endif %}>Expense</option>
              <option value="TRANSFER" {% if filter_main_type == "TRANSFER" %}selected{% endif %}>Transfer</option>
              <option value="TAX" {% if filter_main_type == "TAX" %}selected{% endif %}>Tax</option>
              <option value="OTHER" {% if filter_main_type == "OTHER" %}selected{% endif %}>Other</option>
            </select>
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1 label">Has file</label>
            <select name="has_file" class="form-select form-select-sm inp">
              <option value="ALL" {% if filter_has_file == "ALL" or not filter_has_file %}selected{% endif %}>All</option>
              <option value="YES" {% if filter_has_file == "YES" %}selected{% endif %}>Yes</option>
              <option value="NO" {% if filter_has_file == "NO" %}selected{% endif %}>No</option>
            </select>
          </div>

          <div class="col-sm-3">
            <label class="form-label mb-1 label">Search</label>
            <input type="text" name="q" value="{{ filter_q }}" class="form-control form-control-sm inp" placeholder="sub type, description, customer, transfer ref">
          </div>

          <div class="col-sm-3">
            <label class="form-label mb-1 label">Order code</label>
            <input type="text" name="order" value="{{ filter_order }}" class="form-control form-control-sm inp" placeholder="Example PO 1001">
          </div>

          <div class="col-sm-3 d-flex gap-2">
            <button type="submit" class="pill pill-gold w-100">Apply</button>
          </div>

          <div class="col-sm-3 d-flex gap-2">
            <a href="{% url 'accounting_bd_grid' %}" class="pill w-100">Reset</a>
          </div>

        </form>

        <div class="subtitle" style="margin-top:10px;">
          Pick a month to compare net result with the monthly target.
        </div>

      </div>
    </div>

    <div class="cardx" id="entriesTableBox">
      <div class="card-header py-2" style="border-bottom:1px solid #1f2937;">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span style="font-size:14px; font-weight:900; color:var(--text);">Bangladesh entries</span>
          <span style="font-size:11px; color:var(--muted); font-weight:700;">Showing {{ entries|length }} records</span>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-dark table-sm mb-0 tbl" style="font-size:12px;">
          <thead>
            <tr>
              <th class="nowrap">Date</th>
              <th class="nowrap">Flow</th>
              <th class="nowrap">Main type</th>
              <th class="nowrap">Sub type</th>
              <th>Description</th>
              <th class="nowrap">Order</th>
              <th class="nowrap">Files</th>
              <th class="text-end nowrap">Amount (BDT)</th>
              {% if request.user|in_group:"CA" or request.user.is_superuser %}
                <th class="nowrap">Edit</th>
              {% endif %}
              {% if request.user.is_superuser %}
                <th class="nowrap">Delete</th>
              {% endif %}
            </tr>
          </thead>

          <tbody>
            {% if entries %}
              {% for e in entries %}
                {% with file_count=e.attachments.count %}
                  <tr>
                    <td class="nowrap">{{ e.date|date:"Y-m-d" }}</td>

                    <td class="nowrap">
                      {% if e.direction == "IN" %}
                        <span class="badge rounded-pill text-bg-success">In</span>
                      {% else %}
                        <span class="badge rounded-pill text-bg-danger">Out</span>
                      {% endif %}
                    </td>

                    <td class="nowrap">
                      {% if e.get_main_type_display %}
                        {{ e.get_main_type_display }}
                      {% else %}
                        {{ e.main_type }}
                      {% endif %}
                    </td>

                    <td class="nowrap">{{ e.sub_type|default:"" }}</td>

                    <td class="wrapText">{{ e.description|default:"" }}</td>

                    <td class="nowrap">
                      {% if e.production_order %}
                        {{ e.production_order.order_code }}
                      {% else %}
                        <span style="color:var(--muted);">-</span>
                      {% endif %}
                    </td>

                    <td class="nowrap">
                      {% if file_count > 0 %}
                        <button
                          type="button"
                          class="filePill"
                          data-bs-toggle="collapse"
                          data-bs-target="#files_{{ e.id }}"
                          aria-expanded="false"
                          aria-controls="files_{{ e.id }}"
                          title="Show files"
                        >
                          View {{ file_count }}
                        </button>

                        <div class="collapse" id="files_{{ e.id }}">
                          <div class="fileListBox">
                            {% for a in e.attachments.all %}
                              <div class="fileRow">
                                <div class="fileName">{{ a.original_name|default:"File" }}</div>
                                <div class="nowrap">
                                  <a class="linkGold" href="{{ a.file.url }}" target="_blank" rel="noopener">Open</a>
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                        </div>
                      {% else %}
                        <span style="color:var(--muted);">-</span>
                      {% endif %}
                    </td>

                    <td class="text-end nowrap">{{ e.amount_original|default_if_none:0|floatformat:2|intcomma }}</td>

                    {% if request.user|in_group:"CA" or request.user.is_superuser %}
                      <td class="nowrap">
                        <a href="{% url 'accounting_entry_edit' e.pk %}" class="btn btn-outline-light btn-sm rounded-pill" style="font-weight:900;">
                          Edit
                        </a>
                      </td>
                    {% endif %}

                    {% if request.user.is_superuser %}
                      <td class="nowrap">
                        <form method="post" action="{% url 'accounting_entry_delete' e.pk %}" style="display:inline;">
                          {% csrf_token %}
                          <button
                            type="submit"
                            class="btn btn-outline-danger btn-sm rounded-pill"
                            style="font-weight:900;"
                            onclick="return confirm('Delete this entry? This cannot be undone.')"
                          >
                            Delete
                          </button>
                        </form>
                      </td>
                    {% endif %}
                  </tr>
                {% endwith %}
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="{% if request.user.is_superuser %}10{% elif request.user|in_group:'CA' %}9{% else %}8{% endif %}"
                    class="text-center py-3"
                    style="color:var(--muted); font-weight:800;">
                  No Bangladesh entries yet.
                </td>
              </tr>
            {% endif %}
          </tbody>

          <tfoot>
            <tr style="background:var(--bg2); font-weight:900;">
              <td colspan="7" class="text-end" style="color:var(--text);">Net for this view</td>
              <td class="text-end nowrap" style="color:var(--text);">
                {{ net_bdt|default_if_none:0|floatformat:2|intcomma }} BDT
              </td>
              <td colspan="{% if request.user.is_superuser %}2{% elif request.user|in_group:'CA' %}1{% else %}0{% endif %}"
                  style="color:var(--muted); font-weight:800;">
                Money in minus money out.
              </td>
            </tr>
          </tfoot>

        </table>
      </div>
    </div>

  </div>
</div>

<script>
  (function(){
    var expanded = false;
    var btn = document.getElementById("toggleFilesBtn");
    if(!btn) return;

    function setAll(open){
      var nodes = document.querySelectorAll(".collapse");
      for(var i=0;i<nodes.length;i++){
        var el = nodes[i];
        if(open){
          el.classList.add("show");
        }else{
          el.classList.remove("show");
        }
      }
    }

    btn.addEventListener("click", function(){
      expanded = !expanded;
      setAll(expanded);
      var box = document.getElementById("entriesTableBox");
      if(box) box.scrollIntoView({behavior:"smooth", block:"start"});
    });
  })();
</script>

{% endblock %}