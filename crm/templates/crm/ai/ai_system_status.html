{% extends "crm/base.html" %}

{% block content %}
<style>
  .ai-wrap{ color:#f9fafb; max-width:1100px; margin:0 auto; }
  .ai-sub{ font-size:12px; color:#9ca3af; font-weight:800; }
  .ai-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:16px; }
  .ai-card{
    flex:1; min-width:260px; padding:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
    border:1px solid #334155;
    border-radius:18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.55);
  }
  .ai-badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    font-size:11px; font-weight:900;
    border:1px solid #334155;
    background: rgba(255,255,255,0.03);
    color:#e5e7eb;
    white-space:nowrap;
  }
  .ai-badge-ok{ background:#16a34a; border-color:#16a34a; color:#0b0f1a; }
  .ai-badge-warn{ background:#f59e0b; border-color:#f59e0b; color:#111827; }
  .ai-badge-bad{ background:#ef4444; border-color:#ef4444; color:#fff; }
  .ai-kv{ margin:8px 0 0 0; font-size:12px; color:#cbd5e1; font-weight:800; }
  .ai-table{ width:100%; border-collapse:collapse; }
  .ai-th{ text-align:left; padding:10px; border-bottom:1px solid #334155; font-size:12px; color:#cbd5e1; }
  .ai-td{ padding:10px; border-bottom:1px solid rgba(148,163,184,0.18); font-size:12px; color:#e5e7eb; vertical-align:top; }
  .ai-warn{ margin-top:10px; padding:10px; border:1px solid #f59e0b; border-radius:12px; background: rgba(245,158,11,0.12); }
  .ai-warn ul{ margin:6px 0 0 18px; }
</style>

<div class="container-fluid">
  <div class="ai-wrap">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
      <div>
        <h2 class="mb-1" style="font-weight:900;">AI System Status</h2>
        <div class="ai-sub">Provider status, key status, request logs, and errors.</div>
      </div>

      <div class="ai-badge">
        <span>ðŸ‘¤</span> {{ request.user.get_username }}
      </div>
    </div>

    <div class="ai-row">

      <div class="ai-card">
        <div class="d-flex justify-content-between align-items-center">
          <strong>Provider</strong>

          {% if provider_ok %}
            <span class="ai-badge ai-badge-ok">OK</span>
          {% else %}
            <span class="ai-badge ai-badge-bad">ERROR</span>
          {% endif %}
        </div>

        <p class="ai-kv">Name: {{ provider_name|default:"OpenAI" }}</p>
        <p class="ai-kv">API key loaded: {{ key_loaded|default:False }}</p>
        <p class="ai-kv">Model: {{ model_name|default:"Not set" }}</p>

        {% if not provider_ok and provider_error %}
          <p class="ai-kv" style="color:#fca5a5;">{{ provider_error }}</p>
        {% endif %}
      </div>

      <div class="ai-card">
        <div class="d-flex justify-content-between align-items-center">
          <strong>Usage and health</strong>

          {% if score|default:0 >= 90 %}
            <span class="ai-badge ai-badge-ok">Good</span>
          {% elif score|default:0 >= 70 %}
            <span class="ai-badge ai-badge-warn">Watch</span>
          {% else %}
            <span class="ai-badge ai-badge-bad">Risk</span>
          {% endif %}
        </div>

        <p class="ai-kv">
          Last request time:
          {% if last_request_time %}
            {{ last_request_time }}
          {% else %}
            None
          {% endif %}
        </p>

        <p class="ai-kv">Errors last 24 hours: {{ errors_24h|default:0 }}</p>
        <p class="ai-kv">Status score: {{ score|default:0 }}</p>
      </div>

      <div class="ai-card">
        <strong>CRM quick signals</strong>
        <p class="ai-kv">Leads last 7 days: {{ leads_7|default:"-" }}</p>
        <p class="ai-kv">Opportunities last 7 days: {{ opp_7|default:"-" }}</p>
        <p class="ai-kv">Shipments count: {{ ship_count|default:0 }}</p>

        {% if warnings and warnings|length %}
          <div class="ai-warn">
            <strong>Warnings</strong>
            <ul>
              {% for w in warnings %}
                <li>{{ w }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>

    </div>

    <h3 style="margin-top:22px; font-weight:900;">Error history</h3>
    <div class="ai-card" style="margin-top:10px;">
      <table class="ai-table">
        <thead>
          <tr>
            <th class="ai-th">Time</th>
            <th class="ai-th">Feature</th>
            <th class="ai-th">Message</th>
          </tr>
        </thead>
        <tbody>
          {% for row in recent_errors %}
            <tr>
              <td class="ai-td">{{ row.created_at }}</td>
              <td class="ai-td">
                {{ row.feature|default:"" }}
                {% if row.provider %}
                  <div style="margin-top:4px;color:#9ca3af;">{{ row.provider }} {{ row.model_name|default:"" }}</div>
                {% endif %}
              </td>
              <td class="ai-td">
                {{ row.message|default:"" }}
                {% if row.error_type %}
                  <div style="margin-top:6px;color:#fca5a5;">{{ row.error_type }}</div>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="ai-td" colspan="3">No errors yet</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}