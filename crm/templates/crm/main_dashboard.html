{% extends "crm/base.html" %}
{% load humanize %}
{% block content %}

<style>
  @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Sora:wght@400;600;700&display=swap");

  :root{
    --bg: #05070c;
    --bg-2: #0b1020;
    --panel: #0f172a;
    --panel-2: #0b1224;
    --text: #f8fafc;
    --muted: #94a3b8;
    --line: rgba(148,163,184,0.18);
    --teal: #22d3ee;
    --amber: #fbbf24;
    --green: #4ade80;
    --red: #fb7185;
    --blue: #60a5fa;
  }

  .dash{
    position: relative;
    max-width: 1600px;
    margin: 0 auto;
    padding: 8px 10px 40px 10px;
    color: var(--text);
    font-family: "Sora", sans-serif;
  }

  .dash::before{
    content:"";
    position: absolute;
    inset: -40px -20px auto -20px;
    height: 420px;
    background:
      radial-gradient(400px 220px at 20% 20%, rgba(34,211,238,0.18), transparent 70%),
      radial-gradient(420px 260px at 80% 10%, rgba(251,191,36,0.14), transparent 70%),
      linear-gradient(180deg, rgba(15,23,42,0.85), transparent 70%);
    z-index: 0;
    pointer-events: none;
  }

  .dash > *{ position: relative; z-index: 1; }

  .dash-hero{
    display:flex;
    justify-content: space-between;
    align-items:flex-end;
    gap:16px;
    flex-wrap:wrap;
    margin: 6px 0 18px;
  }

  .dash-title{
    margin:0;
    font-size: 28px;
    font-weight: 700;
    font-family: "Space Grotesk", sans-serif;
    letter-spacing: 0.2px;
  }

  .dash-sub{
    margin-top:6px;
    color: var(--muted);
    font-size: 12px;
    font-weight: 600;
  }

  .dash-meta{
    margin-top:8px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }

  .meta-pill{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background: rgba(255,255,255,0.04);
  }

  .dash-controls{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .dash-select{
    background: var(--panel);
    border:1px solid var(--line);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 10px;
    font-weight: 700;
  }

  .dash-btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 8px 12px;
    border-radius: 12px;
    border:1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
    color: var(--text);
    text-decoration:none;
    font-size: 12px;
    font-weight: 800;
  }

  .dash-btn:hover{ filter: brightness(1.05); text-decoration:none; }

  .kpi-grid{
    display:grid;
    grid-template-columns: repeat(6, minmax(0, 1fr));
    gap:12px;
  }

  @media (max-width: 1200px){
    .kpi-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
  }
  @media (max-width: 760px){
    .kpi-grid{ grid-template-columns: 1fr; }
  }

  .card{
    background: linear-gradient(180deg, rgba(15,23,42,0.9), rgba(2,6,23,0.9));
    border:1px solid var(--line);
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.5);
    overflow:hidden;
    animation: rise 0.5s ease both;
    animation-delay: var(--d,0s);
  }

  @keyframes rise{
    from{ opacity:0; transform: translateY(12px); }
    to{ opacity:1; transform: translateY(0); }
  }

  .kpi-title{
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    font-weight: 800;
  }
  .kpi-value{
    font-size: 22px;
    font-weight: 700;
    margin-top: 6px;
    font-family: "Space Grotesk", sans-serif;
  }
  .kpi-sub{
    margin-top: 6px;
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }

  .grid-2{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
  .grid-3{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
  .grid-4{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }

  @media (max-width: 1200px){
    .grid-4{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-2{ grid-template-columns: 1fr; }
  }
  @media (max-width: 760px){
    .grid-4,.grid-3,.grid-2{ grid-template-columns: 1fr; }
  }

  .card-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom: 10px;
  }

  .card-title{
    margin:0;
    font-size: 13px;
    font-weight: 800;
  }

  .card-note{
    font-size: 11px;
    color: var(--muted);
    font-weight: 600;
  }

  .chartWrap{ height: 260px; }
  .chartWrap.sm{ height: 200px; }
  .chartWrap.xs{ height: 160px; }
  canvas{ width:100% !important; height:100% !important; }

  .ai-notes{
    font-size: 12px;
    line-height: 1.5;
    color: var(--text);
    margin: 0;
    padding-left: 16px;
  }
  .ai-notes li{ margin-bottom: 6px; color: #e5e7eb; }

  .section-label{
    margin: 16px 0 8px 2px;
    color: var(--muted);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.45px;
    font-weight: 800;
  }
</style>

<div class="container-fluid">
  <div class="dash">

    <div class="dash-hero">
      <div>
        <h2 class="dash-title">CRM Command Center</h2>
        <div class="dash-sub">Live snapshot of leads, production, and cash.</div>
        <div class="dash-meta">
          <span class="meta-pill">Updated: {{ today|date:"M d, Y" }}</span>
          <span class="meta-pill">{{ period_label }}</span>
        </div>
      </div>

      <form method="get" class="dash-controls">
        <label class="dash-sub" for="days">Range</label>
        <select id="days" name="days" class="dash-select" onchange="this.form.submit()">
          <option value="7" {% if period_days == 7 %}selected{% endif %}>Last 7 days</option>
          <option value="30" {% if period_days == 30 %}selected{% endif %}>Last 30 days</option>
          <option value="60" {% if period_days == 60 %}selected{% endif %}>Last 60 days</option>
          <option value="90" {% if period_days == 90 %}selected{% endif %}>Last 90 days</option>
          <option value="180" {% if period_days == 180 %}selected{% endif %}>Last 180 days</option>
        </select>
        <a class="dash-btn" href="{% url 'accounting_bd_dashboard' %}">BD Accounting</a>
        <a class="dash-btn" href="{% url 'production_profit_report' %}">Production Profit</a>
      </form>
    </div>

    <div class="kpi-grid">
      <div class="card" style="--d:0.02s;">
        <div class="kpi-title">Leads Today</div>
        <div class="kpi-value" style="color:var(--green);">{{ leads_today|default:0 }}</div>
        <div class="kpi-sub">New leads received today.</div>
      </div>

      <div class="card" style="--d:0.04s;">
        <div class="kpi-title">Leads {{ period_label }}</div>
        <div class="kpi-value">{{ leads_period|default:0 }}</div>
        <div class="kpi-sub">Lead volume in selected range.</div>
      </div>

      <div class="card" style="--d:0.06s;">
        <div class="kpi-title">Opportunities {{ period_label }}</div>
        <div class="kpi-value">{{ opp_period|default:0 }}</div>
        <div class="kpi-sub">Created from leads.</div>
      </div>

      <div class="card" style="--d:0.08s;">
        <div class="kpi-title">Conversion Rate</div>
        <div class="kpi-value" style="color:var(--teal);">{{ conversion_rate|default:0 }}%</div>
        <div class="kpi-sub">Leads â†’ opportunities.</div>
      </div>

      <div class="card" style="--d:0.1s;">
        <div class="kpi-title">Open Opportunities</div>
        <div class="kpi-value">{{ open_opps|default:0 }}</div>
        <div class="kpi-sub">Active pipeline right now.</div>
      </div>

      <div class="card" style="--d:0.12s;">
        <div class="kpi-title">Net Cash {{ period_label }}</div>
        <div class="kpi-value" style="color:var(--amber);">{{ acc_net_cad_period|floatformat:2 }}</div>
        <div class="kpi-sub">In {{ acc_income_cad_period|floatformat:2 }} | Out {{ acc_out_cad_period|floatformat:2 }}</div>
      </div>
    </div>

    <div class="section-label">Insights</div>
    <div class="grid-2">
      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Lead & Opportunity Trend</p>
            <div class="card-note">Daily activity for {{ period_label|lower }}</div>
          </div>
          <span class="meta-pill">Live</span>
        </div>
        <div class="chartWrap">
          <canvas id="chartTrend"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Cash Flow</p>
            <div class="card-note">Net cash by day (CAD)</div>
          </div>
        </div>
        <div class="chartWrap">
          <canvas id="chartCash"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-3" style="margin-top:12px;">
      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Lead Qualification Funnel</p>
            <div class="card-note">Each lead status in pipeline</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartLeadStatus"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Opportunity Stages</p>
            <div class="card-note">Pipeline distribution</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartOppStages"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Win vs Lost</p>
            <div class="card-note">Closed performance</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartWinLoss"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-4" style="margin-top:12px;">
      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Lead Sources</p>
            <div class="card-note">Top channels</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartLeadSource"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Market Split</p>
            <div class="card-note">Lead geography</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartMarket"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Lead Priority Mix</p>
            <div class="card-note">Urgency distribution</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartPriority"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">AI Insights</p>
            <div class="card-note">Quick signals</div>
          </div>
        </div>
        <ul class="ai-notes">
          {% for n in ai_notes %}
            <li>{{ n }}</li>
          {% endfor %}
        </ul>
        <div class="dash-sub" style="margin-top:8px;">Overdue follow-ups: <strong>{{ overdue_followups|default:0 }}</strong></div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Production Status</p>
            <div class="card-note">On time vs delayed</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartProduction"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div>
            <p class="card-title">Shipping Status</p>
            <div class="card-note">Shipped, pending, delayed</div>
          </div>
        </div>
        <div class="chartWrap sm">
          <canvas id="chartShipping"></canvas>
        </div>
      </div>
    </div>

    <div class="section-label">Payroll Snapshot ({{ payroll_year }} {{ payroll_month }})</div>
    <div class="grid-4">
      <div class="card">
        <div class="kpi-title">Payroll Total (BDT)</div>
        <div class="kpi-value" style="color:var(--green);">{{ payroll_total|floatformat:2 }}</div>
        <div class="kpi-sub">Final pay total.</div>
      </div>
      <div class="card">
        <div class="kpi-title">Overtime (BDT)</div>
        <div class="kpi-value">{{ payroll_ot|floatformat:2 }}</div>
        <div class="kpi-sub">Overtime total.</div>
      </div>
      <div class="card">
        <div class="kpi-title">Bonus (BDT)</div>
        <div class="kpi-value">{{ payroll_bonus|floatformat:2 }}</div>
        <div class="kpi-sub">Bonus total.</div>
      </div>
      <div class="card">
        <div class="kpi-title">Deduction (BDT)</div>
        <div class="kpi-value" style="color:var(--red);">{{ payroll_deduction|floatformat:2 }}</div>
        <div class="kpi-sub">Deduction total.</div>
      </div>
    </div>

  </div>
</div>

{{ chart_data|json_script:"dash-data" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  (function(){
    const raw = document.getElementById("dash-data");
    if (!raw || !window.Chart) return;
    const data = JSON.parse(raw.textContent || "{}");

    function safeLabels(labels){
      return labels && labels.length ? labels : ["No data"];
    }
    function safeValues(values, len){
      if (values && values.length) return values;
      return Array(len || 1).fill(0);
    }

    const baseOpts = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: "#e5e7eb", font: { weight: "700" } } },
        tooltip: { enabled: true }
      },
      scales: {
        x: { ticks: { color: "#cbd5e1" }, grid: { color: "rgba(148,163,184,0.15)" } },
        y: { ticks: { color: "#cbd5e1" }, grid: { color: "rgba(148,163,184,0.15)" } }
      }
    };

    const trendLabels = safeLabels(data.leads_labels || []);
    const leadsVals = safeValues(data.leads_values || [], trendLabels.length);
    const oppVals = safeValues(data.opp_daily_values || [], trendLabels.length);

    new Chart(document.getElementById("chartTrend"), {
      type: "line",
      data: {
        labels: trendLabels,
        datasets: [
          { label: "Leads", data: leadsVals, borderWidth: 2, tension: 0.35, fill: true, pointRadius: 2 },
          { label: "Opportunities", data: oppVals, borderWidth: 2, tension: 0.35, fill: false, pointRadius: 2 }
        ]
      },
      options: baseOpts
    });

    const cashVals = safeValues(data.cash_daily_values || [], trendLabels.length);
    new Chart(document.getElementById("chartCash"), {
      type: "line",
      data: { labels: trendLabels, datasets: [{ label: "Net cash", data: cashVals, borderWidth: 2, tension: 0.35, fill: false, pointRadius: 0 }] },
      options: baseOpts
    });

    const leadStatusLabels = safeLabels(data.lead_status_labels || []);
    const leadStatusVals = safeValues(data.lead_status_values || [], leadStatusLabels.length);
    new Chart(document.getElementById("chartLeadStatus"), {
      type: "bar",
      data: { labels: leadStatusLabels, datasets: [{ label: "Leads", data: leadStatusVals, borderWidth: 1 }] },
      options: Object.assign({}, baseOpts, { indexAxis: "y" })
    });

    const oppStageLabels = safeLabels(data.opp_stage_labels || []);
    const oppStageVals = safeValues(data.opp_stage_values || [], oppStageLabels.length);
    new Chart(document.getElementById("chartOppStages"), {
      type: "bar",
      data: { labels: oppStageLabels, datasets: [{ label: "Opportunities", data: oppStageVals, borderWidth: 1 }] },
      options: Object.assign({}, baseOpts, { indexAxis: "y" })
    });

    new Chart(document.getElementById("chartWinLoss"), {
      type: "doughnut",
      data: { labels: data.win_loss_labels || ["Won","Lost"], datasets: [{ data: data.win_loss_values || [0,0] }] },
      options: { responsive: true, maintainAspectRatio: false, plugins:{ legend:{ position:"bottom", labels:{ color:"#e5e7eb", font:{weight:"700"} } } } }
    });

    const sourceLabels = safeLabels(data.lead_source_labels || []);
    const sourceVals = safeValues(data.lead_source_values || [], sourceLabels.length);
    new Chart(document.getElementById("chartLeadSource"), {
      type: "bar",
      data: { labels: sourceLabels, datasets: [{ label: "Leads", data: sourceVals, borderWidth: 1 }] },
      options: baseOpts
    });

    new Chart(document.getElementById("chartMarket"), {
      type: "doughnut",
      data: { labels: data.lead_market_labels || ["Unknown"], datasets: [{ data: data.lead_market_values || [0] }] },
      options: { responsive: true, maintainAspectRatio: false, plugins:{ legend:{ position:"bottom", labels:{ color:"#e5e7eb", font:{weight:"700"} } } } }
    });

    const priorityLabels = safeLabels(data.lead_priority_labels || []);
    const priorityVals = safeValues(data.lead_priority_values || [], priorityLabels.length);
    new Chart(document.getElementById("chartPriority"), {
      type: "bar",
      data: { labels: priorityLabels, datasets: [{ label: "Leads", data: priorityVals, borderWidth: 1 }] },
      options: baseOpts
    });

    new Chart(document.getElementById("chartProduction"), {
      type: "bar",
      data: { labels: data.prod_labels || ["On time","Delayed","Remake"], datasets: [{ label: "Orders", data: data.prod_counts || [0,0,0], borderWidth: 1 }] },
      options: Object.assign({}, baseOpts, { indexAxis: "y" })
    });

    new Chart(document.getElementById("chartShipping"), {
      type: "bar",
      data: {
        labels: data.ship_labels || ["This month"],
        datasets: [
          { label: "Shipped", data: data.ship_shipped || [0], stack: "s1" },
          { label: "Pending", data: data.ship_pending || [0], stack: "s1" },
          { label: "Delayed", data: data.ship_delayed || [0], stack: "s1" }
        ]
      },
      options: Object.assign({}, baseOpts, {
        scales: {
          x: { stacked: true, ticks: { color:"#cbd5e1" }, grid:{ color:"rgba(148,163,184,0.15)" } },
          y: { stacked: true, ticks: { color:"#cbd5e1" }, grid:{ color:"rgba(148,163,184,0.15)" } }
        }
      })
    });
  })();
</script>

{% endblock %}
