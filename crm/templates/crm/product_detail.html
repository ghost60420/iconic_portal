{% extends "crm/base.html" %}
{% load static %}
{% block content %}

<style>
  .product-page {
    max-width: 1180px;
    margin: 24px auto;
    padding: 0 10px;
  }

  .prod-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .prod-header-title {
    font-size: 22px;
    font-weight: 700;
    color: #ffffff;
    line-height: 1.2;
  }

  .prod-header-sub {
    font-size: 13px;
    color: #9ca3af;
    margin-top: 4px;
  }

  .btn-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }

  .btn-ghost {
    background: rgba(2, 6, 23, 0.6);
    border-radius: 999px;
    border: 1px solid #374151;
    color: #e5e7eb;
    padding: 7px 12px;
    font-size: 12px;
    text-decoration: none;
    transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .btn-ghost:hover {
    background: rgba(17, 24, 39, 0.9);
    border-color: #facc15;
    transform: translateY(-1px);
  }

  .btn-gold {
    background: #f5d580;
    border-radius: 999px;
    border: none;
    color: #111827;
    padding: 7px 14px;
    font-size: 12px;
    font-weight: 700;
    text-decoration: none;
    transition: transform 120ms ease, background 120ms ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .btn-gold:hover {
    background: #ffe9a8;
    color: #020617;
    transform: translateY(-1px);
  }
  .btn-gold:disabled,
  .btn-ghost:disabled {
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
  }

  /* main cards */

  .prod-main-grid {
    display: grid;
    grid-template-columns: 1.05fr 1.65fr;
    gap: 18px;
    margin-bottom: 18px;
  }

  @media (max-width: 900px) {
    .prod-main-grid {
      grid-template-columns: 1fr;
    }
  }

  .prod-card {
    background: radial-gradient(circle at top left, rgba(31,41,55,0.95), rgba(5,5,5,0.95));
    border-radius: 16px;
    border: 1px solid #1f2937;
    padding: 14px 16px;
    font-size: 13px;
    box-shadow: 0 0 22px rgba(0,0,0,0.55);
  }

  .prod-card-title {
    font-size: 14px;
    font-weight: 700;
    color: #f9fafb;
    margin-bottom: 10px;
    border-bottom: 1px solid #111827;
    padding-bottom: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }

  /* left preview */

  .prod-image-wrap {
    border-radius: 14px;
    border: 1px solid #334155;
    background: rgba(2,6,23,0.85);
    padding: 10px;
    min-height: 240px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .prod-image-wrap img {
    width: 100%;
    height: 100%;
    max-height: 320px;
    border-radius: 12px;
    object-fit: cover;
  }

  .prod-image-placeholder {
    font-size: 12px;
    color: #6b7280;
    text-align: center;
  }

  .badge-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }

  .badge-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    background: rgba(17, 24, 39, 0.8);
    border: 1px solid #374151;
    color: #e5e7eb;
  }

  .badge-pill strong {
    font-weight: 700;
    color: #facc15;
  }

  .badge-pill-muted {
    background: rgba(2, 6, 23, 0.7);
    border-color: #334155;
    color: #9ca3af;
  }

  .prod-code-label {
    font-size: 12px;
    color: #facc15;
    margin-top: 10px;
  }

  /* right info */

  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
  }

  @media (max-width: 520px) {
    .info-grid {
      grid-template-columns: 1fr;
    }
  }

  .info-row {
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid rgba(17,24,39,0.9);
    background: rgba(2,6,23,0.55);
  }

  .info-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #9ca3af;
  }

  .info-value {
    font-size: 13px;
    color: #f9fafb;
    font-weight: 600;
  }

  .info-muted {
    font-size: 12px;
    color: #6b7280;
    font-weight: 500;
  }

  /* notes */

  .notes-card {
    background: rgba(2,6,23,0.75);
    border-radius: 16px;
    border: 1px solid #1f2937;
    padding: 12px 14px;
    font-size: 13px;
    margin-bottom: 16px;
    box-shadow: 0 0 18px rgba(0,0,0,0.45);
  }

  .notes-title {
    font-size: 14px;
    font-weight: 700;
    color: #f9fafb;
    margin-bottom: 8px;
    border-bottom: 1px solid #111827;
    padding-bottom: 6px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }

  .notes-body {
    white-space: pre-wrap;
    color: #e5e7eb;
    line-height: 1.45;
  }

  /* AI helper */

  .ai-card {
    background: rgba(2,6,23,0.75);
    border-radius: 16px;
    border: 1px solid #1f2937;
    padding: 12px 14px;
    font-size: 13px;
    box-shadow: 0 0 18px rgba(0,0,0,0.45);
  }

  .ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .ai-title {
    font-size: 14px;
    font-weight: 700;
    color: #f9fafb;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .ai-status {
    font-size: 11px;
    color: #9ca3af;
  }

  .ai-note {
    font-size: 12px;
    color: #a4925c;
    margin-top: 6px;
    line-height: 1.4;
  }

  .ai-output {
    margin-top: 10px;
    background: rgba(3,7,18,0.9);
    border-radius: 12px;
    border: 1px solid #111827;
    padding: 10px;
    min-height: 84px;
    font-size: 12px;
    color: #e5e7eb;
    white-space: pre-wrap;
    line-height: 1.45;
  }

  .ai-chip-row {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .ai-chip {
    background: rgba(17, 24, 39, 0.8);
    color: #e5e7eb;
    border-radius: 999px;
    border: 1px solid #374151;
    padding: 6px 12px;
    font-size: 11px;
    cursor: pointer;
    user-select: none;
    transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .ai-chip:hover {
    background: rgba(31, 41, 55, 0.9);
    border-color: #facc15;
    transform: translateY(-1px);
  }

  .ai-chip.active {
    border-color: #facc15;
    background: rgba(250, 204, 21, 0.12);
  }

  .ai-chip[aria-disabled="true"] {
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
  }

  .ai-chat-box {
    margin-top: 12px;
    border-top: 1px solid #111827;
    padding-top: 10px;
  }

  .ai-chat-input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }

  .ai-chat-input-row input {
    flex: 1;
    min-width: 240px;
    background: rgba(3,7,18,0.9);
    color: #e5e7eb;
    border-radius: 10px;
    border: 1px solid #374151;
    padding: 9px 10px;
    font-size: 13px;
  }

  .ai-chat-input-row input:focus {
    outline: none;
    border-color: #facc15;
    box-shadow: 0 0 0 2px rgba(250,204,21,0.18);
  }

  .ai-chat-log {
    max-height: 220px;
    overflow-y: auto;
    background: rgba(3,7,18,0.9);
    border-radius: 12px;
    border: 1px solid #111827;
    padding: 10px;
    font-size: 12px;
    color: #e5e7eb;
  }

  .chat-line {
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(17, 24, 39, 0.75);
  }
  .chat-line:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .chat-tag {
    font-weight: 800;
    color: #facc15;
    margin-right: 6px;
  }

  .ai-spinner {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid rgba(229,231,235,0.35);
    border-top-color: rgba(250,204,21,0.9);
    display: inline-block;
    animation: spin 700ms linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<div class="product-page">

  <div class="prod-header-row">
    <div>
      <div class="prod-header-title">
        {{ product.name|default:"Untitled product" }}
      </div>
      <div class="prod-header-sub">
        Code {{ product.product_code|default:"N/A" }}
        {% if product.is_active %}
          ¬∑ Active
        {% else %}
          ¬∑ Archived
        {% endif %}
      </div>
    </div>

    <div class="btn-row">
      <a href="{% url 'products_list' %}" class="btn-ghost">
        ‚Üê Back
      </a>
      <a href="{% url 'product_edit' product.pk %}" class="btn-gold">
        ‚úé Edit
      </a>
    </div>
  </div>

  <div class="prod-main-grid">

    <div class="prod-card">
      <div class="prod-card-title">
        <span>Preview</span>
      </div>

      <div class="prod-image-wrap">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}">
        {% else %}
          <div class="prod-image-placeholder">
            No image yet. Upload one on the edit page.
          </div>
        {% endif %}
      </div>

      <div class="badge-row">
        <div class="badge-pill">
          <strong>Type</strong>
          <span>{{ product.get_product_type_display|default:product.product_type|default:"Not set" }}</span>
        </div>
        <div class="badge-pill">
          <strong>Category</strong>
          <span>{{ product.get_product_category_display|default:product.product_category|default:"Not set" }}</span>
        </div>
        {% if product.is_active %}
          <div class="badge-pill">
            <strong>Status</strong>
            <span>Active</span>
          </div>
        {% else %}
          <div class="badge-pill badge-pill-muted">
            <strong>Status</strong>
            <span>Not active</span>
          </div>
        {% endif %}
      </div>

      <div class="prod-code-label">
        Product code {{ product.product_code|default:"Not set" }}
      </div>
    </div>

    <div class="prod-card">
      <div class="prod-card-title">
        <span>Product information</span>
      </div>

      <div class="info-grid">

        <div class="info-row">
          <div class="info-label">Name</div>
          <div class="info-value">{{ product.name|default:"Not set" }}</div>
        </div>

        <div class="info-row">
          <div class="info-label">Default GSM</div>
          <div class="info-value">
            {% if product.default_gsm %}{{ product.default_gsm }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Default fabric</div>
          <div class="info-value">
            {% if product.default_fabric %}{{ product.default_fabric }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Default MOQ</div>
          <div class="info-value">
            {% if product.default_moq %}{{ product.default_moq }} units{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Default price</div>
          <div class="info-value">
            {% if product.default_price %}{{ product.default_price }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Created</div>
          <div class="info-value">{{ product.created_at|date:"Y-m-d H:i" }}</div>
        </div>

        <div class="info-row">
          <div class="info-label">Last updated</div>
          <div class="info-value">{{ product.updated_at|date:"Y-m-d H:i" }}</div>
        </div>

      </div>
    </div>

  </div>

  <div class="notes-card">
    <div class="notes-title">
      <span>Notes</span>
    </div>
    <div class="notes-body" id="product-notes-body">
      {% if product.notes %}
        {{ product.notes }}
      {% else %}
        <span class="info-muted">No notes yet. AI answers from this page are also saved here.</span>
      {% endif %}
    </div>
  </div>

  <div class="ai-card">

    <div class="ai-header">
      <div class="ai-title">
        ü§ñ AI help for this product
      </div>
      <div class="ai-status" id="ai-prod-detail-status">Ready</div>
    </div>

    <div class="ai-note">
      Uses this product data and saves the answer into notes.
    </div>

    <div class="ai-chip-row">
      <div class="ai-chip" data-mode="summary">Summary</div>
      <div class="ai-chip" data-mode="use_cases">Use cases</div>
      <div class="ai-chip" data-mode="costing">Costing view</div>
      <div class="ai-chip" data-mode="bundle">Bundle ideas</div>
      <div class="ai-chip" data-mode="email">Email draft</div>
      <div class="ai-chip" data-mode="spec">Spec reminder</div>
    </div>

    <div class="ai-output" id="ai-prod-detail-output">AI answer will appear here.</div>

    <div class="ai-chat-box">
      <div class="ai-note">Custom question for this product</div>

      <div class="ai-chat-input-row">
        <input
          type="text"
          id="ai-prod-chat-input"
          placeholder="Example: Write a short sales pitch for this hoodie"
          autocomplete="off"
        >
        <button type="button" class="btn-gold" style="padding:8px 12px;" id="ai-prod-chat-btn">
          Ask AI
        </button>
      </div>

      <div class="ai-chat-log" id="ai-prod-chat-log">
        <div class="info-muted" id="ai-chat-placeholder">
          Chat history will show here.
        </div>
      </div>
    </div>

    <form id="ai-prod-detail-csrf" style="display:none;">
      {% csrf_token %}
    </form>
  </div>

</div>

<script>
(function () {
  const statusBox = document.getElementById("ai-prod-detail-status");
  const outBox = document.getElementById("ai-prod-detail-output");
  const chipNodes = document.querySelectorAll(".ai-chip");
  const chatInput = document.getElementById("ai-prod-chat-input");
  const chatBtn = document.getElementById("ai-prod-chat-btn");
  const chatLog = document.getElementById("ai-prod-chat-log");
  const chatPlaceholder = document.getElementById("ai-chat-placeholder");

  let isBusy = false;

  function getCsrf() {
    const tokenField = document.querySelector("#ai-prod-detail-csrf input[name='csrfmiddlewaretoken']");
    return tokenField ? tokenField.value : "";
  }

  function setBusy(on) {
    isBusy = on;

    chipNodes.forEach(function (c) {
      c.setAttribute("aria-disabled", on ? "true" : "false");
      if (on) c.classList.add("is-busy");
      else c.classList.remove("is-busy");
    });

    if (chatBtn) chatBtn.disabled = on;
    if (chatInput) chatInput.disabled = on;
  }

  function clearActiveChips() {
    chipNodes.forEach(function (c) { c.classList.remove("active"); });
  }

  function addLine(tag, text) {
    if (!chatLog) return;

    if (chatPlaceholder && chatPlaceholder.parentNode) {
      chatPlaceholder.parentNode.removeChild(chatPlaceholder);
    }

    const line = document.createElement("div");
    line.className = "chat-line";

    const t = document.createElement("span");
    t.className = "chat-tag";
    t.textContent = tag + ":";

    const msg = document.createElement("span");
    msg.textContent = " " + (text || "");

    line.appendChild(t);
    line.appendChild(msg);

    chatLog.appendChild(line);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function safeText(s) {
    return (s || "").toString();
  }

  function callProductAi(mode, extraData, clickedChip) {
    if (isBusy) return;

    setBusy(true);
    if (statusBox) statusBox.innerHTML = "<span class='ai-spinner'></span> Thinking";
    if (outBox) outBox.textContent = "";

    if (clickedChip) {
      clearActiveChips();
      clickedChip.classList.add("active");
    } else {
      clearActiveChips();
    }

    const body = { mode: mode };
    if (extraData) {
      for (const k in extraData) body[k] = extraData[k];
    }

    fetch("{% url 'product_ai_detail' product.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCsrf()
      },
      body: new URLSearchParams(body)
    })
    .then(function (res) { return res.json(); })
    .then(function (data) {
      if (data && data.ok) {
        const text = safeText(data.text) || "No answer from AI.";
        if (outBox) outBox.textContent = text;
        if (statusBox) statusBox.textContent = "Saved into notes";

        if (mode === "chat") addLine("AI", text);
        else addLine("AI", "[" + mode + "] " + text);
      } else {
        if (outBox) outBox.textContent = safeText((data && data.error) ? data.error : "AI could not answer.");
        if (statusBox) statusBox.textContent = "Error";
      }
    })
    .catch(function () {
      if (outBox) outBox.textContent = "Error talking to AI.";
      if (statusBox) statusBox.textContent = "Error";
    })
    .finally(function () {
      setBusy(false);
    });
  }

  chipNodes.forEach(function (chip) {
    chip.addEventListener("click", function () {
      if (isBusy) return;
      const mode = chip.getAttribute("data-mode");
      callProductAi(mode, {}, chip);
    });
  });

  function askChat() {
    const question = (chatInput && chatInput.value) ? chatInput.value.trim() : "";
    if (!question || isBusy) return;

    addLine("You", question);
    chatInput.value = "";
    callProductAi("chat", { user_text: question }, null);
  }

  if (chatBtn) {
    chatBtn.addEventListener("click", function () {
      askChat();
    });
  }

  if (chatInput) {
    chatInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        askChat();
      }
    });
  }
})();
</script>

{% endblock %}