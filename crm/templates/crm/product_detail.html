{% extends "crm/base.html" %}
{% load static %}
{% block content %}

<style>
  :root{
    --bg:#060606;
    --panel:#0b0d10;
    --panel2:#0f172a;
    --border:#2a2f38;
    --text:#f8f9fa;
    --muted:#a8b0bd;
    --gold1:#ffe39b;
    --gold2:#e4c067;
    --gold3:#f5d580;
  }

  .product-page{
    max-width: 1180px;
    margin: 18px auto 26px auto;
    padding: 0 10px;
    color: var(--text);
  }

  .prod-header-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom: 14px;
  }

  .prod-header-title{
    font-size: 22px;
    font-weight: 900;
    line-height: 1.2;
    color: var(--gold1);
    letter-spacing: 0.2px;
  }

  .prod-header-sub{
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    font-weight: 800;
  }

  .btn-row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }

  .btn-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 9px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 900;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color: #f3f4f6;
    cursor:pointer;
    user-select:none;
    line-height: 1;
    transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
    text-decoration:none;
    white-space:nowrap;
  }

  .btn-pill:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,0.06);
    border-color: rgba(245, 213, 128, 0.32);
    color: var(--gold1);
  }

  .btn-pill:active{ transform: translateY(0px); }

  .btn-gold{
    background: rgba(245, 213, 128, 0.16);
    border-color: rgba(255, 227, 155, 0.30);
    color: var(--gold1);
    box-shadow: 0 10px 22px rgba(255, 209, 120, 0.10);
  }

  .btn-gold:hover{
    background: rgba(245, 213, 128, 0.22);
    color: #fff;
  }

  .btn-pill[aria-disabled="true"],
  .btn-pill:disabled{
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
  }

  .prod-main-grid{
    display:grid;
    grid-template-columns: 1.05fr 1.65fr;
    gap: 14px;
    margin-bottom: 14px;
  }

  @media (max-width: 900px){
    .prod-main-grid{ grid-template-columns: 1fr; }
  }

  .prod-card{
    background: linear-gradient(180deg, rgba(15,23,42,0.55), rgba(2,6,23,0.65));
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.45);
  }

  .prod-card-title{
    font-size: 14px;
    font-weight: 900;
    color: var(--gold1);
    margin-bottom: 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(255,255,255,0.03);
    font-size: 12px;
    font-weight: 800;
    color: rgba(248,249,250,0.80);
    white-space:nowrap;
  }

  .prod-image-wrap{
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(0,0,0,0.30);
    padding: 10px;
    min-height: 240px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }

  .prod-image-wrap img{
    width:100%;
    max-height: 340px;
    border-radius: 12px;
    object-fit: cover;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(255,255,255,0.03);
  }

  .prod-image-placeholder{
    font-size: 12px;
    color: rgba(248,249,250,0.60);
    text-align:center;
    font-weight: 800;
  }

  .badge-row{
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
    margin-top: 10px;
  }

  .badge-pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 7px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(255,255,255,0.03);
    color: rgba(248,249,250,0.78);
    font-weight: 800;
  }

  .badge-pill strong{
    color: var(--gold2);
    font-weight: 900;
  }

  .badge-muted{
    opacity: 0.75;
  }

  .prod-code-label{
    margin-top: 10px;
    font-size: 12px;
    color: rgba(255,227,155,0.85);
    font-weight: 900;
  }

  .info-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  @media (max-width: 520px){
    .info-grid{ grid-template-columns: 1fr; }
  }

  .info-row{
    display:flex;
    flex-direction:column;
    gap: 6px;
    padding: 10px;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(255,255,255,0.03);
  }

  .info-label{
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    color: rgba(248,249,250,0.60);
    font-weight: 900;
  }

  .info-value{
    font-size: 13px;
    color: var(--text);
    font-weight: 900;
  }

  .info-muted{
    font-size: 12px;
    color: rgba(248,249,250,0.60);
    font-weight: 800;
  }

  .notes-card,
  .ai-card{
    background: linear-gradient(180deg, rgba(15,23,42,0.55), rgba(2,6,23,0.65));
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.45);
    margin-bottom: 14px;
  }

  .notes-title,
  .ai-title{
    font-size: 14px;
    font-weight: 900;
    color: var(--gold1);
    margin-bottom: 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }

  .notes-body{
    white-space: pre-wrap;
    color: rgba(248,249,250,0.86);
    line-height: 1.5;
    font-size: 13px;
  }

  .ai-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
    flex-wrap:wrap;
    margin-bottom: 8px;
  }

  .ai-status{
    font-size: 12px;
    font-weight: 800;
    color: rgba(248,249,250,0.70);
  }

  .ai-note{
    font-size: 12px;
    color: rgba(248,249,250,0.60);
    font-weight: 800;
    line-height: 1.4;
  }

  .ai-chip-row{
    margin-top: 10px;
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
  }

  .ai-chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 9px 12px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(255,255,255,0.03);
    color: rgba(248,249,250,0.80);
    font-size: 12px;
    font-weight: 900;
    cursor:pointer;
    user-select:none;
    transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
  }

  .ai-chip:hover{
    transform: translateY(-1px);
    border-color: rgba(245, 213, 128, 0.32);
    color: var(--gold1);
    background: rgba(255,255,255,0.05);
  }

  .ai-chip.active{
    border-color: rgba(255,227,155,0.38);
    background: rgba(245,213,128,0.12);
    color: var(--gold1);
  }

  .ai-chip[aria-disabled="true"]{
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
  }

  .ai-output{
    margin-top: 10px;
    background: rgba(0,0,0,0.30);
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 10px 12px;
    min-height: 90px;
    font-size: 13px;
    color: rgba(248,249,250,0.90);
    white-space: pre-wrap;
    line-height: 1.5;
  }

  .ai-chat-box{
    margin-top: 12px;
    border-top: 1px solid rgba(148,163,184,0.18);
    padding-top: 12px;
  }

  .ai-chat-input-row{
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    margin-top: 8px;
  }

  .ai-chat-input-row input{
    flex:1;
    min-width: 240px;
    background: rgba(255,255,255,0.04);
    color: var(--text);
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.12);
    padding: 10px 12px;
    font-size: 13px;
    outline: none;
  }

  .ai-chat-input-row input:focus{
    border-color: rgba(245, 213, 128, 0.45);
    box-shadow: 0 0 0 3px rgba(245,213,128,0.14);
  }

  .ai-chat-log{
    margin-top: 10px;
    max-height: 230px;
    overflow-y: auto;
    background: rgba(0,0,0,0.30);
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 10px 12px;
    font-size: 13px;
    color: rgba(248,249,250,0.86);
  }

  .chat-line{
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(148,163,184,0.14);
  }
  .chat-line:last-child{
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .chat-tag{
    font-weight: 900;
    color: var(--gold2);
    margin-right: 6px;
  }

  .ai-spinner{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(229,231,235,0.35);
    border-top-color: rgba(245,213,128,0.95);
    display:inline-block;
    animation: spin 700ms linear infinite;
    vertical-align: -2px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="product-page">

  <div class="prod-header-row">
    <div>
      <div class="prod-header-title">
        {{ product.name|default:"Untitled product" }}
      </div>
      <div class="prod-header-sub">
        Code {{ product.product_code|default:"N/A" }}
        {% if product.is_active %}
          ¬∑ Active
        {% else %}
          ¬∑ Archived
        {% endif %}
      </div>
    </div>

    <div class="btn-row">
      <a href="{% url 'products_list' %}" class="btn-pill">‚Üê Back</a>
      <a href="{% url 'product_edit' product.pk %}" class="btn-pill btn-gold">‚úé Edit</a>
    </div>
  </div>

  <div class="prod-main-grid">

    <div class="prod-card">
      <div class="prod-card-title">
        <span>Preview</span>
        {% if product.is_active %}
          <span class="pill">Active</span>
        {% else %}
          <span class="pill">Archived</span>
        {% endif %}
      </div>

      <div class="prod-image-wrap">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}">
        {% else %}
          <div class="prod-image-placeholder">
            No image yet. Upload one on the edit page.
          </div>
        {% endif %}
      </div>

      <div class="badge-row">
        <div class="badge-pill">
          <strong>Type</strong>
          <span>{{ product.get_product_type_display|default:product.product_type|default:"Not set" }}</span>
        </div>
        <div class="badge-pill">
          <strong>Category</strong>
          <span>{{ product.get_product_category_display|default:product.product_category|default:"Not set" }}</span>
        </div>
        <div class="badge-pill badge-muted">
          <strong>MOQ</strong>
          <span>
            {% if product.default_moq %}{{ product.default_moq }}{% else %}Not set{% endif %}
          </span>
        </div>
      </div>

      <div class="prod-code-label">
        Product code {{ product.product_code|default:"Not set" }}
      </div>
    </div>

    <div class="prod-card">
      <div class="prod-card-title">
        <span>Product information</span>
      </div>

      <div class="info-grid">

        <div class="info-row">
          <div class="info-label">Name</div>
          <div class="info-value">{{ product.name|default:"Not set" }}</div>
        </div>

        <div class="info-row">
          <div class="info-label">Default GSM</div>
          <div class="info-value">
            {% if product.default_gsm %}{{ product.default_gsm }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Default fabric</div>
          <div class="info-value">
            {% if product.default_fabric %}{{ product.default_fabric }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Default MOQ</div>
          <div class="info-value">
            {% if product.default_moq %}{{ product.default_moq }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Default price</div>
          <div class="info-value">
            {% if product.default_price %}{{ product.default_price }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Created</div>
          <div class="info-value">
            {% if product.created_at %}{{ product.created_at|date:"Y-m-d H:i" }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

        <div class="info-row">
          <div class="info-label">Last updated</div>
          <div class="info-value">
            {% if product.updated_at %}{{ product.updated_at|date:"Y-m-d H:i" }}{% else %}<span class="info-muted">Not set</span>{% endif %}
          </div>
        </div>

      </div>
    </div>

  </div>

  <div class="notes-card">
    <div class="notes-title">
      <span>Notes</span>
      <span class="pill">Saved text lives here</span>
    </div>
    <div class="notes-body" id="product-notes-body">
      {% if product.notes %}
        {{ product.notes }}
      {% else %}
        <span class="info-muted">No notes yet. AI answers from this page can be saved into notes.</span>
      {% endif %}
    </div>
  </div>

  <div class="ai-card">
    <div class="ai-header">
      <div class="ai-title">ü§ñ AI help for this product</div>
      <div class="ai-status" id="ai-prod-detail-status">Ready</div>
    </div>

    <div class="ai-note">
      Uses this product data. The server can also save the answer into notes.
    </div>

    <div class="ai-chip-row">
      <button type="button" class="ai-chip" data-mode="summary">Summary</button>
      <button type="button" class="ai-chip" data-mode="use_cases">Use cases</button>
      <button type="button" class="ai-chip" data-mode="costing">Costing view</button>
      <button type="button" class="ai-chip" data-mode="bundle">Bundle ideas</button>
      <button type="button" class="ai-chip" data-mode="email">Email draft</button>
      <button type="button" class="ai-chip" data-mode="spec">Spec reminder</button>
    </div>

    <div class="ai-output" id="ai-prod-detail-output">AI answer will appear here.</div>

    <div class="ai-chat-box">
      <div class="ai-note">Custom question for this product</div>

      <div class="ai-chat-input-row">
        <input
          type="text"
          id="ai-prod-chat-input"
          placeholder="Example: Write a short sales pitch for this product"
          autocomplete="off"
        >
        <button type="button" class="btn-pill btn-gold" id="ai-prod-chat-btn">Ask AI</button>
      </div>

      <div class="ai-chat-log" id="ai-prod-chat-log">
        <div class="info-muted" id="ai-chat-placeholder">Chat history will show here.</div>
      </div>
    </div>

    <form id="ai-prod-detail-csrf" style="display:none;">
      {% csrf_token %}
    </form>
  </div>

</div>

<script>
  (function () {
    const statusBox = document.getElementById("ai-prod-detail-status");
    const outBox = document.getElementById("ai-prod-detail-output");
    const chipNodes = document.querySelectorAll(".ai-chip");
    const chatInput = document.getElementById("ai-prod-chat-input");
    const chatBtn = document.getElementById("ai-prod-chat-btn");
    const chatLog = document.getElementById("ai-prod-chat-log");
    const chatPlaceholder = document.getElementById("ai-chat-placeholder");

    let isBusy = false;

    function getCsrf() {
      const tokenField = document.querySelector("#ai-prod-detail-csrf input[name='csrfmiddlewaretoken']");
      return tokenField ? tokenField.value : "";
    }

    function setStatus(text, spinning) {
      if (!statusBox) return;
      if (spinning) {
        statusBox.innerHTML = "<span class='ai-spinner'></span> " + text;
      } else {
        statusBox.textContent = text;
      }
    }

    function setBusy(on) {
      isBusy = on;

      chipNodes.forEach(function (c) {
        c.setAttribute("aria-disabled", on ? "true" : "false");
        if (on) c.classList.add("is-busy");
        else c.classList.remove("is-busy");
      });

      if (chatBtn) chatBtn.disabled = on;
      if (chatInput) chatInput.disabled = on;
    }

    function clearActiveChips() {
      chipNodes.forEach(function (c) { c.classList.remove("active"); });
    }

    function addLine(tag, text) {
      if (!chatLog) return;

      if (chatPlaceholder && chatPlaceholder.parentNode) {
        chatPlaceholder.parentNode.removeChild(chatPlaceholder);
      }

      const line = document.createElement("div");
      line.className = "chat-line";

      const t = document.createElement("span");
      t.className = "chat-tag";
      t.textContent = tag + ":";

      const msg = document.createElement("span");
      msg.textContent = " " + (text || "");

      line.appendChild(t);
      line.appendChild(msg);

      chatLog.appendChild(line);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function safeText(s) {
      return (s || "").toString();
    }

    function callProductAi(mode, extraData, clickedChip) {
      if (isBusy) return;

      setBusy(true);
      setStatus("Thinking", true);
      if (outBox) outBox.textContent = "";

      if (clickedChip) {
        clearActiveChips();
        clickedChip.classList.add("active");
      } else {
        clearActiveChips();
      }

      const body = { mode: mode };
      if (extraData) {
        for (const k in extraData) body[k] = extraData[k];
      }

      fetch("{% url 'product_ai_detail' product.pk %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrf()
        },
        body: new URLSearchParams(body)
      })
      .then(async function (res) {
        const isJson = (res.headers.get("content-type") || "").includes("application/json");
        const data = isJson ? await res.json() : { ok: false, error: "Server response was not JSON." };
        if (!res.ok) {
          return { ok: false, error: data.error || ("Request failed. Status " + res.status) };
        }
        return data;
      })
      .then(function (data) {
        if (data && data.ok) {
          const text = safeText(data.text) || "No answer from AI.";
          if (outBox) outBox.textContent = text;

          if (data.saved) setStatus("Saved into notes", false);
          else setStatus("Ready", false);

          if (mode === "chat") addLine("AI", text);
          else addLine("AI", "[" + mode + "] " + text);
        } else {
          if (outBox) outBox.textContent = safeText((data && data.error) ? data.error : "AI could not answer.");
          setStatus("Error", false);
        }
      })
      .catch(function () {
        if (outBox) outBox.textContent = "Error talking to AI.";
        setStatus("Error", false);
      })
      .finally(function () {
        setBusy(false);
      });
    }

    chipNodes.forEach(function (chip) {
      chip.addEventListener("click", function () {
        if (isBusy) return;
        const mode = chip.getAttribute("data-mode");
        callProductAi(mode, {}, chip);
      });
    });

    function askChat() {
      const question = (chatInput && chatInput.value) ? chatInput.value.trim() : "";
      if (!question || isBusy) return;

      addLine("You", question);
      chatInput.value = "";
      callProductAi("chat", { user_text: question }, null);
    }

    if (chatBtn) {
      chatBtn.addEventListener("click", function () {
        askChat();
      });
    }

    if (chatInput) {
      chatInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          askChat();
        }
      });
    }
  })();
</script>

{% endblock %}