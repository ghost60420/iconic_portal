{% extends "crm/base.html" %}
{% load static %}
{% block content %}

<style>
  :root{
    --bg:#060606;
    --panel:#0b0d10;
    --panel2:#0f172a;
    --border:#2a2f38;
    --text:#f8f9fa;
    --muted:#a8b0bd;
    --gold1:#ffe39b;
    --gold2:#e4c067;
  }

  .fabric-page{
    max-width: 1180px;
    margin: 18px auto 34px auto;
    padding: 0 10px;
    color: var(--text);
  }

  .header-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 12px;
    flex-wrap:wrap;
    margin-bottom: 14px;
  }

  .title{
    font-size: 22px;
    font-weight: 900;
    color: #ffffff;
    line-height: 1.2;
  }

  .sub{
    margin-top: 6px;
    font-size: 12px;
    color: rgba(248,249,250,0.65);
    font-weight: 800;
  }

  .btn-row{
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    align-items:center;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 13px;
    font-weight: 900;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color: #f3f4f6;
    cursor:pointer;
    user-select:none;
    line-height: 1;
    transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
    text-decoration:none;
    white-space:nowrap;
  }

  .btn:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,0.06);
    border-color: rgba(245, 213, 128, 0.32);
    color: var(--gold1);
  }

  .btn:active{ transform: translateY(0px); }

  .btn-gold{
    border-color: rgba(255, 227, 155, 0.30);
    background: rgba(245, 213, 128, 0.16);
    color: var(--gold1);
    box-shadow: 0 10px 22px rgba(255, 209, 120, 0.10);
  }

  .btn-gold:hover{
    background: rgba(245, 213, 128, 0.22);
    color: #fff;
  }

  .btn-small{
    padding: 9px 10px;
    font-size: 12px;
  }

  .layout{
    display:grid;
    grid-template-columns: 1.65fr 1fr;
    gap: 16px;
    align-items:start;
  }

  @media (max-width: 980px){
    .layout{ grid-template-columns: 1fr; }
  }

  .card{
    background: linear-gradient(180deg, rgba(15,23,42,0.55), rgba(2,6,23,0.70));
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.45);
    margin-bottom: 12px;
  }

  .card-title{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    flex-wrap:wrap;
    font-size: 14px;
    font-weight: 900;
    color: var(--gold1);
    margin-bottom: 10px;
  }

  .pill-row{
    display:flex;
    gap: 6px;
    flex-wrap:wrap;
    align-items:center;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 900;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color: rgba(248,249,250,0.92);
    white-space:nowrap;
  }

  .pill strong{
    color: var(--gold1);
    font-weight: 900;
  }

  .top-flex{
    display:flex;
    gap: 14px;
    flex-wrap:wrap;
    align-items:flex-start;
  }

  .img-box{
    width: 190px;
    height: 190px;
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    background: rgba(0,0,0,0.22);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex: 0 0 auto;
  }

  .img-box img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    display:block;
  }

  .img-placeholder{
    font-size: 12px;
    color: rgba(248,249,250,0.55);
    font-weight: 800;
    text-align:center;
    padding: 10px;
  }

  .meta{
    flex: 1 1 auto;
    min-width: 260px;
  }

  .meta-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  @media (max-width: 640px){
    .meta-grid{ grid-template-columns: 1fr; }
  }

  .meta-row{
    padding: 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.03);
  }

  .meta-label{
    font-size: 11px;
    color: rgba(248,249,250,0.55);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    margin-bottom: 4px;
  }

  .meta-value{
    font-size: 13px;
    color: rgba(248,249,250,0.95);
    font-weight: 800;
    line-height: 1.35;
    word-break: break-word;
  }

  .muted{
    color: rgba(248,249,250,0.55);
  }

  .notes-box{
    background: rgba(0,0,0,0.22);
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 12px;
    min-height: 100px;
    font-size: 13px;
    color: rgba(248,249,250,0.92);
    white-space: pre-wrap;
    line-height: 1.5;
  }

  /* AI */
  .ai-note{
    font-size: 12px;
    color: rgba(248,249,250,0.65);
    font-weight: 800;
    line-height: 1.4;
    margin-top: 2px;
  }

  .ai-chip-row{
    margin-top: 10px;
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    align-items:center;
  }

  .ai-chip{
    background: rgba(255,255,255,0.04);
    color: rgba(248,249,250,0.92);
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 900;
    cursor:pointer;
    user-select:none;
    transition: transform 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
    display:inline-flex;
    align-items:center;
    gap: 8px;
  }

  .ai-chip:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,0.06);
    border-color: rgba(245, 213, 128, 0.32);
    color: var(--gold1);
  }

  .ai-chip.active{
    border-color: rgba(245, 213, 128, 0.55);
    background: rgba(245, 213, 128, 0.10);
    color: var(--gold1);
  }

  .ai-chip[aria-disabled="true"]{
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
  }

  .ai-status{
    margin-top: 10px;
    font-size: 12px;
    color: rgba(248,249,250,0.70);
    font-weight: 800;
  }

  .ai-output{
    margin-top: 10px;
    background: rgba(0,0,0,0.22);
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 12px;
    min-height: 110px;
    font-size: 13px;
    color: rgba(248,249,250,0.92);
    white-space: pre-wrap;
    line-height: 1.5;
  }

  .compare-box{
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(148,163,184,0.18);
  }

  .field-label{
    font-size: 11px;
    color: rgba(248,249,250,0.55);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.2px;
    margin-bottom: 6px;
  }

  .input{
    width: 100%;
    background: rgba(255,255,255,0.04);
    color: var(--text);
    border: 1px solid rgba(255,255,255,0.12);
    padding: 10px 12px;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 800;
    outline: none;
  }

  .input:focus{
    border-color: rgba(245, 213, 128, 0.45);
    box-shadow: 0 0 0 3px rgba(245,213,128,0.14);
  }

  .chat-box{
    margin-top: 12px;
    border-top: 1px solid rgba(148,163,184,0.18);
    padding-top: 10px;
  }

  .chat-row{
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom: 10px;
  }

  .chat-row .input{
    flex: 1 1 240px;
  }

  .chat-log{
    max-height: 210px;
    overflow-y: auto;
    background: rgba(0,0,0,0.22);
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.22);
    padding: 12px;
    font-size: 13px;
    color: rgba(248,249,250,0.92);
  }

  .chat-line{
    padding-bottom: 10px;
    margin-bottom: 10px;
    border-bottom: 1px solid rgba(148,163,184,0.14);
  }

  .chat-line:last-child{
    padding-bottom: 0;
    margin-bottom: 0;
    border-bottom: none;
  }

  .chat-tag{
    font-weight: 900;
    color: var(--gold1);
    margin-right: 8px;
  }

  .spinner{
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(229,231,235,0.35);
    border-top-color: rgba(245,213,128,0.95);
    display:inline-block;
    animation: spin 700ms linear infinite;
    vertical-align: -2px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="fabric-page">

  <div class="header-row">
    <div>
      <div class="title">
        {{ fabric.name|default:"Fabric detail" }}
      </div>
      <div class="sub">
        {% if fabric.fabric_code %}
          Code {{ fabric.fabric_code }}
        {% else %}
          Code not set
        {% endif %}
        {% if fabric.created_at %}
          ¬∑ Created {{ fabric.created_at|date:"Y-m-d H:i" }}
        {% endif %}
      </div>
    </div>

    <div class="btn-row">
      <a href="{% url 'fabrics_list' %}" class="btn">‚Üê Back</a>
      <a href="{% url 'fabric_edit' fabric.pk %}" class="btn btn-gold">‚úé Edit</a>
    </div>
  </div>

  <div class="layout">

    <div>
      <div class="card">
        <div class="card-title">
          <span>Fabric overview</span>
          <div class="pill-row">
            <div class="pill"><strong>Group</strong> {{ fabric.fabric_group|default:"Not set" }}</div>
            <div class="pill"><strong>Type</strong> {{ fabric.fabric_type|default:"Not set" }}</div>
            <div class="pill"><strong>GSM</strong> {{ fabric.gsm|default:"Not set" }}</div>
          </div>
        </div>

        <div class="top-flex">
          <div class="img-box">
            {% if fabric.image %}
              <img src="{{ fabric.image.url }}" alt="{{ fabric.name }}">
            {% else %}
              <div class="img-placeholder">No image</div>
            {% endif %}
          </div>

          <div class="meta">
            <div class="meta-grid">

              <div class="meta-row">
                <div class="meta-label">Structure</div>
                <div class="meta-value">
                  {{ fabric.knit_structure|default:fabric.weave|default:"Not set" }}
                </div>
              </div>

              <div class="meta-row">
                <div class="meta-label">Composition</div>
                <div class="meta-value">{{ fabric.composition|default:"Not set" }}</div>
              </div>

              <div class="meta-row">
                <div class="meta-label">Price per kg</div>
                <div class="meta-value">
                  {% if fabric.price_per_kg %}{{ fabric.price_per_kg }}{% else %}<span class="muted">Not set</span>{% endif %}
                </div>
              </div>

              <div class="meta-row">
                <div class="meta-label">Price per meter</div>
                <div class="meta-value">
                  {% if fabric.price_per_meter %}{{ fabric.price_per_meter }}{% else %}<span class="muted">Not set</span>{% endif %}
                </div>
              </div>

            </div>
          </div>
        </div>

        <div style="margin-top:12px;" class="meta-grid">

          <div class="meta-row">
            <div class="meta-label">Stretch</div>
            <div class="meta-value">{{ fabric.stretch_type|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Surface</div>
            <div class="meta-value">{{ fabric.surface|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Handfeel</div>
            <div class="meta-value">{{ fabric.handfeel|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Drape</div>
            <div class="meta-value">{{ fabric.drape|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Warmth</div>
            <div class="meta-value">{{ fabric.warmth|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Weight class</div>
            <div class="meta-value">{{ fabric.weight_class|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Breathability</div>
            <div class="meta-value">{{ fabric.breathability|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Sheerness</div>
            <div class="meta-value">{{ fabric.sheerness|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Shrinkage</div>
            <div class="meta-value">{{ fabric.shrinkage|default:"Not set" }}</div>
          </div>

          <div class="meta-row">
            <div class="meta-label">Durability</div>
            <div class="meta-value">{{ fabric.durability|default:"Not set" }}</div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>Color and notes</span>
        </div>

        <div class="meta-grid" style="margin-bottom:12px;">
          <div class="meta-row">
            <div class="meta-label">Color options</div>
            <div class="meta-value">{{ fabric.color_options|default:"Not set" }}</div>
          </div>
          <div class="meta-row">
            <div class="meta-label">Last updated</div>
            <div class="meta-value">
              {% if fabric.updated_at %}{{ fabric.updated_at|date:"Y-m-d H:i" }}{% else %}<span class="muted">Not set</span>{% endif %}
            </div>
          </div>
        </div>

        <div class="sub" style="margin-bottom:8px;">
          AI answers are also saved in notes for this fabric.
        </div>

        <div class="notes-box" id="fabric-notes-box">
          {% if fabric.notes %}
            {{ fabric.notes }}
          {% else %}
            <span class="muted">No notes yet. Use AI to create notes.</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="card-title">
          <span>ü§ñ AI fabric assistant</span>
          <span class="muted" id="ai-status">Ready</span>
        </div>

        <div class="ai-note">
          Uses the fabric info on this page and saves answers into notes.
        </div>

        <div class="ai-chip-row" id="ai-chip-row">
          <div class="ai-chip" data-mode="summary">Summary</div>
          <div class="ai-chip" data-mode="use_cases">Use cases</div>
          <div class="ai-chip" data-mode="ideal_products">Ideal products</div>
          <div class="ai-chip" data-mode="costing">Costing view</div>
          <div class="ai-chip" data-mode="properties">Properties</div>
          <div class="ai-chip" data-mode="bom">BOM idea</div>
          <div class="ai-chip" data-mode="moq_lead">MOQ and lead</div>
        </div>

        <div class="ai-output" id="ai-output">AI answer will appear here.</div>

        <div class="compare-box">
          <div class="field-label">Compare with another fabric</div>
          <input
            id="ai-compare-input"
            class="input"
            type="text"
            placeholder="Example 280 gsm brushed fleece, cotton rich"
            autocomplete="off"
          >
          <div style="margin-top:10px;">
            <button type="button" class="btn btn-gold btn-small" id="ai-compare-btn">
              Compare
            </button>
          </div>
        </div>

        <div class="chat-box">
          <div class="ai-note">Ask a custom question for this fabric</div>

          <div class="chat-row">
            <input
              type="text"
              id="ai-chat-input"
              class="input"
              placeholder="Example Is this fabric good for winter hoodies"
              autocomplete="off"
            >
            <button type="button" class="btn btn-gold btn-small" id="ai-chat-btn">Ask</button>
          </div>

          <div class="chat-log" id="ai-chat-log">
            <div class="muted" id="ai-chat-placeholder">
              Chat history will show here. Answers are also saved in notes.
            </div>
          </div>
        </div>

        <form id="fabric-ai-csrf" style="display:none;">
          {% csrf_token %}
        </form>
      </div>
    </div>

  </div>

</div>

<script>
  (function () {
    const statusBox = document.getElementById("ai-status");
    const outputBox = document.getElementById("ai-output");
    const chipRow = document.getElementById("ai-chip-row");
    const chipNodes = document.querySelectorAll(".ai-chip");

    const chatInput = document.getElementById("ai-chat-input");
    const chatBtn = document.getElementById("ai-chat-btn");
    const chatLog = document.getElementById("ai-chat-log");
    const chatPlaceholder = document.getElementById("ai-chat-placeholder");

    const compareInput = document.getElementById("ai-compare-input");
    const compareBtn = document.getElementById("ai-compare-btn");

    let busy = false;

    function getCsrf() {
      const token = document.querySelector("#fabric-ai-csrf input[name='csrfmiddlewaretoken']");
      return token ? token.value : "";
    }

    function safeText(s) {
      return (s || "").toString();
    }

    function setBusy(on) {
      busy = on;

      chipNodes.forEach(function (c) {
        c.setAttribute("aria-disabled", on ? "true" : "false");
      });

      if (chatBtn) chatBtn.disabled = on;
      if (compareBtn) compareBtn.disabled = on;
      if (chatInput) chatInput.disabled = on;
      if (compareInput) compareInput.disabled = on;

      if (statusBox) {
        statusBox.innerHTML = on ? "<span class='spinner'></span> Thinking" : "Ready";
      }
    }

    function clearActive() {
      chipNodes.forEach(function (c) { c.classList.remove("active"); });
    }

    function addChatLine(tag, text) {
      if (!chatLog) return;

      if (chatPlaceholder && chatPlaceholder.parentNode) {
        chatPlaceholder.parentNode.removeChild(chatPlaceholder);
      }

      const line = document.createElement("div");
      line.className = "chat-line";

      const t = document.createElement("span");
      t.className = "chat-tag";
      t.textContent = tag + ":";

      const msg = document.createElement("span");
      msg.textContent = " " + safeText(text);

      line.appendChild(t);
      line.appendChild(msg);

      chatLog.appendChild(line);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function callFabricAi(mode, extraData, clickedChip) {
      if (busy) return;
      setBusy(true);
      if (outputBox) outputBox.textContent = "";

      if (clickedChip) {
        clearActive();
        clickedChip.classList.add("active");
      } else {
        clearActive();
      }

      const body = { mode: mode };
      if (extraData) {
        for (const k in extraData) body[k] = extraData[k];
      }

      fetch("{% url 'fabric_ai_detail' fabric.pk %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCsrf()
        },
        body: new URLSearchParams(body).toString()
      })
      .then(function (res) {
        const isJson = (res.headers.get("content-type") || "").includes("application/json");
        if (!isJson) throw new Error("Non JSON response");
        return res.json();
      })
      .then(function (data) {
        if (data && data.ok) {
          const text = safeText(data.text) || "No answer from AI.";
          if (outputBox) outputBox.textContent = text;

          if (mode === "chat") addChatLine("AI", text);
          else addChatLine("AI", "[" + mode + "] " + text);

          if (statusBox) statusBox.textContent = "Saved into notes";
        } else {
          if (outputBox) outputBox.textContent = safeText(data && data.error ? data.error : "AI could not answer.");
          if (statusBox) statusBox.textContent = "Error";
        }
      })
      .catch(function (err) {
        console.error(err);
        if (outputBox) outputBox.textContent = "Error talking to AI.";
        if (statusBox) statusBox.textContent = "Error";
      })
      .finally(function () {
        setBusy(false);
      });
    }

    chipNodes.forEach(function (chip) {
      chip.addEventListener("click", function () {
        const mode = chip.getAttribute("data-mode");
        callFabricAi(mode, {}, chip);
      });
    });

    if (compareBtn) {
      compareBtn.addEventListener("click", function () {
        const text = (compareInput && compareInput.value) ? compareInput.value.trim() : "";
        if (!text) {
          if (outputBox) outputBox.textContent = "Please type the other fabric first.";
          return;
        }
        addChatLine("You", "Compare with: " + text);
        callFabricAi("compare", { compare_text: text }, null);
      });
    }

    function askChat() {
      const question = (chatInput && chatInput.value) ? chatInput.value.trim() : "";
      if (!question || busy) return;

      addChatLine("You", question);
      chatInput.value = "";
      callFabricAi("chat", { user_text: question }, null);
    }

    if (chatBtn) {
      chatBtn.addEventListener("click", function () {
        askChat();
      });
    }

    if (chatInput) {
      chatInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          askChat();
        }
      });
    }
  })();
</script>

{% endblock %}