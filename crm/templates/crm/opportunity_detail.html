{% extends "crm/base.html" %}
{% load static %}
{% block content %}

<style>
    .page-opp {
        max-width: 1200px;
        margin: 16px auto 28px auto;
        padding: 0 8px;
        color: #f9fafb;
    }

    a {
        color: #fbbf24;
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
    }

    .opp-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .opp-header-left {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .opp-title {
        font-size: 20px;
        font-weight: 700;
        color: #fefce8;
    }

    .opp-sub {
        font-size: 12px;
        color: #e5e7eb;
    }

    .opp-stage-pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        font-size: 11px;
        border-radius: 999px;
        border: 1px solid #facc15;
        background: rgba(250, 204, 21, 0.15);
        color: #fefce8;
    }

    .opp-header-right .btn {
        margin-left: 3px;
        margin-bottom: 3px;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid transparent;
        font-size: 12px;
        cursor: pointer;
        text-decoration: none;
        white-space: nowrap;
        user-select: none;
    }

    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .btn-gold {
        background: linear-gradient(135deg, #facc15, #f97316);
        color: #111827;
        border-color: #fbbf24;
        font-weight: 600;
    }

    .btn-gold-soft {
        background: rgba(250, 204, 21, 0.12);
        color: #facc15;
        border-color: #facc15;
    }

    .btn-blue {
        background: rgba(56, 189, 248, 0.12);
        color: #7dd3fc;
        border-color: #0ea5e9;
    }

    .btn-slate {
        background: #020617;
        color: #e5e7eb;
        border-color: #374151;
    }

    .btn-small {
        padding: 3px 8px;
        font-size: 11px;
    }

    .btn-outline-warning {
        background: rgba(250, 204, 21, 0.10);
        color: #facc15;
        border-color: #facc15;
    }

    .btn-outline-warning:hover {
        background: rgba(250, 204, 21, 0.18);
        color: #ffe9a8;
        text-decoration: none;
    }

    .card {
        background: radial-gradient(circle at top left, #020617, #020617);
        border: 1px solid #1f2937;
        border-radius: 10px;
        padding: 8px 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }

    .card-strong {
        background: radial-gradient(circle at top left, #111827, #020617);
    }

    .card-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #fefce8;
        border-bottom: 1px solid #111827;
        padding-bottom: 3px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .card-title span.emoji {
        font-size: 15px;
    }

    .card-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-bottom: 10px;
    }

    .section {
        margin-top: 12px;
    }

    .section-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #fefce8;
    }

    table.info-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

    table.info-table td {
        padding: 2px 2px;
        vertical-align: top;
    }

    .label {
        color: #9ca3af;
        width: 110px;
        font-size: 11px;
    }

    .value-main {
        color: #f9fafb;
        font-size: 12px;
    }

    .value-soft {
        color: #e5e7eb;
        font-size: 12px;
    }

    .muted {
        color: #9ca3af;
        font-size: 11px;
    }

    .pill {
        display: inline-flex;
        align-items: center;
        padding: 1px 7px;
        border-radius: 999px;
        border: 1px solid #4b5563;
        font-size: 11px;
        color: #e5e7eb;
        background: #020617;
    }

    .pill-green {
        border-color: #22c55e;
        color: #bbf7d0;
        background: rgba(34, 197, 94, 0.1);
    }

    .pill-red {
        border-color: #f97373;
        color: #fecaca;
        background: rgba(239, 68, 68, 0.18);
    }

    .ai-smart-card {
        margin-bottom: 10px;
    }

    .ai-smart-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: center;
        margin-bottom: 4px;
    }

    .ai-smart-title {
        font-size: 14px;
        font-weight: 600;
        color: #fefce8;
    }

    .ai-smart-note {
        font-size: 11px;
        color: #e5e7eb;
    }

    .ai-chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin: 4px 0 6px 0;
    }

    .ai-smart-status {
        font-size: 11px;
        color: #9ca3af;
        text-align: right;
    }

    .ai-smart-output {
        margin-top: 6px;
        background: #020617;
        border-radius: 8px;
        border: 1px solid #1f2937;
        padding: 6px;
        min-height: 70px;
        font-size: 12px;
        color: #e5e7eb;
        white-space: pre-wrap;
    }

    textarea,
    input,
    select {
        background: #020617;
        color: #f9fafb;
        border: 1px solid #374151;
        padding: 4px 6px;
        font-size: 12px;
        border-radius: 6px;
        width: 100%;
    }

    textarea:focus,
    input:focus,
    select:focus {
        outline: none;
        border-color: #facc15;
        box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.4);
    }

    textarea { resize: vertical; }

    ul.simple-list {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    ul.simple-list li {
        padding: 3px 0;
        font-size: 12px;
        color: #e5e7eb;
    }

    details summary { cursor: pointer; }

    .inline-field-row {
        display: flex;
        gap: 6px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .calendar-wrap {
        position: relative;
        width: 100%;
    }

    .calendar-btn {
        width: auto;
        padding: 4px 10px;
    }

    .ship-actions {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
        align-items: center;
        margin-top: 6px;
        flex-wrap: wrap;
    }

    .input-locked {
        opacity: 0.8;
    }

    .ship-saved-pill {
        display: none;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        border: 1px solid #22c55e;
        color: #bbf7d0;
        background: rgba(34, 197, 94, 0.12);
        padding: 3px 8px;
        border-radius: 999px;
        margin-right: auto;
    }

    @media (max-width: 992px) {
        .grid-3 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    @media (max-width: 768px) {
        .grid-3 {
            grid-template-columns: minmax(0, 1fr);
        }
        .opp-header {
            align-items: flex-start;
        }
    }
</style>

<div class="page-opp">

    <div class="opp-header card card-strong">
        <div class="opp-header-left">
            <div class="opp-title">
                üéØ {{ opportunity.opportunity_id }} / {{ lead.account_brand }}
            </div>
            <div class="opp-sub">
                Stage
                <span class="opp-stage-pill">
                    ‚öôÔ∏è {{ opportunity.get_stage_display }}
                </span>
                &nbsp; | &nbsp;
                Created {{ opportunity.created_date }}
            </div>
        </div>
        <div class="opp-header-right">
            <a href="{% url 'opportunities_list' %}" class="btn btn-slate btn-small">All opportunities</a>
            {% if opportunity.lead %}
            <a href="{% url 'lead_detail' opportunity.lead.pk %}" class="btn btn-blue btn-small">
                View lead
            </a>
            {% endif %}
            <a href="{% url 'production_from_opportunity' opportunity.pk %}" class="btn btn-gold btn-small">
                Open production order
            </a>
        </div>
    </div>

    <div class="card card-strong ai-smart-card">
        <div class="ai-smart-header">
            <div>
                <div class="ai-smart-title">ü§ñ AI view for this deal</div>
                <div class="ai-smart-note">
                    AI reads lead, customer and deal data and gives you next steps, risk, product ideas and email text.
                </div>
            </div>
            <div id="opp-ai-status" class="ai-smart-status"></div>
        </div>

        <div class="ai-chip-row">
            <button type="button" class="btn btn-gold-soft btn-small" data-opp-mode="summary">Summary</button>
            <button type="button" class="btn btn-blue btn-small" data-opp-mode="next_steps">Next steps</button>
            <button type="button" class="btn btn-slate btn-small" data-opp-mode="risk">Risk check</button>
            <button type="button" class="btn btn-slate btn-small" data-opp-mode="products">Product ideas</button>
            <button type="button" class="btn btn-gold-soft btn-small" data-opp-mode="timeline">Simple time line</button>
        </div>

        <div style="margin-top:4px; font-size:12px;">
            <div style="margin-bottom:3px; color:#facc15;">
                Email follow up helper
            </div>
            <textarea
                id="opp-ai-email-body"
                rows="2"
                placeholder="Write a few points for the email and AI will turn it into a clean message."
            ></textarea>
            <button
                type="button"
                class="btn btn-gold btn-small"
                id="opp-ai-email-btn"
                style="margin-top:4px;"
            >
                Create email with AI
            </button>
        </div>

        <div style="margin-top:6px;">
            <div style="font-size:12px; color:#facc15; margin-bottom:3px;">
                Ask a custom question
            </div>
            <div style="display:flex; gap:6px; margin-bottom:4px;">
                <input
                    type="text"
                    id="opp-ai-chat-input"
                    placeholder="Example: What should I do before sending a quote"
                    style="flex:1;"
                >
                <button type="button" class="btn btn-blue btn-small" id="opp-ai-chat-btn">
                    Ask AI
                </button>
            </div>
        </div>

        <div id="opp-ai-output" class="ai-smart-output">
            AI answer will appear here. It is also saved as an AI note for this opportunity.
        </div>

        <form id="opp-ai-csrf" style="display:none;">
            {% csrf_token %}
        </form>
    </div>

    <div class="grid-3">

        <div class="card">

            <div class="card-title-row">
                <div class="card-title" style="margin:0; border-bottom:none; padding-bottom:0;">
                    <span class="emoji">üìå</span> Opportunity info
                </div>

                <a class="btn btn-outline-warning btn-small"
                   href="{% url 'opportunity_edit' opportunity.pk %}">
                    Edit
                </a>
            </div>

            <table class="info-table">
                <tr>
                    <td class="label">Brand</td>
                    <td class="value-main">{{ lead.account_brand }}</td>
                </tr>
                <tr>
                    <td class="label">Stage</td>
                    <td class="value-main">{{ opportunity.get_stage_display }}</td>
                </tr>
                <tr>
                    <td class="label">Product type</td>
                    <td class="value-main">{{ opportunity.product_type }}</td>
                </tr>
                <tr>
                    <td class="label">Product category</td>
                    <td class="value-main">{{ opportunity.product_category }}</td>
                </tr>
                <tr>
                    <td class="label">MOQ units</td>
                    <td class="value-main">
                        {% if opportunity.moq_units %}
                            {{ opportunity.moq_units }}
                        {% else %}
                            <span class="muted">None</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Order value taka</td>
                    <td class="value-main">
                        {% if opportunity.order_value %}
                            {{ opportunity.order_value }}
                        {% else %}
                            <span class="muted">Not set</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Open</td>
                    <td class="value-main">
                        {% if opportunity.is_open %}
                            <span class="pill pill-green">Open</span>
                        {% else %}
                            <span class="pill pill-red">Closed</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Next follow up</td>
                    <td class="value-main">
                        {% if opportunity.next_followup %}
                            {{ opportunity.next_followup|date:"Y-m-d" }}
                        {% else %}
                            <span class="muted">Not set</span>
                        {% endif %}
                    </td>
                </tr>
            </table>

            <form method="post" style="margin-top:6px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_stage">

                <div class="inline-field-row" style="margin-bottom:4px;">
                    <div style="flex:1; min-width:190px;">
                        <label style="font-size:11px; color:#e5e7eb;">Stage</label>
                        <select name="stage">
                            {% for value,label in stage_choices %}
                                <option value="{{ value }}" {% if opportunity.stage == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div style="flex:1; min-width:190px;">
                        <label style="font-size:11px; color:#e5e7eb;">Next follow up</label>
                        <div class="inline-field-row">
                            <div style="flex:1;" class="calendar-wrap">
                                <input
                                    id="next-followup-date"
                                    type="date"
                                    name="next_followup"
                                    value="{% if opportunity.next_followup %}{{ opportunity.next_followup|date:'Y-m-d' }}{% endif %}"
                                >
                            </div>
                            <button type="button" class="btn btn-slate btn-small calendar-btn" id="next-followup-open">
                                üìÖ
                            </button>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:4px;">
                    <label style="font-size:11px; color:#e5e7eb;">
                        <input type="checkbox" name="is_open" {% if opportunity.is_open %}checked{% endif %}>
                        Opportunity is open
                    </label>
                </div>

                <button type="submit" class="btn btn-gold btn-small">
                    Save status
                </button>
            </form>

        </div>

        <div class="card">
            <div class="card-title">
                <span class="emoji">üí∞</span> Production and profit in taka
            </div>
            <table class="info-table">
                <tr>
                    <td class="label">Order value</td>
                    <td class="value-main">
                        {% if opportunity.order_value %}
                            {{ opportunity.order_value }}
                        {% else %}
                            <span class="muted">Not set</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Production cost BDT</td>
                    <td class="value-main">
                        {% if prod_total_actual_cost %}
                            {{ prod_total_actual_cost }}
                        {% else %}
                            <span class="muted">No production cost yet</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Shipping cost BDT</td>
                    <td class="value-main">
                        {% if shipping_cost_bdt_total %}
                            {{ shipping_cost_bdt_total }}
                        {% else %}
                            <span class="muted">No shipping cost yet</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Shipping cost CAD</td>
                    <td class="value-main">
                        {% if shipping_cost_cad_total %}
                            {{ shipping_cost_cad_total }}
                        {% else %}
                            <span class="muted">No shipping cost yet</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Total cost BDT</td>
                    <td class="value-main">
                        {% if total_cost_bdt %}
                            {{ total_cost_bdt }}
                        {% else %}
                            <span class="muted">Need production and shipping cost</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Profit after shipping</td>
                    <td class="value-main">
                        {% if profit_after_shipping is not None %}
                            {{ profit_after_shipping|floatformat:2 }}
                        {% else %}
                            <span class="muted">Need order value and cost</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="label">Profit after shipping percent</td>
                    <td class="value-main">
                        {% if profit_after_shipping_percent is not None %}
                            {{ profit_after_shipping_percent|floatformat:1 }} percent
                        {% else %}
                            <span class="muted">Need order value and cost</span>
                        {% endif %}
                    </td>
                </tr>
            </table>

            {% if prod_orders %}
                <p class="muted" style="margin-top:6px;">
                    Linked work orders
                    {% for po in prod_orders %}
                        üßµ <a href="{% url 'production_detail' po.pk %}">{{ po.title }}</a>
                        {% if not forloop.last %} | {% endif %}
                    {% endfor %}
                </p>
            {% else %}
                <p class="muted" style="margin-top:6px;">
                    No production work order yet.
                    When stage is set to Production a work order will be created.
                </p>
            {% endif %}
        </div>

        <div class="card">
            <div class="card-title">
                <span class="emoji">üì¶</span> Shipping info
            </div>

            <form method="post" id="shipping-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="save_shipping">

                <table class="info-table" id="shipping-table">
                    <tr>
                        <td class="label">Name</td>
                        <td>
                            <input class="ship-input" type="text" name="ship_name" value="{{ opportunity.ship_name|default:'' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Address 1</td>
                        <td>
                            <input class="ship-input" type="text" name="ship_address1" value="{{ opportunity.ship_address1|default:'' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Address 2</td>
                        <td>
                            <input class="ship-input" type="text" name="ship_address2" value="{{ opportunity.ship_address2|default:'' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">City</td>
                        <td>
                            <input class="ship-input" type="text" name="ship_city" value="{{ opportunity.ship_city|default:'' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">State</td>
                        <td>
                            <input class="ship-input" type="text" name="ship_state" value="{{ opportunity.ship_state|default:'' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Post code</td>
                        <td>
                            <input class="ship-input" type="text" name="ship_post_code" value="{{ opportunity.ship_post_code|default:'' }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="label">Country</td>
                        <td>
                            <input class="ship-input" type="text" name="ship_country" value="{{ opportunity.ship_country|default:'' }}">
                        </td>
                    </tr>
                </table>

                <div class="ship-actions">
                    <div class="ship-saved-pill" id="ship-saved-pill">Saved</div>

                    <button type="button" class="btn btn-slate btn-small" id="ship-edit-btn">
                        Edit
                    </button>

                    <button type="submit" class="btn btn-blue btn-small" id="ship-save-btn" style="margin-top:0;">
                        Save shipping
                    </button>
                </div>

                <div class="muted" style="margin-top:6px;">
                    Shipping locks after save. Click Edit to change it.
                </div>
            </form>
        </div>

    </div>

    <div class="section">
        <div class="section-title">Lead contact</div>
        <div class="card">
            <table class="info-table">
                <tr>
                    <td class="label">Contact name</td>
                    <td class="value-main">{{ lead.contact_name }}</td>
                </tr>
                <tr>
                    <td class="label">Email</td>
                    <td class="value-main">{{ lead.email }}</td>
                </tr>
                <tr>
                    <td class="label">Phone</td>
                    <td class="value-main">{{ lead.phone }}</td>
                </tr>
                <tr>
                    <td class="label">Market</td>
                    <td class="value-main">{{ lead.get_market_display }}</td>
                </tr>
                <tr>
                    <td class="label">Country</td>
                    <td class="value-main">{{ lead.country }}</td>
                </tr>
                <tr>
                    <td class="label">City</td>
                    <td class="value-main">{{ lead.city }}</td>
                </tr>
                <tr>
                    <td class="label">Product interest</td>
                    <td class="value-main">{{ lead.product_interest }}</td>
                </tr>
                <tr>
                    <td class="label">Order quantity</td>
                    <td class="value-main">{{ lead.order_quantity }}</td>
                </tr>
                <tr>
                    <td class="label">Budget</td>
                    <td class="value-main">{{ lead.budget }}</td>
                </tr>
            </table>

            <p class="muted" style="margin-top:6px;">
                Full lead view
                {% if opportunity.lead %}
                    <a href="{% url 'lead_detail' opportunity.lead.pk %}">
                        View lead
                    </a>
                {% endif %}
            </p>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Production linked to this opportunity</div>
        <div class="card">
            {% if prod_orders %}
                <table class="info-table">
                    <tr>
                        <td class="label">Number of orders</td>
                        <td class="value-main">{{ prod_orders|length }}</td>
                    </tr>
                    <tr>
                        <td class="label">Total pieces</td>
                        <td class="value-main">{{ prod_total_qty }}</td>
                    </tr>
                    <tr>
                        <td class="label">Total reject</td>
                        <td class="value-main">{{ prod_total_reject }}</td>
                    </tr>
                    <tr>
                        <td class="label">Total actual cost BDT</td>
                        <td class="value-main">{{ prod_total_actual_cost }}</td>
                    </tr>
                </table>

                <hr style="border-color:#111827; margin:6px 0;">

                <ul class="simple-list">
                    {% for po in prod_orders %}
                        <li>
                            üßµ
                            <a href="{% url 'production_detail' po.pk %}">
                                {{ po.title }}
                            </a>
                            <span class="muted">
                                ‚Ä¢ {{ po.qty_total }} pcs
                                ‚Ä¢ Status {{ po.get_status_display }}
                                {% if po.order_type %}
                                    ‚Ä¢ Type {{ po.get_order_type_display }}
                                {% endif %}
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="muted">
                    No production orders are linked yet.
                    When you create a production order and link this opportunity numbers will show here.
                </p>
            {% endif %}
        </div>
    </div>

    <div class="section">
        <div class="card">

            <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;">
                <div>
                    <div class="card-title" style="margin-bottom:2px;">
                        <span class="emoji">üì¶</span>
                        <span>Shipments and shipping cost</span>
                    </div>

                    {% if shipments %}
                        <div class="muted" style="font-size:11px;">
                            {{ shipments|length }} shipment{{ shipments|length|pluralize }} linked to this opportunity.
                        </div>
                    {% else %}
                        <div class="muted" style="font-size:11px;">
                            No shipments yet. Use Add shipment to record courier cost.
                        </div>
                    {% endif %}
                </div>

                <a href="{% url 'shipping_add_for_opportunity' opportunity.pk %}"
                   class="btn btn-gold btn-small">
                    Add shipment
                </a>
            </div>

            {% if shipments %}
                <div style="font-size:12px; margin-bottom:6px;">
                    <span class="pill pill-green">
                        Total shipping cost {{ shipping_cost_bdt }} taka
                    </span>
                    {% if shipping_cost_cad %}
                        <span class="pill" style="margin-left:4px;">
                            About {{ shipping_cost_cad }} cad
                        </span>
                    {% endif %}
                    <span class="muted" style="display:block; margin-top:2px;">
                        Shipping cost is already included in the profit in taka box above.
                    </span>
                </div>

                <div class="table-responsive" style="margin-top:4px;">
                    <table class="table table-dark table-sm table-striped mb-0" style="font-size:12px;">
                        <thead>
                        <tr>
                            <th>Date</th>
                            <th>Carrier</th>
                            <th>Tracking</th>
                            <th>Boxes</th>
                            <th>Weight kg</th>
                            <th>Cost BDT</th>
                            <th>Cost CAD</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for s in shipments %}
                            <tr>
                                <td>{{ s.ship_date|date:"Y-m-d"|default:"-" }}</td>
                                <td>{{ s.get_carrier_display }}</td>
                                <td>
                                    {% if s.tracking_number %}
                                        {% if s.tracking_url %}
                                            <a href="{{ s.tracking_url }}" target="_blank">
                                                {{ s.tracking_number }}
                                            </a>
                                        {% else %}
                                            {{ s.tracking_number }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ s.box_count|default:"-" }}</td>
                                <td>{{ s.total_weight_kg|default:"-" }}</td>
                                <td>{{ s.cost_bdt|default:"-" }}</td>
                                <td>{{ s.cost_cad|default:"-" }}</td>
                                <td>{{ s.get_status_display }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="muted mb-0" style="font-size:13px; margin-top:4px;">
                    Add a shipment when you book any courier. The cost will roll into the profit in taka box.
                </p>
            {% endif %}

        </div>
    </div>

    <div class="section">
        <details>
            <summary style="color:#facc15;">
                Old AI helper for this opportunity
            </summary>
            <div class="card" style="margin-top:6px;">
                {% if agents %}
                    <form method="post" style="margin-bottom:6px;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="ai_quick">
                        <label style="font-size:11px; color:#e5e7eb;">Quick AI action</label>
                        <select name="quick_action" style="margin-bottom:4px;">
                            <option value="summary">Summary</option>
                            <option value="client_profile">Client profile</option>
                            <option value="next_steps">Next steps</option>
                            <option value="cold_email">Cold email</option>
                            <option value="warm_followup">Warm follow up</option>
                            <option value="mood">Mood and intent</option>
                            <option value="product_reco">Product ideas</option>
                        </select>
                        <button type="submit" class="btn btn-gold btn-small">Run AI quick action</button>
                    </form>

                    <div class="muted" style="font-size:11px;">
                        This old area can stay, but your new AI card above is the main one.
                    </div>
                {% else %}
                    <p class="muted">
                        No AI agents configured yet.
                    </p>
                {% endif %}
            </div>
        </details>
    </div>

    <div class="section">
        <div class="section-title">Notes and chatter</div>
        <div class="card">
            <form method="post" style="margin-bottom: 8px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_comment">
                <textarea name="comment_text" rows="3"
                          placeholder="Write a note about this opportunity"></textarea>
                <br>
                <button class="btn btn-gold btn-small" type="submit" style="margin-top:4px;">
                    Save note
                </button>
            </form>

            {% if comments %}
                {% for c in comments %}
                    <div style="margin-bottom: 8px;">
                        <strong class="value-main">{{ c.author }}</strong>
                        <span class="muted">
                            {{ c.created_at }}
                            {% if c.pinned %} pinned{% endif %}
                            {% if c.is_ai %} AI{% endif %}
                        </span>
                        <p class="value-soft">{{ c.content|linebreaksbr }}</p>

                        <form method="post" style="display:inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="toggle_pin_comment">
                            <input type="hidden" name="comment_id" value="{{ c.id }}">
                            <button type="submit" class="btn btn-slate btn-small">
                                {% if c.pinned %}Unpin{% else %}Pin{% endif %}
                            </button>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <p class="muted">
                    No chatter notes yet.
                </p>
            {% endif %}
        </div>
    </div>

    <div class="section">
        <div class="section-title">Basic activity</div>
        <ul class="simple-list">
            <li>
                <span class="muted">Lead created</span>
                {{ lead.created_date }}
            </li>
            <li>
                <span class="muted">Opportunity created</span>
                {{ opportunity.created_date }}
            </li>
            <li>
                <span class="muted">Lead status</span>
                {{ lead.lead_status }}  |  Priority {{ lead.priority }}
            </li>
        </ul>
    </div>

</div>

<script>
(function () {
    function getCsrf() {
        const t = document.querySelector("#opp-ai-csrf input[name='csrfmiddlewaretoken']");
        return t ? t.value : "";
    }

    const statusBox = document.getElementById("opp-ai-status");
    const outBox = document.getElementById("opp-ai-output");
    const emailBody = document.getElementById("opp-ai-email-body");
    const emailBtn = document.getElementById("opp-ai-email-btn");
    const chatInput = document.getElementById("opp-ai-chat-input");
    const chatBtn = document.getElementById("opp-ai-chat-btn");
    const modeButtons = document.querySelectorAll("button[data-opp-mode]");

    function callOppAi(mode, extra) {
        statusBox.textContent = "AI is thinking";
        outBox.textContent = "";
        const body = {mode: mode};
        if (extra) {
            for (const k in extra) {
                body[k] = extra[k];
            }
        }

        fetch("{% url 'opportunity_ai_detail' opportunity.pk %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCsrf()
            },
            body: new URLSearchParams(body)
        })
        .then(function (res) { return res.json(); })
        .then(function (data) {
            if (data.ok) {
                outBox.textContent = data.text || "No answer from AI.";
                statusBox.textContent = "Saved as AI note";
            } else {
                outBox.textContent = data.error || "AI could not answer.";
                statusBox.textContent = "";
            }
        })
        .catch(function (err) {
            console.error(err);
            outBox.textContent = "Error talking to AI.";
            statusBox.textContent = "";
        });
    }

    modeButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
            const mode = btn.getAttribute("data-opp-mode");
            callOppAi(mode, {});
        });
    });

    if (emailBtn) {
        emailBtn.addEventListener("click", function () {
            const text = (emailBody.value || "").trim();
            callOppAi("email_followup", {email_body: text});
        });
    }

    if (chatBtn && chatInput) {
        chatBtn.addEventListener("click", function () {
            const q = (chatInput.value || "").trim();
            if (!q) return;
            callOppAi("chat", {user_text: q});
        });
    }

    function openNativeDatePicker(inputEl) {
        if (!inputEl) return;
        try {
            if (typeof inputEl.showPicker === "function") {
                inputEl.showPicker();
            } else {
                inputEl.focus();
                inputEl.click();
            }
        } catch (e) {
            inputEl.focus();
        }
    }

    const nextDate = document.getElementById("next-followup-date");
    const nextOpenBtn = document.getElementById("next-followup-open");

    if (nextDate) {
        nextDate.addEventListener("click", function () {
            openNativeDatePicker(nextDate);
        });
        nextDate.addEventListener("focus", function () {
            openNativeDatePicker(nextDate);
        });
    }

    if (nextOpenBtn && nextDate) {
        nextOpenBtn.addEventListener("click", function () {
            openNativeDatePicker(nextDate);
        });
    }

    const shipForm = document.getElementById("shipping-form");
    const shipInputs = document.querySelectorAll(".ship-input");
    const shipSaveBtn = document.getElementById("ship-save-btn");
    const shipEditBtn = document.getElementById("ship-edit-btn");
    const shipSavedPill = document.getElementById("ship-saved-pill");

    function hasShippingData() {
        let any = false;
        shipInputs.forEach(function (inp) {
            if ((inp.value || "").trim()) any = true;
        });
        return any;
    }

    function setShippingLocked(locked) {
        shipInputs.forEach(function (inp) {
            inp.readOnly = locked;
            if (locked) {
                inp.classList.add("input-locked");
            } else {
                inp.classList.remove("input-locked");
            }
        });

        if (shipSaveBtn) shipSaveBtn.style.display = locked ? "none" : "inline-flex";
        if (shipEditBtn) shipEditBtn.style.display = locked ? "inline-flex" : "none";
        if (shipSavedPill) shipSavedPill.style.display = locked && hasShippingData() ? "inline-flex" : "none";
    }

    if (shipEditBtn) {
        shipEditBtn.addEventListener("click", function () {
            setShippingLocked(false);
            if (shipSavedPill) shipSavedPill.style.display = "none";
        });
    }

    if (shipForm) {
        shipForm.addEventListener("submit", function () {
            if (shipSaveBtn) {
                shipSaveBtn.disabled = true;
                shipSaveBtn.textContent = "Saving";
            }
        });
    }

    setShippingLocked(hasShippingData());
})();
</script>

{% endblock %}