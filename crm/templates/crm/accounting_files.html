{% extends "crm/base.html" %}
{% load humanize %}
{% block content %}

<style>
  :root{
    --bg:#020617;
    --bg2:#030712;
    --line:#374151;
    --line2:#111827;
    --text:#f9fafb;
    --muted:#cbd5e1;
    --gold1:#f5d580;
    --gold2:#d4b35f;
  }

  .wrap{ max-width:1400px; margin:0 auto; color:var(--text); }
  .cardx{
    background:var(--bg);
    border:1px solid var(--line);
    border-radius:16px;
    overflow:hidden;
  }
  .pill{
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    padding:8px 14px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid var(--line);
    background:linear-gradient(145deg,#0f172a,var(--bg));
    color:var(--text);
    box-shadow:0 3px 0 #020617;
    white-space:nowrap;
  }
  .pill-gold{
    background:linear-gradient(145deg,var(--gold1),var(--gold2));
    color:#050505;
    border:1px solid #e5c670;
    box-shadow:0 3px 0 #8a6b24;
  }
  .inputx{
    background:var(--bg2) !important;
    border-color:#4b5563 !important;
    color:var(--text) !important;
    font-weight:800;
  }
  .inputx::placeholder{ color:#94a3b8; font-weight:800; }
  .muted{ color:var(--muted); font-weight:700; }
  .rowLine{ border-bottom:1px solid var(--line2); padding:10px 0; }
  .rowLine:last-child{ border-bottom:none; }
  .fileLine{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 0; }
  .fileName{ font-weight:800; color:#e5e7eb; font-size:12px; word-break:break-word; }
  .linkGold{ color:#ffe39b; font-weight:900; text-decoration:none; }
  .linkGold:hover{ text-decoration:underline; }
</style>

<div class="container-fluid">
  <div class="wrap">

    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
      <div>
        <h2 style="margin:0;font-weight:900;">Accounting files</h2>
        <div class="muted" style="font-size:12px;margin-top:4px;">
          All attachments based on your filters.
        </div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <a class="pill" href="{% url 'accounting_entry_list' %}">Back</a>
      </div>
    </div>

    <div class="cardx">
      <div class="card-body p-3">
        <form method="get" class="row g-2 align-items-end" style="font-weight:800;font-size:13px;">

          <div class="col-sm-2">
            <label class="form-label mb-1" style="font-weight:900;color:#fff;">Year</label>
            <input class="form-control form-control-sm inputx" name="year" value="{{ filter_year }}" placeholder="2025">
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1" style="font-weight:900;color:#fff;">Month</label>
            <input class="form-control form-control-sm inputx" name="month" value="{{ filter_month }}" placeholder="1 to 12">
          </div>

          <div class="col-sm-2">
            <label class="form-label mb-1" style="font-weight:900;color:#fff;">Side</label>
            <select class="form-select form-select-sm inputx" name="side">
              <option value="ALL" {% if filter_side == "ALL" or not filter_side %}selected{% endif %}>All</option>
              <option value="CA" {% if filter_side == "CA" %}selected{% endif %}>CA</option>
              <option value="BD" {% if filter_side == "BD" %}selected{% endif %}>BD</option>
            </select>
          </div>

          <div class="col-sm-4">
            <label class="form-label mb-1" style="font-weight:900;color:#fff;">Search</label>
            <input class="form-control form-control-sm inputx" name="q" value="{{ filter_q }}" placeholder="order, description, sub type">
          </div>

          <div class="col-sm-2">
            <button class="pill pill-gold w-100" type="submit" style="justify-content:center;">
              Apply
            </button>
          </div>

        </form>
      </div>
    </div>

    <div class="cardx mt-3">
      <div class="card-header py-2" style="border-bottom:1px solid var(--line2);">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div style="font-weight:900;">Files</div>
          <div class="muted" style="font-size:12px;">
            Showing
            {% if files %}{{ files|length }}{% elif entries %}{{ entries|length }}{% else %}0{% endif %}
            records
          </div>
        </div>
      </div>

      <div class="card-body p-3">

        {% with rows=files|default:entries %}
          {% if rows %}
            {% for e in rows %}
              {% if e.attachments.exists %}
                <div class="rowLine">
                  <div style="font-weight:900;">
                    {{ e.date|date:"Y-m-d" }} |
                    {{ e.side }} |
                    {{ e.main_type }}{% if e.sub_type %} | {{ e.sub_type }}{% endif %}
                    {% if e.production_order %} | {{ e.production_order.order_code }}{% endif %}
                  </div>

                  {% if e.description %}
                    <div class="muted" style="font-size:12px;margin-top:4px;">
                      {{ e.description }}
                    </div>
                  {% endif %}

                  <div style="margin-top:8px;">
                    {% for a in e.attachments.all %}
                      <div class="fileLine">
                        <div class="fileName">{{ a.original_name|default:"File" }}</div>
                        <div class="nowrap">
                          <a class="linkGold" href="{{ a.file.url }}" target="_blank" rel="noopener">Open</a>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% else %}
            <div class="muted" style="font-weight:800;">No entries found.</div>
          {% endif %}
        {% endwith %}

      </div>
    </div>

  </div>
</div>

{% endblock %}