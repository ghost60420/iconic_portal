{% extends "crm/base.html" %}
{% block content %}

<style>
  .cust-detail-page {
    max-width: 1200px;
    margin: 24px auto 40px auto;
    padding: 0 12px 20px 12px;
    color: #f9fafb;
  }

  .cust-header {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 14px;
  }

  .cust-title {
    font-size: 22px;
    font-weight: 700;
    color: #fef9c3;
  }

  .cust-sub {
    font-size: 12px;
    color: #cbd5f5;
  }

  .cust-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 6px;
  }

  .cust-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: flex-end;
  }

  .btn {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid transparent;
    font-size: 12px;
    text-decoration: none;
    white-space: nowrap;
  }

  .btn-gold {
    background: linear-gradient(135deg, #facc15, #f97316);
    color: #111827;
    border-color: #fbbf24;
    font-weight: 600;
  }

  .btn-slate {
    background: #020617;
    color: #e5e7eb;
    border-color: #374151;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
    margin-bottom: 14px;
  }

  .summary-card {
    background: radial-gradient(circle at top left, #111827, #020617);
    border: 1px solid #1f2937;
    border-radius: 12px;
    padding: 10px 12px;
  }

  .summary-title {
    font-size: 11px;
    color: #facc15;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .summary-value {
    font-size: 16px;
    font-weight: 700;
    color: #f9fafb;
  }

  .summary-sub {
    font-size: 11px;
    color: #9ca3af;
  }

  .cust-grid {
    display: grid;
    grid-template-columns: 1.3fr 0.9fr;
    gap: 14px;
  }

  .card {
    background: radial-gradient(circle at top left, #111827, #020617);
    border: 1px solid #1f2937;
    border-radius: 14px;
    padding: 12px 14px;
    margin-bottom: 12px;
  }

  .card-title {
    font-size: 14px;
    font-weight: 600;
    color: #fefce8;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 6px 14px;
  }

  .info-label {
    font-size: 10px;
    color: #c7b36b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .info-value {
    font-size: 12px;
    color: #f9fafb;
  }

  .table-small {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .table-small th,
  .table-small td {
    border-bottom: 1px solid #1f2937;
    padding: 6px 4px;
    text-align: left;
  }

  .table-small th {
    color: #cbd5f5;
    font-size: 11px;
  }

  .table-small tbody tr {
    transition: background 0.12s ease;
  }

  .table-small tbody tr.clickable-row {
    cursor: pointer;
  }

  .table-small tbody tr.clickable-row:hover {
    background: rgba(30, 41, 59, 0.55);
  }

  .pill {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid #374151;
    font-size: 11px;
    color: #e5e7eb;
    background: #020617;
  }

  .muted {
    color: #9ca3af;
  }

  .notes-box {
    background: #020617;
    border: 1px solid #1f2937;
    border-radius: 10px;
    padding: 8px;
    font-size: 12px;
    white-space: pre-wrap;
  }

  .note-item {
    padding: 8px 0;
    border-bottom: 1px solid #1f2937;
  }

  .note-item:last-child {
    border-bottom: none;
  }

  .ai-output-box,
  .ai-chat-log,
  .ai-email-box,
  .ai-custom-box {
    background: #020617;
    border-radius: 8px;
    border: 1px solid #1f2937;
    padding: 8px;
    font-size: 12px;
  }

  .ai-chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
  }

  .ai-chip {
    background: #020617;
    color: #f5d580;
    border: 1px solid #4b5563;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    cursor: pointer;
  }

  .ai-chip:hover {
    background: #111827;
  }

  .ai-status {
    font-size: 11px;
    color: #9ca3af;
    margin-top: 4px;
  }

  @media (max-width: 980px) {
    .cust-grid {
      grid-template-columns: 1fr;
    }
    .summary-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (max-width: 680px) {
    .summary-grid {
      grid-template-columns: 1fr;
    }
    .info-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="cust-detail-page">
  <div class="cust-header">
    <div>
      <div class="cust-title">
        {{ customer.account_brand|default:customer.contact_name|default:"Customer" }}
        <span class="muted" style="font-size:12px;">[{{ customer.customer_code }}]</span>
      </div>
      <div class="cust-sub">
        {{ customer.contact_name|default:"" }} - {{ customer.email|default:"" }} - {{ customer.phone|default:"" }}
      </div>
      <div class="cust-badges">
        <span class="pill">Active opps {{ active_opps|length }}</span>
        <span class="pill">In production {{ production_active|length }}</span>
        <span class="pill">Completed {{ production_completed|length }}</span>
      </div>
    </div>
    <div class="cust-actions">
      <a href="{% url 'customers_list' %}" class="btn btn-slate">Back to customers</a>
      <a href="{% url 'add_opportunity' %}?customer={{ customer.id }}" class="btn btn-gold">Add opportunity</a>
      <a href="#customer-notes" class="btn btn-slate">Add note</a>
      <a href="/admin/crm/customer/{{ customer.id }}/change/" class="btn btn-slate">Edit customer</a>
    </div>
  </div>

  <div class="summary-grid">
    <div class="summary-card">
      <div class="summary-title">Total opportunities</div>
      <div class="summary-value">{{ opportunities|length }}</div>
      <div class="summary-sub">Active {{ active_opps|length }}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Production</div>
      <div class="summary-value">{{ production_active|length }}</div>
      <div class="summary-sub">Completed {{ production_completed|length }}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Revenue</div>
      <div class="summary-value">{{ total_revenue }}</div>
      <div class="summary-sub">
        {% if profit_estimate != None %}
          Profit est. {{ profit_estimate|floatformat:2 }} ({{ profit_margin|floatformat:1 }}%)
        {% else %}
          Profit data not available
        {% endif %}
      </div>
    </div>
  </div>

  <div class="cust-grid">
    <div>
      <div class="card">
        <div class="card-title">üìá Overview</div>
        <div class="info-grid">
          <div>
            <div class="info-label">Company</div>
            <div class="info-value">{{ customer.account_brand|default:"‚Äî" }}</div>
          </div>
          <div>
            <div class="info-label">Contact</div>
            <div class="info-value">{{ customer.contact_name|default:"‚Äî" }}</div>
          </div>
          <div>
            <div class="info-label">Website</div>
            <div class="info-value">{{ customer.website|default:"‚Äî" }}</div>
          </div>
          <div>
            <div class="info-label">Industry</div>
            <div class="info-value">{{ customer.industry|default:"‚Äî" }}</div>
          </div>
          <div>
            <div class="info-label">Market</div>
            <div class="info-value">{{ customer.market|default:"‚Äî" }}</div>
          </div>
          <div>
            <div class="info-label">Created</div>
            <div class="info-value">{{ customer.created_date|date:"Y-m-d" }}</div>
          </div>
          <div>
            <div class="info-label">Address</div>
            <div class="info-value">
              {{ customer.address_line1|default:customer.shipping_address1|default:"" }}
              {{ customer.address_line2|default:customer.shipping_address2|default:"" }}
              {{ customer.city|default:customer.shipping_city|default:"" }}
              {{ customer.state|default:customer.shipping_state|default:"" }}
              {{ customer.postal_code|default:customer.shipping_postcode|default:"" }}
              {{ customer.country|default:customer.shipping_country|default:"" }}
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üéØ Opportunities</div>
        {% if opportunities %}
          <table class="table-small">
            <thead>
              <tr>
                <th>Opportunity</th>
                <th>Stage</th>
                <th>Value</th>
                <th>Margin</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              {% for opp in opportunities %}
                <tr class="clickable-row" data-href="{% url 'opportunity_detail' opp.pk %}?customer={{ customer.id }}">
                  <td>
                    <a href="{% url 'opportunity_detail' opp.pk %}?customer={{ customer.id }}">{{ opp.opportunity_id }}</a>
                  </td>
                  <td>{{ opp.stage }}</td>
                  <td>{% if opp.order_value %}{{ opp.order_value }}{% else %}‚Äî{% endif %}</td>
                  <td>
                    {% if opp.profit_margin_pct != None %}
                      {{ opp.profit_margin_pct|floatformat:1 }}%
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>
                  <td>{{ opp.updated_at|date:"Y-m-d" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <div class="muted" style="margin-bottom:8px;">No opportunities yet.</div>
          <a href="{% url 'add_opportunity' %}?customer={{ customer.id }}" class="btn btn-gold">Create opportunity</a>
        {% endif %}
      </div>

      <div class="card">
        <div class="card-title">üè≠ Production</div>
        {% if production_active %}
          <div class="muted" style="margin-bottom:6px;">In production</div>
          <table class="table-small" style="margin-bottom:10px;">
            <thead>
              <tr>
                <th>Order</th>
                <th>Status</th>
                <th>Due</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              {% for order in production_active %}
                <tr class="clickable-row" data-href="{% url 'production_detail' order.pk %}">
                  <td>
                    <a href="{% url 'production_detail' order.pk %}">{{ order.order_code|default:order.title }}</a>
                  </td>
                  <td><span class="pill">{{ order.get_status_display }}</span></td>
                  <td>{{ order.bulk_deadline|date:"Y-m-d"|default:"‚Äî" }}</td>
                  <td>{{ order.updated_at|date:"Y-m-d" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}

        {% if production_completed %}
          <div class="muted" style="margin-bottom:6px;">Completed</div>
          <table class="table-small">
            <thead>
              <tr>
                <th>Order</th>
                <th>Status</th>
                <th>Completed</th>
              </tr>
            </thead>
            <tbody>
              {% for order in production_completed %}
                <tr class="clickable-row" data-href="{% url 'production_detail' order.pk %}">
                  <td>
                    <a href="{% url 'production_detail' order.pk %}">{{ order.order_code|default:order.title }}</a>
                  </td>
                  <td><span class="pill">{{ order.get_status_display }}</span></td>
                  <td>{{ order.updated_at|date:"Y-m-d" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}

        {% if not production_active and not production_completed %}
          <div class="muted">No production orders yet.</div>
        {% endif %}
      </div>
    </div>

    <div>
      <div class="card" id="customer-notes">
        <div class="card-title">üìù Notes & communications</div>
        <div class="notes-box" style="margin-bottom:10px;">
          {% if customer.notes %}
            {{ customer.notes }}
          {% else %}
            <span class="muted">No account notes yet.</span>
          {% endif %}
        </div>

        {% if notes_list %}
          {% for note in notes_list %}
            <div class="note-item">
              <div style="font-size:11px; color:#facc15;">{{ note.author|default:"User" }} ¬∑ {{ note.created_at|date:"Y-m-d H:i" }}</div>
              <div>{{ note.content }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted">No quick notes yet.</div>
        {% endif %}

        <form method="post" style="margin-top:10px;">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_note">
          <textarea name="note_content" rows="3" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Add a quick note"></textarea>
          <button type="submit" class="btn btn-gold" style="margin-top:6px;">Save note</button>
        </form>
      </div>

      <div class="card">
        <div class="card-title">üß≠ Timeline</div>
        {% if events %}
          {% for e in events %}
            <div class="note-item">
              <div style="font-size:11px; color:#facc15;">{{ e.created_at|date:"Y-m-d H:i" }}</div>
              <div style="font-weight:600;">{{ e.title }}</div>
              <div class="muted">{{ e.details }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted">No timeline events yet.</div>
        {% endif %}
      </div>

      <div class="card">
        <div class="card-title">ü§ñ AI assistant</div>
        <div class="muted" style="margin-bottom:6px;">
          Use AI to summarize, suggest follow-up, and draft emails.
        </div>

        <div class="ai-chip-row">
          <div class="ai-chip" data-mode="overview">Analyze customer</div>
          <div class="ai-chip" data-mode="followup">Suggest follow up</div>
          <div class="ai-chip" data-mode="order_size">Predict order size</div>
          <div class="ai-chip" data-mode="product_ideas">Recommend products</div>
          <div class="ai-chip" data-mode="risk_score">Risk and potential</div>
          <div class="ai-chip" data-mode="full_summary">Full summary</div>
        </div>

        <div class="ai-output-box" id="ai-output">AI answer will appear here.</div>
        <div class="ai-status" id="ai-status">Ready</div>
        <div class="ai-chat-log" id="ai-chat-log" style="max-height:160px; overflow-y:auto; margin-top:8px;">
          <div class="muted">AI reply history will show here.</div>
        </div>

        <div class="ai-email-box" style="margin-top:10px;">
          <label for="ai-email-purpose" style="font-size:11px; color:#c7b36b;">Email purpose</label>
          <input id="ai-email-purpose" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Example follow up after sample sent">

          <label for="ai-email-tone" style="font-size:11px; color:#c7b36b; margin-top:6px;">Email tone</label>
          <select id="ai-email-tone" class="form-select form-select-sm bg-dark text-light border-secondary">
            <option value="">Friendly</option>
            <option value="very friendly and warm">Very friendly</option>
            <option value="short and direct">Short and direct</option>
            <option value="formal and professional">Formal</option>
          </select>

          <button type="button" class="btn btn-slate" id="ai-email-btn" style="margin-top:6px;">AI write email</button>
        </div>

        <div class="ai-custom-box" style="margin-top:10px;">
          <label for="ai-custom-question" style="font-size:11px; color:#c7b36b;">Custom question</label>
          <input id="ai-custom-question" type="text" class="form-control form-control-sm bg-dark text-light border-secondary" placeholder="Example: How can we upsell this client?">
          <button type="button" class="btn btn-slate" id="ai-custom-btn" style="margin-top:6px;">Ask</button>
        </div>

        <form id="customer-ai-csrf" style="display:none;">
          {% csrf_token %}
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  function wireRowClicks() {
    const rows = document.querySelectorAll(".clickable-row[data-href]");
    rows.forEach(function (row) {
      row.addEventListener("click", function (event) {
        if (event.target.closest("a, button, input, select, textarea")) {
          return;
        }
        const href = row.getAttribute("data-href");
        if (href) {
          window.location.href = href;
        }
      });
    });
  }

  wireRowClicks();

  function getCsrf() {
    const token = document.querySelector("#customer-ai-csrf input[name='csrfmiddlewaretoken']");
    return token ? token.value : "";
  }

  const outBox = document.getElementById("ai-output");
  const statusBox = document.getElementById("ai-status");
  const chatLog = document.getElementById("ai-chat-log");

  const chips = document.querySelectorAll(".ai-chip");
  const emailBtn = document.getElementById("ai-email-btn");
  const emailPurposeInput = document.getElementById("ai-email-purpose");
  const emailToneSelect = document.getElementById("ai-email-tone");

  const customBtn = document.getElementById("ai-custom-btn");
  const customInput = document.getElementById("ai-custom-question");

  function appendChat(role, text) {
    const div = document.createElement("div");
    div.className = "note-item";
    div.innerHTML = "<strong>" + role + "</strong>: " + (text || "");
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function callCustomerAi(mode, extra) {
    statusBox.textContent = "AI is thinking";
    outBox.textContent = "";
    extra = extra || {};

    const body = {mode: mode};
    for (const k in extra) {
      body[k] = extra[k];
    }

    fetch("{% url 'customer_ai_detail' customer.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCsrf()
      },
      body: new URLSearchParams(body)
    })
    .then(function (res) { return res.json(); })
    .then(function (data) {
      if (data.ok) {
        outBox.textContent = data.text || "No answer from AI.";
        statusBox.textContent = "Saved to notes";
        appendChat("AI", data.text || "");
      } else {
        outBox.textContent = data.error || "AI could not answer.";
        statusBox.textContent = "";
      }
    })
    .catch(function () {
      outBox.textContent = "Error talking to AI.";
      statusBox.textContent = "";
    });
  }

  chips.forEach(function (chip) {
    chip.addEventListener("click", function () {
      const mode = chip.getAttribute("data-mode");
      callCustomerAi(mode, {});
    });
  });

  if (emailBtn) {
    emailBtn.addEventListener("click", function () {
      const purpose = emailPurposeInput.value.trim();
      const tone = emailToneSelect.value.trim();

      appendChat("You", "Write email. Purpose " + (purpose || "follow up") + ". Tone " + (tone || "friendly"));

      callCustomerAi("email_followup", {
        email_purpose: purpose,
        email_tone: tone
      });
    });
  }

  if (customBtn) {
    customBtn.addEventListener("click", function () {
      const q = customInput.value.trim();
      if (!q) {
        return;
      }
      appendChat("You", q);
      customInput.value = "";
      callCustomerAi("custom", {question: q});
    });
  }
})();
</script>

{% endblock %}
